{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/git-protocol-pack-push/","result":{"data":{"asciidoc":{"id":"a43e2e42-c0f6-5f9f-9fea-6a70fe7cdc0e","html":"<div class=\"sect1\">\n<h2 id=\"_git_协议启动\">Git 协议，启动</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><a href=\"/posts/git-daemon/\">先启动 git daemon 服务</a>。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 将协议版本设置为 1\ngit config --global protocol.version 1\n# git 日志保存到文件\nexport GIT_TRACE=$PWD/git-trace.log\nexport GIT_TRACE_PACKET=$PWD/git-trace-pack.log</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>日志信息：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">C: git-receive-pack /project.git\\0host=127.0.0.1\\0\\0version=1\\0\nS: version 1</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>命令行模拟：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">echo -e -n \\\n    \"003cgit-receive-pack /project.git\\0host=127.0.0.1\\0\\0version=1\\0\" |\n    nc -v 127.0.0.1 9418</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_推送\">推送</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>服务端调用 <code>receive-pack</code>，客户端调用 <code>send-pack</code>。</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_初次推送\">初次推送</h3>\n<div class=\"paragraph\">\n<p>客户端 reference 信息如下：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ git for-each-ref\n9f114f880890b39b0f862a05fd7f9ffa1283ec32 commit\trefs/heads/branch_2\nc4896697e257d5915e9a8f6f3460cab36ff8df9a commit\trefs/heads/main\nf5e9cea1914d420b24718a9a4336cf110836e8f0 commit\trefs/pull/8/head\n89c2910934c685b60d95532ccb48186c0ddbc6b0 commit\trefs/tags/v4.0\n94948ac8c40fc3f234a06595b3c5b4c70c4f43e0 tag\trefs/tags/v6.0</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>推送所有 refs：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git push origin --mirror --quiet</code></pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_reference_发现\">reference 发现</h4>\n<div class=\"paragraph\">\n<p>服务端会发送 reference 列表，但列表为空。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">S: 0000000000000000000000000000000000000000 capabilities^{}\\0report-status report-status-v2 delete-refs side-band-64k quiet atomic ofs-delta object-format=sha1 agent=git/2.39.1\nS: 0000</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_reference_更新请求以及_packfile_传输\">reference 更新请求以及 Packfile 传输</h4>\n<div class=\"paragraph\">\n<p>客户端发送 reference 更新请求，之后传输 Packfile：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">C: 0000000000000000000000000000000000000000 9f114f880890b39b0f862a05fd7f9ffa1283ec32 refs/heads/branch_2\\0 report-status-v2 side-band-64k quiet object-format=sha1 agent=git/2.39.1\nC: 0000000000000000000000000000000000000000 c4896697e257d5915e9a8f6f3460cab36ff8df9a refs/heads/main\nC: 0000000000000000000000000000000000000000 f5e9cea1914d420b24718a9a4336cf110836e8f0 refs/pull/8/head\nC: 0000000000000000000000000000000000000000 89c2910934c685b60d95532ccb48186c0ddbc6b0 refs/tags/v4.0\nC: 0000000000000000000000000000000000000000 94948ac8c40fc3f234a06595b3c5b4c70c4f43e0 refs/tags/v6.0\nC: 0000\nC: [PACK]</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_报告状态\">报告状态</h4>\n<div class=\"paragraph\">\n<p>服务端报告状态：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\"># 标准输出\nS: \\1\nS: unpack ok\nS: ok refs/heads/branch_2\nS: ok refs/heads/main\nS: ok refs/pull/8/head\nS: ok refs/tags/v4.0\nS: ok refs/tags/v6.0\nS: 0000\n\n# 报告状态\nS: unpack ok\nS: 0000\nS: ok refs/heads/branch_2\nS: ok refs/heads/main\nS: ok refs/pull/8/head\nS: ok refs/tags/v4.0\nS: ok refs/tags/v6.0\nS: 0000</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_增量\">增量</h3>\n<div class=\"paragraph\">\n<p>客户端数据如下：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ git log main --pretty=oneline | xsel -b\n29901d7a4f8f4ae76920821d402de3e8dd151954 11:9 # 新增, 3 个对象，其中 tree blob 与 9 相同\n4eabd069067bc5de6fb281d792a6c10c4233475b 10   # 新增, 3 个对象都不同\nc4896697e257d5915e9a8f6f3460cab36ff8df9a 9\nf5e9cea1914d420b24718a9a4336cf110836e8f0 8\nfa679bfd70ac31dcb5862f9403ec4150d81b3d03 7\n2f36731ec8d8b0e53fcfccd2cad413976aa47b69 6\n9a533393b7342f34ceb497a1364d3bd84f54ce38 5\n89c2910934c685b60d95532ccb48186c0ddbc6b0 4\nf214f2bd153cdb1026183949d8cae10ed4470550 3\n9f114f880890b39b0f862a05fd7f9ffa1283ec32 2\ne40f1fece8708ed906683b13ecae19f57ae3660e 1</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>更新 main 分支：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git push origin main --quiet</code></pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_reference_发现_2\">reference 发现</h4>\n<div class=\"paragraph\">\n<p>服务端会发送 reference 列表。</p>\n</div>\n<div class=\"paragraph\">\n<p>日志信息，tag 显示时与 fetch 有所区别：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">S: 9f114f880890b39b0f862a05fd7f9ffa1283ec32 refs/heads/branch_2\\0report-status report-status-v2 delete-refs side-band-64k quiet atomic ofs-delta object-format=sha1 agent=git/2.39.1\nS: c4896697e257d5915e9a8f6f3460cab36ff8df9a refs/heads/main\nS: f5e9cea1914d420b24718a9a4336cf110836e8f0 refs/pull/8/head\nS: 89c2910934c685b60d95532ccb48186c0ddbc6b0 refs/tags/v4.0\nS: 94948ac8c40fc3f234a06595b3c5b4c70c4f43e0 refs/tags/v6.0\nS: 0000</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_reference_更新请求以及_packfile_传输_2\">reference 更新请求以及 Packfile 传输</h4>\n<div class=\"paragraph\">\n<p>客户端发送 reference 更新请求以及 Packfile 传输。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">C: c4896697e257d5915e9a8f6f3460cab36ff8df9a 29901d7a4f8f4ae76920821d402de3e8dd151954 refs/heads/main\\0 report-status-v2 side-band-64k quiet object-format=sha1 agent=git/2.39.1\nC: 0000\nC: [PACK]</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_报告状态_2\">报告状态</h3>\n<div class=\"paragraph\">\n<p>服务端报告状态。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\"># 标准输出\nS: \\1\nS: unpack ok\nS: ok refs/heads/main\nS: 0000\n\n# 报告状态\nS: unpack ok\nS: 0000\nS: ok refs/heads/main\nS: 0000</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>","document":{"title":"Git 协议 v1：push"},"pageAttributes":{"slug":"git-protocol-pack-push","category":"git"},"revision":{"date":"2023-01-28","number":"1.0"}}},"pageContext":{"id":"a43e2e42-c0f6-5f9f-9fea-6a70fe7cdc0e","pageAttributes__slug":"git-protocol-pack-push","__params":{"pageAttributes__slug":"git-protocol-pack-push"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}