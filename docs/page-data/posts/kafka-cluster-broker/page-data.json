{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/kafka-cluster-broker/","result":{"data":{"asciidoc":{"id":"d5bb02f0-0b1b-545a-80a0-e6ea56ca9ca1","html":"<div class=\"sect1\">\n<h2 id=\"_环境准备\">环境准备</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>集群存在 3 个节点，参考 <a href=\"/posts/kafka-cluster-start\">kafka 基本使用 (KRaft，集群)</a>。</p>\n</div>\n<div class=\"paragraph\">\n<p>创建新的主题用来测试迁移：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export kafka01:9092\nexport topic=foo1\n# 创建 1 分区 1 副本的主题\nbin/kafka-topics.sh --bootstrap-server $broker --create --topic $topic --partitions 1 --replication-factor 1\n# 查看主题详情\nbin/kafka-topics.sh --bootstrap-server $broker --describe --topic $topic\n# 输出：\n#\tTopic: foo1\tPartition: 0\tLeader: 1\tReplicas: 1\tIsr: 1</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_添加_brokerkraft\">添加 broker(KRaft)</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>添加一个新 broker 节点：</p>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<colgroup>\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">name</th>\n<th class=\"tableblock halign-left valign-top\">IP</th>\n<th class=\"tableblock halign-left valign-top\">hostname</th>\n<th class=\"tableblock halign-left valign-top\">volume</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">kafka04</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">172.18.1.4</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">kafka04</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">/opt/kafka04</p></td>\n</tr>\n</tbody>\n</table>\n<div class=\"paragraph\">\n<p>节点仅作为 broker，因此修改文件 <code>.config/kraft/broker.properties</code>：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 备份\ncp config/kraft/broker.properties config/kraft/broker.properties.bak\n# 修改配置\nsed -e \"s/^node.id=.*/node.id=4/\" \\\n    -e \"s/^controller.quorum.voters=.*/controller.quorum.voters=1@kafka01:9093,2@kafka02:9093,3@kafka03:9093/\" \\\n    -e \"s/localhost/kafka04/\" \\\n    -e \"s/^log.dirs=.*/log.dirs=\\/opt\\/kafka\\/kraft-combined-logs/\" \\\n    -e \"s/^offsets.topic.replication.factor=.*/offsets.topic.replication.factor=3/\" \\\n    -e \"s/^transaction.state.log.replication.factor=.*/transaction.state.log.replication.factor=3/\" \\\n    -e \"s/^transaction.state.log.min.isr=.*/transaction.state.log.min.isr=2/\" \\\n    config/kraft/broker.properties.bak | tee config/kraft/broker.properties\n# 通过 diff 检查变更\ndiff -u config/kraft/broker.properties.bak config/kraft/broker.properties\n# 或者通过 vimdiff 检查变更\nvimdiff config/kraft/broker.properties.bak config/kraft/broker.properties</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>在容器内初始化 kafka 并启动服务：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 创建容器\ndocker run \\\n   --detach \\\n   --interactive \\\n   --tty \\\n   --network=kafka \\\n   --ip=172.18.1.4 \\\n   --name=kafka04 \\\n   --hostname=kafka04 \\\n   --volume /opt/kafka04:/opt/kafka \\\n    openjdk:17\n\n# 集群 ID 与另外三个节点一致\nexport KAFKA_CLUSTER_ID=8Jqq_Wm6SGGwuTLGTcu5NA\n# 使用集群 ID 格式化日志目录\nbin/kafka-storage.sh format -t $KAFKA_CLUSTER_ID -c config/kraft/broker.properties\n# 启动 kafka 服务\nbin/kafka-server-start.sh -daemon config/kraft/broker.properties</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>查看 broker 列表：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export broker=kafka04:9092\nbin/kafka-broker-api-versions.sh --bootstrap-server $broker | awk '/id/{print $1}'</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>当创建新的主题时，节点就会投入使用。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_迁移数据到新节点\">迁移数据到新节点</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>将旧的主题 foo1 从节点 1 迁移到新的节点 4。</p>\n</div>\n<div class=\"paragraph\">\n<p>通过文件 <code>topics-to-move.json</code> 传递参数：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">topics-to-move.json</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-json\" data-lang=\"json\">{\n  \"version\":1,\n  \"topics\": [\n    {\"topic\": \"foo1\"}\n  ]\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>准备迁移的主题</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>生成配置文件：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">bin/kafka-reassign-partitions.sh --bootstrap-server $broker --topics-to-move-json-file topics-to-move.json --broker-list \"4\" --generate\n# 输出：\n# Current partition replica assignment\n# {\"version\":1,\"partitions\":[{\"topic\":\"foo1\",\"partition\":0,\"replicas\":[1],\"log_dirs\":[\"any\"]}]}\n#\n# Proposed partition reassignment configuration\n# {\"version\":1,\"partitions\":[{\"topic\":\"foo1\",\"partition\":0,\"replicas\":[4],\"log_dirs\":[\"any\"]}]}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>--broker-list</code> 新节点列表，逗号分隔</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>新建文件 <code>expand-cluster-reassignment.json</code>，保存刚才的输出配置：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">expand-cluster-reassignment.json</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-json\" data-lang=\"json\">{\"version\":1,\"partitions\":[{\"topic\":\"foo1\",\"partition\":0,\"replicas\":[4],\"log_dirs\":[\"any\"]}]}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>主题 foo1 保存在节点 4 上</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 执行迁移\nbin/kafka-reassign-partitions.sh --bootstrap-server $broker --reassignment-json-file expand-cluster-reassignment.json --execute\n# 验证迁移\nbin/kafka-reassign-partitions.sh --bootstrap-server $broker --reassignment-json-file expand-cluster-reassignment.json --verify\n# 查看主题详情\nbin/kafka-topics.sh --bootstrap-server $broker --describe --topic $topic\n# 输出\n# \tTopic: foo1\tPartition: 0\tLeader: 4\tReplicas: 4\tIsr: 4</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://kafka.apache.org/documentation/#basic_ops_cluster_expansion\" class=\"bare\">https://kafka.apache.org/documentation/#basic_ops_cluster_expansion</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Kafka 集群添加 broker (KRaft)"},"pageAttributes":{"slug":"kafka-cluster-broker","category":"kafka"},"revision":{"date":"2023-01-05","number":"1.0"}}},"pageContext":{"id":"d5bb02f0-0b1b-545a-80a0-e6ea56ca9ca1","pageAttributes__slug":"kafka-cluster-broker","__params":{"pageAttributes__slug":"kafka-cluster-broker"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}