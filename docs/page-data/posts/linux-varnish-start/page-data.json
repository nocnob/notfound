{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/linux-varnish-start/","result":{"data":{"asciidoc":{"id":"94a2a67f-4a01-5093-9fe5-6b928f03933c","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>环境 Ubuntu 20.04</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>varnish 6.0.x 为长期支持版，而系统自带的版本 6.2.x 并非长期支持版，详情可查看https://varnish-cache.org/releases/[发行说明]。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_安装_varnish_6_0_x_lts\"><a class=\"anchor\" href=\"#_安装_varnish_6_0_x_lts\"></a>安装 varnish 6.0.x LTS</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>官方通过 packagecloud 维护 varnish 安装包。</p>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>添加公钥：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">curl -s -L https://packagecloud.io/varnishcache/varnish60lts/gpgkey | sudo apt-key add -</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>添加源，并提升源的优先级：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">. /etc/os-release\nsudo tee /etc/apt/sources.list.d/varnishcache_varnish60lts.list &gt; /dev/null &lt;&lt;-EOF\ndeb https://packagecloud.io/varnishcache/varnish60lts/$ID/ $VERSION_CODENAME main\nEOF\nsudo tee /etc/apt/preferences.d/varnishcache &gt; /dev/null &lt;&lt;-EOF\nPackage: varnish varnish-*\nPin: release o=packagecloud.io/varnishcache/*\nPin-Priority: 1000\nEOF</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>安装</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo apt update\nsudo apt install varnish\n# 检查版本\nvarnishd -V</code></pre>\n</div>\n</div>\n</li>\n</ol>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_启动\"><a class=\"anchor\" href=\"#_启动\"></a>启动</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>varnishd 通过 systemd 管理。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo systemctl status varnish.service\nsudo systemctl start varnish.service\nsudo systemctl reload varnish.service\nsudo systemctl restart varnish.service\nsudo systemctl stop varnish.service</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_配置\"><a class=\"anchor\" href=\"#_配置\"></a>配置</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 修改默认编辑器\nsudo update-alternatives --config editor\n# 编辑 systemd 配置文件\nsudo systemctl edit --full varnish\n# 修改配置后重启\nsudo systemctl restart varnish.service</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>通过 systemd 配置文件可修改端口、缓存大小</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>编辑文件 <code>/etc/varnish/default.vcl</code>：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-vcl\" data-lang=\"vcl\">backend default {\n    .host = \"127.0.0.1\";\n    .port = \"8080\";\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>可修改后端服务</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_测试\"><a class=\"anchor\" href=\"#_测试\"></a>测试</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">$ curl -I http://localhost:6081\n# HTTP/1.1 503 Backend fetch failed\n# Date: Thu, 17 Feb 2022 03:50:14 GMT\n# Server: Varnish\n# Content-Type: text/html; charset=utf-8\n# Retry-After: 5\n# X-Varnish: 17\n# Age: 0\n# Via: 1.1 varnish (Varnish/6.0)\n# Content-Length: 279\n# Connection: keep-alive</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://www.varnish-software.com/developers/tutorials/installing-varnish-ubuntu/\" class=\"bare\">https://www.varnish-software.com/developers/tutorials/installing-varnish-ubuntu/</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Ubuntu 安装 varnish LTS"},"pageAttributes":{"slug":"linux-varnish-start","category":"varnish"},"revision":{"date":"2022-02-16","number":"1.0"}}},"pageContext":{"id":"94a2a67f-4a01-5093-9fe5-6b928f03933c","pageAttributes__slug":"linux-varnish-start","__params":{"pageAttributes__slug":"linux-varnish-start"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}