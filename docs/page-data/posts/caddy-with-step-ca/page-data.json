{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/caddy-with-step-ca/","result":{"data":{"asciidoc":{"id":"b7c8553f-d474-5f77-88f0-3a7dda62c8ce","html":"<div class=\"sect1\">\n<h2 id=\"_step_cli_和_step_ca\">step-cli 和 step-ca</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>安装 step-cli 和 step-ca：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">wget https://dl.step.sm/gh-release/cli/gh-release-header/v0.23.4/step-cli_0.23.4_amd64.deb\nsudo dpkg -i step-cli_0.23.4_amd64.deb\nstep version\n\nwget https://dl.step.sm/gh-release/certificates/gh-release-header/v0.23.2/step-ca_0.23.2_amd64.deb\nsudo dpkg -i step-ca_0.23.2_amd64.deb\nstep-ca version</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>初始化证书颁发机构：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">step ca init\n# ✔ Deployment Type: Standalone\n# What would you like to name your new PKI?\n# ✔ (e.g. Smallstep): demo\n# What DNS names or IP addresses will clients use to reach your CA?\n# ✔ (e.g. ca.example.com[,10.1.2.3,etc.]): ca.demo.com\n# What IP and port will your new CA bind to? (:443 will bind to 0.0.0.0:443)\n# ✔ (e.g. :443 or 127.0.0.1:443): 0.0.0.0:8443\n# What would you like to name the CA's first provisioner?\n# ✔ (e.g. you@smallstep.com): ca@demo.com\n# Choose a password for your CA keys and first provisioner.</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>启动服务：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">step-ca $(step path)/config/ca.json</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>可通过 <code><a href=\"https://ca.demo.com:8443\" class=\"bare\">https://ca.demo.com:8443</a></code> 访问服务</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>将根证书添加到系统以及浏览器中：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">step certificate install $(step path)/certs/root_ca.crt\nstep certificate install --firefox $(step path)/certs/root_ca.crt\n# 验证\ncurl -v https://ca.demo.com:8443</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>证书会被添加到 <code>/etc/ssl/certs</code> 以及 <code>$HOME/.pki/nssdb</code> 中</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>开启 ACME 支持：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">step ca provisioner add acme --type ACME</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>修改完成后，需要重启 step-ca</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>测试通过 ACME 方式申请证书：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo -E step ca certificate demo.com demo.com.crt demo.com.key --provisioner acme\n# 查看证书信息\nopenssl x509 -in demo.com.crt -text -noout</code></pre>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_systemd\">systemd</h3>\n<div class=\"paragraph\">\n<p>可通过环境变量修改 step path：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export STEPPATH=/etc/step-ca</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://smallstep.com/docs/step-ca/certificate-authority-server-production#running-step-ca-as-a-daemon\" class=\"bare\">https://smallstep.com/docs/step-ca/certificate-authority-server-production#running-step-ca-as-a-daemon</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_caddy\">Caddy</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>配置 caddy：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/srv/caddy/Caddyfile</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-caddyfile\" data-lang=\"caddyfile\">{\n\tstorage file_system /srv/caddy/storage\n\tadmin off\n\temail ca@demo.com <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\tacme_ca https://ca.demo.com:8443/acme/acme/directory <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\tacme_ca_root &lt;step path&gt;/.step/certs/root_ca.crt <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n\ton_demand_tls {\n\t\t# ask      http://localhost:5555/check\n\t\tinterval 1s\n\t\tburst 1\n\t}\n}\n\n*.demo.io demo.io { <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\n\ttls /srv/caddy/ssl/certs/demo.io.crt /srv/caddy/ssl/private/demo.io.key\n\n\troot * /srv/caddy/html/{host}\n\tfile_server\n}\n\nhttps:// { <i class=\"conum\" data-value=\"5\"></i><b>(5)</b>\n\ttls {\n\t\ton_demand\n\t}\n\troot * /srv/caddy/html/{host}\n\tfile_server\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>邮箱，创建 ACME 帐号时使用；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>ACME CA 目录；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>ACME CA 根证书；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>\n<td><code>*.demo.io</code> <code>demo.io</code> 使用自签名证书；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"5\"></i><b>5</b></td>\n<td>其他的域名通过 ACME 颁发证书。</td>\n</tr>\n</table>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_验证\">验证</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl s_client -connect app1.demo.io:443\nopenssl s_client -connect app1.demo.dev:443</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>查看证书详情</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_systemd_2\">systemd</h3>\n<div class=\"paragraph\">\n<p><a href=\"https://caddyserver.com/docs/running\" class=\"bare\">https://caddyserver.com/docs/running</a></p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://github.com/smallstep/cli/releases\" class=\"bare\">https://github.com/smallstep/cli/releases</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/smallstep/certificates/releases\" class=\"bare\">https://github.com/smallstep/certificates/releases</a></p>\n</li>\n<li>\n<p><a href=\"https://smallstep.com/docs/step-ca/getting-started\" class=\"bare\">https://smallstep.com/docs/step-ca/getting-started</a></p>\n</li>\n<li>\n<p><a href=\"https://smallstep.com/docs/tutorials/acme-protocol-acme-clients\" class=\"bare\">https://smallstep.com/docs/tutorials/acme-protocol-acme-clients</a></p>\n</li>\n<li>\n<p><a href=\"https://caddyserver.com/docs/caddyfile/options\" class=\"bare\">https://caddyserver.com/docs/caddyfile/options</a></p>\n</li>\n<li>\n<p><a href=\"https://caddyserver.com/docs/automatic-https\" class=\"bare\">https://caddyserver.com/docs/automatic-https</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Caddy 使用 step-ca 作为 ACME 服务"},"pageAttributes":{"slug":"caddy-with-step-ca","category":"linux"},"revision":{"date":"2023-03-22","number":"1.0"}}},"pageContext":{"id":"b7c8553f-d474-5f77-88f0-3a7dda62c8ce","pageAttributes__slug":"caddy-with-step-ca","__params":{"pageAttributes__slug":"caddy-with-step-ca"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}