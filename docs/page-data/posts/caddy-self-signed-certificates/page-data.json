{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/caddy-self-signed-certificates/","result":{"data":{"asciidoc":{"id":"3767baf4-0e0b-5d15-95ce-6402198675e2","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>系统环境：Ubuntu 22.04</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_场景\">场景</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_单域名使用已有证书\">单域名，使用已有证书</h3>\n<div class=\"paragraph\">\n<p><a href=\"/posts/linux-ssl-nginx/\">生成自签名证书</a>，然后执行：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">mkdir -p /etc/caddy/ssl/{private,certs}\n# 修改私钥目录权限\nchmod 700 /etc/caddy/ssl/private\n# 复制私钥\ncp demo.com/demo.com.key /etc/caddy/ssl/private/\n# 域名证书和二级根证书内容重定向到同一个文件\ncat demo.com/demo.com.crt ca2.demo.com/cacert.pem &gt; /etc/caddy/ssl/certs/demo.com.crt</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>caddy 配置：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/etc/caddy/Caddyfile</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-Caddyfile\" data-lang=\"Caddyfile\">{\n\tadmin off <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\tocsp_stapling off <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n}\n\ndemo.com {\n\ttls /etc/caddy/ssl/certs/demo.com.crt /etc/caddy/ssl/private/demo.com.key <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n\n\troot * /srv/caddy/html/demo.com <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\n\tfile_server <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>禁用管理页面；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>禁用 OCSP stapling。OCSP(<strong>O</strong>nline <strong>C</strong>ertificate <strong>S</strong>tatus <strong>P</strong>rotocol) 在线证书状态协议，用来验证证书是否有效。启用 OCSP stapling 时，表示由 caddy 服务验证证书是否有效，这里是使用自签名证书，所以禁用；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>设置证书和私钥；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>\n<td>设置服务根路径以及使用文件服务。</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>只有一个域名且设置了 ssl 相关文件，不会启用自动化证书管理功能。</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_通配符域名使用已有通配符域名证书\">通配符域名，使用已有通配符域名证书</h3>\n<div class=\"paragraph\">\n<p><a href=\"/posts/linux-ssl-nginx/\">生成自签名证书</a>，然后执行：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">cp demo.io/demo.io.key /etc/caddy/ssl/private/\ncat demo.io/demo.io.crt ca2.demo.com/cacert.pem &gt; /etc/caddy/ssl/certs/demo.io.crt</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>caddy 配置：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/etc/caddy/Caddyfile</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-Caddyfile\" data-lang=\"Caddyfile\">{\n\tadmin off\n\tocsp_stapling off\n}\n\n*.demo.io {\n\ttls /etc/caddy/ssl/certs/demo.io.crt /etc/caddy/ssl/private/demo.io.key <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\n\troot * /srv/caddy/html/{host} <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\tfile_server\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>设置通配域名证书和私钥；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>根据变量 <code>host</code> 设置对应域名根目录。</td>\n</tr>\n</table>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_通配符域名自动生成自签名证书\">通配符域名，自动生成自签名证书</h3>\n<div class=\"paragraph\">\n<p>Caddy 可自动生成 CA 根证书和私钥，并在域名第一次访问时，自动生成域名证书和私钥。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/etc/caddy/Caddyfile</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-Caddyfile\" data-lang=\"Caddyfile\">{\n\tstorage file_system /etc/caddy/storage <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\tadmin off\n\ton_demand_tls { <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\t\t# ask http://localhost:5555/check\n\t\tinterval 1s\n\t\tburst 1\n\t}\n\tocsp_stapling off\n}\n\n*.demo.dev {\n\ttls internal { <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n\t\ton_demand  <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\n\t}\n\n\troot * /srv/caddy/html/{host}\n\tfile_server\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>证书、私钥存储路径，默认值为 <code>$HOME/.local/share/caddy</code>；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>按需配置 TLS，但并开启（开启是通过(4)）<code>interval</code> 时间段可执行 <code>burst</code> 次操作，还可以通过 ask 方式验证域名；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>使用 caddy 内部的本地授信的 CA 为该站点生成证书；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>\n<td>证书按需加载，不存在时会自动生成，为保证安全需要和 <code>on_demand_tls</code> 一同使用。</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>在 Linux上，Chromium (Chrome Edge) 使用 NSS 共享数据库，为了让本地 CA 证书自动添加到浏览器中，可先安装 <code>libnss3-tools</code>：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo apt install libnss3-tools</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>服务启动时，会生成自签名的本地 CA 并将其添加到系统环境中：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-log\" data-lang=\"log\">INFO\tcertificate installed properly in NSS security databases\nINFO\tcertificate installed properly in Java keystore\nINFO\tcertificate installed properly in linux trusts</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>查看由 caddy 添加到系统中的本地 CA：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># curl 工具使用\nls -lh /etc/ssl/certs/* | grep -i caddy\n# 浏览器使用\ncertutil -d sql:$HOME/.pki/nssdb -L</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>当配置中的域名被首次访问时，caddy 会使用本地的 ca 自动生成该域名的证书和私钥。</p>\n</div>\n<div class=\"paragraph\">\n<p>通过终端查看证书信息：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl s_client -connect app1.demo.dev:443</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>浏览器未导入 CA 根证书时可能报错：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Edge ：你现在无法访问 app1.demo.dev，因为网站使用的是 HSTS。网络错误和攻击通常是暂时的，因此该页面以后可能会恢复正常。</p>\n</li>\n<li>\n<p>Firefox ：app1.demo.dev has a security policy called HTTP Strict Transport Security (HSTS), which means that Firefox can only connect to it securely. You can’t add an exception to visit this site.</p>\n</li>\n</ul>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_使用已有的_ca_根证书和私钥\">使用已有的 CA 根证书和私钥</h4>\n<div class=\"paragraph\">\n<p>Caddy 也可以指定 CA 证书和私钥来自动生成域名证书。</p>\n</div>\n<div class=\"paragraph\">\n<p><a href=\"/posts/linux-ssl-nginx/\">生成自签名证书</a>，然后执行：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 复制 CA 中间证书 ca2 和根证书 ca1\ncp ca2.demo.com/cacert.pem /etc/caddy/ssl/certs/ca2.demo.com.crt\ncp ca1.demo.com/cacert.pem /etc/caddy/ssl/certs/ca1.demo.com.crt\n# 复制 CA 中间证书私钥（明文）\ncp ca2.demo.com/private/cakey.pem /etc/caddy/ssl/private/ca2.demo.com.key\n# 复制 CA 根证书私钥（源密文，目标明文）\nopenssl rsa -in ca1.demo.com/private/cakey.pem -out /etc/caddy/ssl/private/ca1.demo.com.key</code></pre>\n</div>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/etc/caddy/Caddyfile</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-Caddyfile\" data-lang=\"Caddyfile\">{\n\tstorage file_system /etc/caddy/storage\n\tadmin off\n\ton_demand_tls {\n\t\t# ask http://localhost:5555/check\n\t\tinterval 1s\n\t\tburst 1\n\t}\n\tocsp_stapling off\n\tpki {\n\t\tca demo { <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\t\t\troot { <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\t\t\t\tcert /etc/caddy/ssl/certs/ca1.demo.com.crt\n\t\t\t\tkey /etc/caddy/ssl/private/ca1.demo.com.key\n\t\t\t}\n\t\t\tintermediate { <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n\t\t\t\tcert /etc/caddy/ssl/certs/ca2.demo.com.crt\n\t\t\t\tkey /etc/caddy/ssl/private/ca2.demo.com.key\n\t\t\t}\n\t\t}\n\t}\n}\n\n*.demo.net {\n\ttls {\n\t\tissuer internal { <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\n\t\t\tca demo\n\t\t}\n\t\ton_demand\n\t}\n\n\troot * /srv/caddy/html/{host}\n\tfile_server\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>CA 配置名称为 <code>demo</code>；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>CA 根证书和私钥；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>CA 中间证书和私钥；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>\n<td>使用 caddy 内部名为 demo 的 CA 颁发证书。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_任意域名自动生成自签名证书\">任意域名，自动生成自签名证书</h3>\n<div class=\"listingblock\">\n<div class=\"title\">/etc/caddy/Caddyfile</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-caddyfile\" data-lang=\"caddyfile\">{\n\tstorage file_system /etc/caddy/storage\n\tadmin off\n\tlocal_certs <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\ton_demand_tls {\n\t\t# ask      http://localhost:5555/check\n\t\tinterval 1s\n\t\tburst 1\n\t}\n}\n\nhttps:// { <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\ttls internal {\n\t\ton_demand\n\t}\n\troot * /srv/caddy/html/{host}\n\tfile_server\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>使用内部颁发证书；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>所有 https 请求自动颁发内部证书。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://caddy.community/t/serving-tens-of-thousands-of-domains-over-https-with-caddy/11179\" class=\"bare\">https://caddy.community/t/serving-tens-of-thousands-of-domains-over-https-with-caddy/11179</a></p>\n</li>\n<li>\n<p><a href=\"https://caddyserver.com/docs/caddyfile/concepts\" class=\"bare\">https://caddyserver.com/docs/caddyfile/concepts</a></p>\n</li>\n<li>\n<p><a href=\"https://caddyserver.com/docs/caddyfile/options\" class=\"bare\">https://caddyserver.com/docs/caddyfile/options</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"caddy 使用自签名证书"},"pageAttributes":{"slug":"caddy-self-signed-certificates","category":"linux"},"revision":{"date":"2023-03-17","number":"1.0"}}},"pageContext":{"id":"3767baf4-0e0b-5d15-95ce-6402198675e2","pageAttributes__slug":"caddy-self-signed-certificates","__params":{"pageAttributes__slug":"caddy-self-signed-certificates"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}