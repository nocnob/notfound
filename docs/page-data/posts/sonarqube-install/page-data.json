{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/sonarqube-install/","result":{"data":{"asciidoc":{"id":"34f665a8-22b7-5092-beb4-8063ee081f8b","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Ubuntu 22.04</p>\n</li>\n<li>\n<p>OpenJDK 11</p>\n</li>\n<li>\n<p>SonarQube 9.5</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p><a href=\"https://www.sonarqube.org/\">SonarQube</a> 是一个开源平台，用于管理源代码的质量。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_概览\"><a class=\"anchor\" href=\"#_概览\"></a>概览</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>SonarQube 包括两部分：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>SonarQube (Server)</p>\n</li>\n<li>\n<p>SonarScanner</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-plantuml\" data-lang=\"plantuml\">@startuml\nparticipant SonarScanner\nparticipant SonarQube\n\nSonarScanner --&gt; SonarQube : http, token\n@enduml</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>用户执行 SonarScanner 后，SonarScanner 会对源码进行扫描、分析并生成分析报告，然后将报告发送给 SonarQube，再由 SonarQube 对报告进行加工、展示、管理。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_数据库\"><a class=\"anchor\" href=\"#_数据库\"></a>数据库</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>数据库使用 PostgreSQL。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 安装\nsudo apt install postgresql\n\n# 创建 PostgreSQL 用户\nsudo -u postgres createuser --pwprompt sonarqube\n# 创建 PostgreSQL 数据库并指定所有者\nsudo -u postgres createdb sonarqube --owner sonarqube\n\n# 登录数据库\npsql -h 127.0.0.1 -U sonarqube -d sonarqube</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_sonarqube\"><a class=\"anchor\" href=\"#_sonarqube\"></a>SonarQube</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_下载\"><a class=\"anchor\" href=\"#_下载\"></a>下载</h3>\n<div class=\"paragraph\">\n<p>SonarQube 官方下载页面 <a href=\"https://www.sonarqube.org/downloads/\" class=\"bare\">https://www.sonarqube.org/downloads/</a> 下载当前最新版：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 下载\nwget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-9.5.0.56709.zip\n# 解压\nunzip sonarqube-9.5.0.56709.zip\n# 重命名\nsudo mv sonarqube-9.5.0.56709 /opt/sonarqube</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_配置\"><a class=\"anchor\" href=\"#_配置\"></a>配置</h3>\n<div class=\"paragraph\">\n<p>SonarQube 的配置文件为 <code>conf/sonar.properties</code> ，编辑：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">conf/sonar.properties</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-diff\" data-lang=\"diff\"> # User credentials.\n # Permissions to create tables, indices and triggers must be granted to JDBC user.\n # The schema must be created first.\n-#sonar.jdbc.username=\n-#sonar.jdbc.password=\n+sonar.jdbc.username=sonarqube\n+sonar.jdbc.password=YOUR_PASSWORD\n\n\n #----- PostgreSQL 9.6 or greater\n # By default the schema named \"public\" is used. It can be overridden with the parameter \"currentSchema\".\n-#sonar.jdbc.url=jdbc:postgresql://localhost/sonarqube?currentSchema=my_schema\n+sonar.jdbc.url=jdbc:postgresql://localhost/sonarqube?currentSchema=public</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_启动\"><a class=\"anchor\" href=\"#_启动\"></a>启动</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 查看状态\nbin/linux-x86-64/sonar.sh status\n# 启动\nbin/linux-x86-64/sonar.sh start\n# 停止\nbin/linux-x86-64/sonar.sh stop</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>启动时，日志中出现报错：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">bootstrap check failure [1] of [1]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>修改 max_map_count，操作系统重启后会失效：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo sysctl -w vm.max_map_count=262144\n# 检查\nsysctl -n vm.max_map_count</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>或者编辑文件 <code>/etc/sysctl.conf</code>，添加：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-conf\" data-lang=\"conf\">vm.max_map_count = 262144</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>执行命令 <code>sudo sysctl -p</code> 重新加载配置，重启后配置依旧生效。</p>\n</div>\n<div class=\"paragraph\">\n<p>访问 <a href=\"http://localhost:9000/\" class=\"bare\">http://localhost:9000/</a> 可以看到 SonarQube 的页面。</p>\n</div>\n<div class=\"paragraph\">\n<p>默认用户名和密码都为 <code>admin</code>，登录后会要求修改。</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_sonarscanner\"><a class=\"anchor\" href=\"#_sonarscanner\"></a>SonarScanner</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_安装\"><a class=\"anchor\" href=\"#_安装\"></a>安装</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-linux.zip\nunzip sonar-scanner-cli-4.7.0.2747-linux.zip\nsudo mv sonar-scanner-4.7.0.2747-linux /opt/sonar-scanner</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_仓库\"><a class=\"anchor\" href=\"#_仓库\"></a>仓库</h3>\n<div class=\"paragraph\">\n<p>官方提供的测试仓库：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git clone https://github.com/SonarSource/sonar-scanning-examples.git</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_配置_2\"><a class=\"anchor\" href=\"#_配置_2\"></a>配置</h3>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>创建 Project，选择 Manually：</p>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/sonarqube-install-project-create.png\" alt=\"sonarqube install project create\" width=\"600\">\n</div>\n</div>\n</li>\n<li>\n<p>填写 Project 表单，点击 Set Up</p>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/sonarqube-install-project-create-manual.png\" alt=\"sonarqube install project create manual\" width=\"600\">\n</div>\n</div>\n</li>\n<li>\n<p>生成 Token，提供给客户端使用：</p>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/sonarqube-install-project-create-token.png\" alt=\"sonarqube install project create token\" width=\"600\">\n</div>\n</div>\n</li>\n<li>\n<p>生成分析使用的命令，复制命令：</p>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/sonarqube-install-project-create-run-analyze.png\" alt=\"sonarqube install project create run analyze\" width=\"600\">\n</div>\n</div>\n</li>\n<li>\n<p>在仓库执行分析，未设置环境变量 PATH，需要补全 sonar-scanner 路径：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">cd sonar-scanning-examples/sonarqube-scanner\n\n/opt/sonar-scanner/bin/sonar-scanner \\\n  -Dsonar.projectKey=sonar-scanning-examples \\\n  -Dsonar.sources=. \\\n  -Dsonar.host.url=http://localhost:9000 \\\n  -Dsonar.login=sqp_8a346553c4f4d9a91a1938199c8313bd21e6c301</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>页面查看分析结果：</p>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/sonarqube-install-project-analyze-result.png\" alt=\"sonarqube install project analyze result\" width=\"600\">\n</div>\n</div>\n</li>\n</ol>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_nginx\"><a class=\"anchor\" href=\"#_nginx\"></a>Nginx</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>添加文件 <code>./etc/nginx/conf.d/sonarqube.conf</code>：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/etc/nginx/conf.d/sonarqube.conf</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nginx\" data-lang=\"nginx\">upstream sonarqube {\n    keepalive 32;          # keepalive connections\n    server 127.0.0.1:9000; # sonarqube ip and port\n}\n\n# the server directive is Nginx's virtual host directive\nserver {\n\tlisten 80; # Listen on port 80 for IPv4 requests\n\n\tserver_name sonarqube.notfound.cn;  <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\n\tlocation / {\n\t\tproxy_pass http://sonarqube;\n\t\tproxy_set_header Host $host;\n\t\tproxy_set_header X-Forwarded-For $remote_addr;\n\t}\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>域名，根据需要修改</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>之后可通过 <a href=\"http://sonarqube.notfound.cn/\" class=\"bare\">http://sonarqube.notfound.cn/</a> 直接访问。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://docs.sonarqube.org/latest/requirements/requirements/\" class=\"bare\">https://docs.sonarqube.org/latest/requirements/requirements/</a></p>\n</li>\n<li>\n<p><a href=\"https://docs.sonarqube.org/latest/setup/get-started-2-minutes/\" class=\"bare\">https://docs.sonarqube.org/latest/setup/get-started-2-minutes/</a></p>\n</li>\n<li>\n<p><a href=\"https://docs.sonarqube.org/latest/setup/install-server/\" class=\"bare\">https://docs.sonarqube.org/latest/setup/install-server/</a></p>\n</li>\n<li>\n<p><a href=\"https://docs.sonarqube.org/latest/setup/operate-server/\" class=\"bare\">https://docs.sonarqube.org/latest/setup/operate-server/</a></p>\n</li>\n<li>\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/5.5/vm-max-map-count.html\" class=\"bare\">https://www.elastic.co/guide/en/elasticsearch/reference/5.5/vm-max-map-count.html</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"SonarQube 环境搭建"},"pageAttributes":{"slug":"sonarqube-install","category":"tool"},"revision":{"date":"2022-07-30","number":"1.0"}}},"pageContext":{"id":"34f665a8-22b7-5092-beb4-8063ee081f8b","pageAttributes__slug":"sonarqube-install","__params":{"pageAttributes__slug":"sonarqube-install"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}