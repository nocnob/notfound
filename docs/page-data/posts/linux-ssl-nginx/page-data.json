{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/linux-ssl-nginx/","result":{"data":{"asciidoc":{"id":"e6d83bc4-842b-534b-a425-3478d9ff7185","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>fedora 35</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_自签名证书\"><a class=\"anchor\" href=\"#_自签名证书\"></a>自签名证书</h2>\n<div class=\"sectionbody\">\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>生成服务器私钥：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl genrsa -out example_com.key 2048</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>生成证书签名请求：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl req -new -key example_com.key -out example_com.csr</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>Common Name (eg, your name or your server&#8217;s hostname)</code> 填写域名 <code>example.com</code></p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p>使用证书签名请求以及私钥签发证书</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl x509 -req -days 365 -in example_com.csr -signkey example_com.key -out example_com.crt</code></pre>\n</div>\n</div>\n</li>\n</ol>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_生成自签名_ca_证书\"><a class=\"anchor\" href=\"#_生成自签名_ca_证书\"></a>生成自签名 CA 证书</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>在目录 ssl 中执行操作</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_ca\"><a class=\"anchor\" href=\"#_ca\"></a>CA</h3>\n<div class=\"paragraph\">\n<p>测试域名为 <code>example.com</code></p>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>创建 CA 目录：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">mkdir -p demoCA/{certs,newcerts,crl,private}\ntouch demoCA/index.txt\necho \"01\" &gt; demoCA/serial</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>配置 openssl：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">cp /etc/ssl/openssl.cnf .\nsed -i 's/\\/etc\\/pki\\/CA/demoCA/g' openssl.cnf</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>CA 目录从 <code>/etc/pki/CA</code> 改为 <code>demoCA</code></p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p>生成 CA 私钥和证书：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl req -new -x509 -days 365 -newkey rsa:2048 -keyout demoCA/private/cakey.pem \\\n  -out demoCA/cacert.pem -config openssl.cnf</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>证书有效期 356 天</p>\n</li>\n<li>\n<p>输出目录与配置文件一致</p>\n</li>\n<li>\n<p>注意输入域名 <code>Common Name (eg, your name or your server&#8217;s hostname) []:example.com</code></p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p>查看 key 和证书：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 查看 rsa 私钥\nopenssl rsa -noout -text -in demoCA/private/cakey.pem\n# 查看证书\nopenssl x509 -noout -text -in demoCA/cacert.pem</code></pre>\n</div>\n</div>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>目录结构</p>\n</div>\n<div class=\"literalblock\">\n<div class=\"content\">\n<pre>ssl\n├── demoCA\n│   ├── cacert.pem\n│   ├── certs\n│   ├── crl\n│   ├── index.txt\n│   ├── newcerts\n│   ├── private\n│   │   └── cakey.pem\n│   └── serial\n└── openssl.cnf</pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_客户端\"><a class=\"anchor\" href=\"#_客户端\"></a>客户端</h3>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>生成客户端私钥：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl genrsa -out example_com.key 2048</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>生成证书签名请求：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl req -new -key example_com.key -out example_com.csr -config openssl.cnf</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>注意输入域名 <code>Common Name (eg, your name or your server&#8217;s hostname) []: example.com</code></p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p>使用 CA 根证书签发客户端证书：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl ca -in example_com.csr -out example_com.crt -config openssl.cnf</code></pre>\n</div>\n</div>\n</li>\n</ol>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_多级证书\"><a class=\"anchor\" href=\"#_多级证书\"></a>多级证书</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">mkdir -p ssl/{ca_1,ca_2,client}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>目录结构：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ssl\" data-lang=\"ssl\">├── ca_1\n├── ca_2\n└── client</code></pre>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_根_ca\"><a class=\"anchor\" href=\"#_根_ca\"></a>根 CA</h3>\n<div class=\"paragraph\">\n<p>在目录 <code>ca_1</code> 中执行</p>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>创建目录</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">mkdir -p demoCA/{certs,newcerts,crl,private}</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>配置</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">cp /etc/ssl/openssl.cnf .\nsed -i 's/\\/etc\\/pki\\/CA/demoCA/g' openssl.cnf\ntouch demoCA/index.txt\necho \"01\" &gt; demoCA/serial</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>修改 <code>openssl.cnf</code></p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-diff\" data-lang=\"diff\">-x509_extensions        = usr_cert\n+x509_extensions        = v3_ca</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>生成私钥和证书</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl req -config openssl.cnf \\\n  -new -x509 -newkey rsa:2048 \\\n  -keyout demoCA/private/cakey.pem \\\n  -out demoCA/cacert.pem</code></pre>\n</div>\n</div>\n</li>\n</ol>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_二级_ca\"><a class=\"anchor\" href=\"#_二级_ca\"></a>二级 CA</h3>\n<div class=\"paragraph\">\n<p>在目录 <code>ca_2</code> 中执行</p>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>创建目录</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">mkdir -p demoCA/{certs,newcerts,crl,private}</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>配置</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">cp /etc/ssl/openssl.cnf .\nsed -i 's/\\/etc\\/pki\\/CA/demoCA/g' openssl.cnf\ntouch demoCA/index.txt\necho \"01\" &gt; demoCA/serial</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>生成私钥和证书请求</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl genrsa -out demoCA/private/cakey.pem 2048\nopenssl req -config openssl.cnf \\\n  -new -key demoCA/private/cakey.pem \\\n  -out second.csr</code></pre>\n</div>\n</div>\n</li>\n</ol>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_二级_ca_签名\"><a class=\"anchor\" href=\"#_二级_ca_签名\"></a>二级 CA 签名</h4>\n<div class=\"paragraph\">\n<p>通过根 CA 对二级 CA 证书请求进行签名，在目录 <code>ca_1</code> 中执行</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl ca -config openssl.cnf -in ../ca_2/second.csr -out ../ca_2/demoCA/cacert.pem</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_客户端_2\"><a class=\"anchor\" href=\"#_客户端_2\"></a>客户端</h3>\n<div class=\"paragraph\">\n<p>在目录 <code>client</code> 中执行</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">cp /etc/ssl/openssl.cnf .\nopenssl genrsa -out client.key 2048\nopenssl req -config openssl.cnf -new -key client.key -out client.csr</code></pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_客户端签名\"><a class=\"anchor\" href=\"#_客户端签名\"></a>客户端签名</h4>\n<div class=\"paragraph\">\n<p>在目录 <code>ca_2</code> 中执行</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl ca -config openssl.cnf \\\n  -in ../client/client.csr -out ../client/client.crt</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_多域名证书\"><a class=\"anchor\" href=\"#_多域名证书\"></a>多域名证书</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>修改 <code>openssl.conf</code>\n.openssl.conf</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-conf\" data-lang=\"conf\">subjectAltName=DNS:example.com,DNS:*.example.com</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>证书可对 example.com 和 example.com 二级域名生效</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_配置_nginx\"><a class=\"anchor\" href=\"#_配置_nginx\"></a>配置 Nginx</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nginx\" data-lang=\"nginx\">server {\n  listen       443 ssl http2;\n  listen       [::]:443 ssl http2;\n  server_name  client.example.com;\n\n  ssl_certificate client.crt;\n  ssl_certificate_key client.key;\n  # ...\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>配置多级证书时，需要将中间证书也添加到 <code>client.crt</code>，该文件包含两个证书：ca_2 和 client。也就是将 <code>ca_2/demoCA/cacert.pem</code> 和 <code>client/client.crt</code> 两个文件中的 <code>-----BEGIN CERTIFICATE-----</code> 和 <code>-----END CERTIFICATE-----</code> 部分放到同一个文件。根证书是可选的。</p>\n</div>\n<div class=\"paragraph\">\n<p>测试证书有效性</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">openssl s_client -connect client.example.com:443</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_添加_ca_到_linux_系统\"><a class=\"anchor\" href=\"#_添加_ca_到_linux_系统\"></a>添加 CA 到 Linux 系统</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>直接通过 HTTPS 请求获取证书</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 执行命令后，输入 quit\nopenssl s_client -showcerts -servername example.com -connect example.com:443 &gt; example_com_0.pem\n\nopenssl x509 -inform PEM -in example_com_0.pem -text -out example_com.pem</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>fedora 35</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo cp demoCA/cacert.pem /usr/share/pki/ca-trust-source/anchors/example_com.pem\nsudo update-ca-trust</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Ubuntu 20.04</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo cp demoCA/cacert.pem /usr/local/share/ca-certificates/example_com.crt\nsudo update-ca-certificates</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>curl、Firefox 可生效, 但 Chrome 依旧有警告</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">curl -v -I https://example.com</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://docs.azure.cn/zh-cn/articles/azure-operations-guide/application-gateway/aog-application-gateway-howto-create-self-signed-cert-via-openssl\" class=\"bare\">https://docs.azure.cn/zh-cn/articles/azure-operations-guide/application-gateway/aog-application-gateway-howto-create-self-signed-cert-via-openssl</a></p>\n</li>\n<li>\n<p><a href=\"https://nginx.org/en/docs/http/configuring_https_servers.html\" class=\"bare\">https://nginx.org/en/docs/http/configuring_https_servers.html</a></p>\n</li>\n<li>\n<p><a href=\"https://docs.fedoraproject.org/en-US/quick-docs/using-shared-system-certificates/\" class=\"bare\">https://docs.fedoraproject.org/en-US/quick-docs/using-shared-system-certificates/</a></p>\n</li>\n<li>\n<p><a href=\"https://www.postgresql.org/docs/current/ssl-tcp.html\" class=\"bare\">https://www.postgresql.org/docs/current/ssl-tcp.html</a></p>\n</li>\n<li>\n<p><a href=\"https://www.linode.com/docs/guides/using-openssls-subjectaltname-with-multiple-site-domains/\" class=\"bare\">https://www.linode.com/docs/guides/using-openssls-subjectaltname-with-multiple-site-domains/</a></p>\n</li>\n<li>\n<p><a href=\"https://curl.se/docs/sslcerts.html\" class=\"bare\">https://curl.se/docs/sslcerts.html</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"使用 OpenSSL 生成 Nginx 证书"},"pageAttributes":{"slug":"linux-ssl-nginx","category":"nginx"},"revision":{"date":"2021-11-21","number":"1.0"}}},"pageContext":{"id":"e6d83bc4-842b-534b-a425-3478d9ff7185","pageAttributes__slug":"linux-ssl-nginx","__params":{"pageAttributes__slug":"linux-ssl-nginx"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}