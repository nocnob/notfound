{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/linux-coredns/","result":{"data":{"asciidoc":{"id":"04728d07-163d-5848-8b65-95511e9a424a","html":"<div class=\"sect1\">\n<h2 id=\"_安装和启动\">安装和启动</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>下载并安装：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">COREDNS_VERSION=1.10.1\nwget \"https://github.com/coredns/coredns/releases/download/v${COREDNS_VERSION}/coredns_${COREDNS_VERSION}_linux_amd64.tgz\"\nsudo tar -C /usr/bin -xzvf \"coredns_${COREDNS_VERSION}_linux_amd64.tgz\"</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>创建用户和目录：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo useradd --home-dir /var/lib/coredns --shell /usr/sbin/nologin --no-create-home --user-group coredns\nsudo mkdir /var/lib/coredns\nsudo chown coredns:coredns /var/lib/coredns\n\nsudo mkdir /etc/coredns</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>coredns 配置文件：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/etc/coredns/Corefile</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-corefile\" data-lang=\"corefile\">.:1053 {\n\tforward . 119.29.29.29\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>监听端口 <code>1053</code></p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>systemd 配置：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/lib/systemd/system/coredns.service</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-systemd\" data-lang=\"systemd\">[Unit]\nDescription=CoreDNS DNS server\nDocumentation=https://coredns.io\nAfter=network.target\n\n[Service]\nPermissionsStartOnly=true\nLimitNOFILE=1048576\nLimitNPROC=512\nCapabilityBoundingSet=CAP_NET_BIND_SERVICE\nAmbientCapabilities=CAP_NET_BIND_SERVICE\nNoNewPrivileges=true\nUser=coredns\nWorkingDirectory=~\nExecStart=/usr/bin/coredns -conf=/etc/coredns/Corefile\nExecReload=/bin/kill -SIGUSR1 $MAINPID\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>CAP_NET_BIND_SERVICE</code> 非 root 用户可绑定 1024 以下端口，参考 <code>man capabilities</code>；</p>\n</li>\n<li>\n<p><code>CapabilityBoundingSet</code> 能力边界，表示限制；</p>\n</li>\n<li>\n<p><code>AmbientCapabilities</code> 能力授予。</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>启动：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo systemctl start coredns.service</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>查看日志：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">journalctl --follow --unit=coredns.service</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>测试：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">dig @localhost -p 1053 google.com A\ndig @localhost -p 1053 ipv6.google.com AAAA</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>@server</code> 查询使用的 IP 或者 hostname</p>\n</li>\n<li>\n<p><code>-p</code> 查询使用的端口</p>\n</li>\n<li>\n<p><code>A</code> 查询 IPv4 地址</p>\n</li>\n<li>\n<p><code>AAAA</code> 查询 IPv6 地址</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_配置\">配置</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>配置解析域名 <code>demo.io</code>：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/etc/coredns/Corefile</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-corefile\" data-lang=\"corefile\">demo.io:1053 {\n\tfile /etc/coredns/db.demo.io <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\tlog\n}\n\n.:1053 {\n\tforward . 119.29.29.29\n\tlog\n\terrors\n\tcache\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>DNS zone 文件路径</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>创建 DNS zone 文件：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/etc/coredns/db.demo.io</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-dns-zone\" data-lang=\"dns-zone\">$ORIGIN demo.io.\n@\t3600 IN\tSOA sns.dns.icann.org. noc.dns.icann.org. (\n\t\t\t\t2017042745 ; serial\n\t\t\t\t7200       ; refresh (2 hours)\n\t\t\t\t3600       ; retry (1 hour)\n\t\t\t\t1209600    ; expire (2 weeks)\n\t\t\t\t3600       ; minimum (1 hour)\n\t\t\t\t)\n\n\t3600 IN NS a.iana-servers.net.\n\t3600 IN NS b.iana-servers.net.\n\n@       IN A     127.0.0.1\n        IN AAAA  ::1\n*       IN A     127.0.0.1\n        IN AAAA  ::1</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>@</code> 直接解析主域名 <code>demo.io</code></p>\n</li>\n<li>\n<p><code>*</code> 泛解析，匹配所有二级域名 <code>*.demo.io</code></p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>测试:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">host -p 1053 demo.io\n# demo.io has address 127.0.0.1\n# demo.io has IPv6 address ::1\nhost -p 1053 app.demo.io\n# app.demo.io has address 127.0.0.1\n# app.demo.io has IPv6 address ::1</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>man capabilities</p>\n</li>\n<li>\n<p><a href=\"https://coredns.io/manual/toc/\" class=\"bare\">https://coredns.io/manual/toc/</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/coredns/deployment/tree/master/systemd\" class=\"bare\">https://github.com/coredns/deployment/tree/master/systemd</a></p>\n</li>\n<li>\n<p><a href=\"https://unix.stackexchange.com/questions/580597/what-is-the-difference-between-ambientcapabilities-and-capabilityboundingset\" class=\"bare\">https://unix.stackexchange.com/questions/580597/what-is-the-difference-between-ambientcapabilities-and-capabilityboundingset</a></p>\n</li>\n<li>\n<p><a href=\"https://www.cisco.com/c/zh_cn/support/docs/ip/domain-name-system-dns/12684-dns-resource.html\" class=\"bare\">https://www.cisco.com/c/zh_cn/support/docs/ip/domain-name-system-dns/12684-dns-resource.html</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"CoreDNS 安装和使用"},"pageAttributes":{"slug":"linux-coredns","category":"linux"},"revision":{"date":"2023-03-28","number":"1.0"}}},"pageContext":{"id":"04728d07-163d-5848-8b65-95511e9a424a","pageAttributes__slug":"linux-coredns","__params":{"pageAttributes__slug":"linux-coredns"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}