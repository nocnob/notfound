{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/linux-pgbouncer-start/","result":{"data":{"asciidoc":{"id":"58e1047d-65ba-53ea-bc82-f9f89f1d23a1","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Ubuntu 20.04</p>\n</li>\n<li>\n<p>PostgreSQL 14</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_编译安装\"><a class=\"anchor\" href=\"#_编译安装\"></a>编译安装</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo apt install libevent-dev\n\nwget https://www.pgbouncer.org/downloads/files/1.16.1/pgbouncer-1.16.1.tar.gz\ncd pgbouncer-1.16.1\n./configure --prefix=/usr/local --with-systemd\nmake -j8\nsudo make install</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>--with-systemd</code> systemd 集成</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_配置\"><a class=\"anchor\" href=\"#_配置\"></a>配置</h2>\n<div class=\"sectionbody\">\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p><code>pgbouncer.ini</code></p>\n<div class=\"paragraph\">\n<p>编辑 <code>etc/pgbouncer.ini</code>：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ini\" data-lang=\"ini\">[databases]\nexample_db= host=127.0.0.1 port=5432 dbname=example_db\n\n[pgbouncer]\nauth_type = scram-sha-256\nauth_file = /usr/local/etc/pgbouncer/userlist.txt\n;; 关注配置项\n;; max_client_conn     ;; 客户端最大连接数\n;; default_pool_size   ;; 链接池大小\n;; pool_mode = session ;; 连接池模式</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>添加 example_db</p>\n</li>\n<li>\n<p><code>auth_type</code> 来自 PostgreSQL 配置文件 <code>/etc/postgresql/14/main/pg_hba.conf</code></p>\n</li>\n<li>\n<p>修改 <code>auth_files</code> 路径</p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p><code>userlist.txt</code></p>\n<div class=\"paragraph\">\n<p>查询用户名和密码：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">SELECT usename, passwd FROM pg_shadow WHERE usename='example';\n=&gt; example | SCRAM-SHA-256$4096:****</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>编辑 <code>etc/userlist.txt</code>，填写查询到的结果：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">\"example\" \"SCRAM-SHA-256$4096:****\"</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>复制配置文件到指定位置</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo mkdir /usr/local/etc/pgbouncer\nsudo cp etc/pgbouncer.ini /usr/local/etc/pgbouncer\nsudo cp etc/userlist.txt /usr/local/etc/pgbouncer</code></pre>\n</div>\n</div>\n</li>\n</ol>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_systemd\"><a class=\"anchor\" href=\"#_systemd\"></a>systemd</h3>\n<div class=\"paragraph\">\n<p>添加 systemd 配置  <a href=\"https://github.com/pgbouncer/pgbouncer/blob/master/etc/pgbouncer.service\">参考</a>。新建文件 <code>etc/pgbouncer.service</code>：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-systemd\" data-lang=\"systemd\">[Unit]\nDescription=connection pooler for PostgreSQL\nDocumentation=man:pgbouncer(1)\nDocumentation=https://www.pgbouncer.org/\nAfter=network.target\n#Requires=pgbouncer.socket\n\n[Service]\nType=notify\nUser=postgres\nExecStart=/usr/local/bin/pgbouncer /usr/local/etc/pgbouncer/pgbouncer.ini\nExecReload=/bin/kill -HUP $MAINPID\nKillSignal=SIGINT\nRuntimeDirectory=pgbouncer\n#LimitNOFILE=1024\n\n[Install]\nWantedBy=multi-user.target</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>将配置文件复制到 systemd 目录，并创建日志目录：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo cp etc/pgbouncer.service /lib/systemd/system/\nsudo mkdir /var/log/pgbouncer\nsudo chown postgres:postgres /var/log/pgbouncer</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_启动\"><a class=\"anchor\" href=\"#_启动\"></a>启动</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo systemctl start pgbouncer.service</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>通过 pgbouncer 链接数据库：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">psql -h 127.0.0.1 -p 6432 -d example_db</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>pgbouncer 默认端口为 6432</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_连接测试\"><a class=\"anchor\" href=\"#_连接测试\"></a>连接测试</h2>\n<div class=\"sectionbody\">\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>查看配置文件路径</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">show config_file;\n               config_file\n-----------------------------------------\n /etc/postgresql/14/main/postgresql.conf\n(1 row)</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>修改 PostgreSQL 链接数</p>\n<div class=\"paragraph\">\n<p>编辑文件 <code>/etc/postgresql/14/main/postgresql.conf</code></p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-conf\" data-lang=\"conf\"># sudo vim /etc/postgresql/14/main/postgresql.conf\nmax_connections = 1000</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>测试脚本</p>\n<div class=\"paragraph\">\n<p>安装 gem</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo gem install pg</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>测试脚本</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">#!/usr/bin/env ruby\n\nrequire 'pg'\n\nconnection_hash = {\n  host: '127.0.0.1',\n  port: 5432, # 6432\n  user: 'example',\n  password: 'YOUR_PASSWORD',\n  dbname: 'example_db'\n}\n\n1000.times.map do |i|\n  puts(\"#{i} ---------------------\")\n  conn = PG.connect(connection_hash)\n  conn.exec('SELECT * FROM pg_stat_activity') do |result|\n    puts '     PID | User             | Query'\n    result.each do |row|\n      puts(' %7d | %-16s | %s' % row.values_at('pid', 'state', 'current_query'))\n    end\n  end\n  conn\nend\nsleep 10</code></pre>\n</div>\n</div>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>直接连接 PostgreSQL 时，创建 1000 个连接导致创建 1000 个进程，内存变化：2.06G &#8594; 4.16G</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://www.pgbouncer.org/\" class=\"bare\">https://www.pgbouncer.org/</a></p>\n</li>\n<li>\n<p><a href=\"https://cloud.tencent.com/developer/article/1674779\">PostgreSQL 为什么接受大量连接到数据库需要连接池</a></p>\n</li>\n<li>\n<p><a href=\"https://cloud.tencent.com/developer/article/1620394\">PgBouncer 原理与深入</a></p>\n</li>\n<li>\n<p><a href=\"https://stackoverflow.com/questions/36495062/pycharm-and-postgres-error-unsupported-startup-parameter-extra-float-digits\">Unsupported startup parameter: extra_float_digits</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Linux Pgbouncer 使用"},"pageAttributes":{"slug":"linux-pgbouncer-start","category":"database"},"revision":{"date":"2022-01-20","number":"1.0"}}},"pageContext":{"id":"58e1047d-65ba-53ea-bc82-f9f89f1d23a1","pageAttributes__slug":"linux-pgbouncer-start","__params":{"pageAttributes__slug":"linux-pgbouncer-start"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}