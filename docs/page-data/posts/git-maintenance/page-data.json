{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/git-maintenance/","result":{"data":{"asciidoc":{"id":"5d4fc4e4-93ec-5121-b93a-7346e798e868","html":"<div class=\"sect1\">\n<h2 id=\"_git_maintenance\"><a class=\"anchor\" href=\"#_git_maintenance\"></a>git maintenance</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>通过 <code>git maintenance</code> 命令，可以对 Git 仓库定期维护。该命令包括一系列的子命令。</p>\n</div>\n<div class=\"paragraph\">\n<p>在 Linux 环境中，是通过 <code>cron</code> 执行定时任务。</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_register\"><a class=\"anchor\" href=\"#_register\"></a>register</h3>\n<div class=\"paragraph\">\n<p>将当前 Git 仓库添加到仓库维护列表中。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git maintenance register</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>修改当前仓库配置文件，添加 <code>maintenance.auto</code> 和 <code>maintenance.strategy</code></p>\n</li>\n<li>\n<p>修改用户全局配置文件 <code>~/.gitconfig</code> ，将当前仓库绝对路径添加到 <code>maintenance.repo</code> 节点</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_run\"><a class=\"anchor\" href=\"#_run\"></a>run</h3>\n<div class=\"paragraph\">\n<p>执行 Git 仓库维护任务。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git maintenance run</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>执行维护任务</p>\n</li>\n<li>\n<p>可以通过参数 <code>--task</code> 指定任务</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git maintenance run --task gc</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>task 参数如下：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>commit-graph</code> 增量更新 <code>commit-graph</code></p>\n</li>\n<li>\n<p><code>prefetch</code> 从所有 remote 拉取分支，分支信息保存到 <code>refs/prefetch/&lt;remote&gt;/</code> ，不会拉取 tag</p>\n</li>\n<li>\n<p><code>gc</code> 执行 git gc</p>\n</li>\n<li>\n<p><code>loose-objects</code> 将松散对象 <code>loose objects</code> 打包，文件名以 <code>loose-</code> 开头，不建议和 gc 同时开启</p>\n</li>\n<li>\n<p><code>incremental-repack</code> 重新打包文件</p>\n</li>\n<li>\n<p><code>pack-refs</code> 将松散的 refs 打包到单个文件</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_start\"><a class=\"anchor\" href=\"#_start\"></a>start</h3>\n<div class=\"paragraph\">\n<p>添加定时任务，并将当前 Git 仓库添加到仓库维护列表中。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git maintenance start</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>更新配置文件，与 <code>register</code> 命令相同</p>\n</li>\n<li>\n<p>添加 cron 定时任务，通过 <code>crontab -l</code> 可以看到定时任务的具体信息</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\"># BEGIN GIT MAINTENANCE SCHEDULE\n# The following schedule was created by Git\n# Any edits made in this region might be\n# replaced in the future by a Git command.\n\n0 1-23 * * * \"/usr/lib/git-core/git\" --exec-path=\"/usr/lib/git-core\" for-each-repo --config=maintenance.repo maintenance run --schedule=hourly\n0 0 * * 1-6 \"/usr/lib/git-core/git\" --exec-path=\"/usr/lib/git-core\" for-each-repo --config=maintenance.repo maintenance run --schedule=daily\n0 0 * * 0 \"/usr/lib/git-core/git\" --exec-path=\"/usr/lib/git-core\" for-each-repo --config=maintenance.repo maintenance run --schedule=weekly\n\n# END GIT MAINTENANCE SCHEDULE</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>也就是通过 <code>cron</code> 定时执行如下命令：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git for-each-repo --config=maintenance.repo maintenance run --schedule=hourly\ngit for-each-repo --config=maintenance.repo maintenance run --schedule=daily\ngit for-each-repo --config=maintenance.repo maintenance run --schedule=weekly</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>遍历 <code>--config=maintenance.repo</code> 中的仓库列表，执行 <code>git maintenance run</code> 命令</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>在 <code>incremental</code> 策略下，执行的任务如下：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>gc: disabled</p>\n</li>\n<li>\n<p>commit-graph: hourly</p>\n</li>\n<li>\n<p>prefetch: hourly</p>\n</li>\n<li>\n<p>loose-objects: daily</p>\n</li>\n<li>\n<p>incremental-repack: daily</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_stop\"><a class=\"anchor\" href=\"#_stop\"></a>stop</h3>\n<div class=\"paragraph\">\n<p>移除定时任务。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git maintenance stop</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>移除定时任务，但不会将当前仓库从 <code>maintenance.repo</code> 移除</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_unregister\"><a class=\"anchor\" href=\"#_unregister\"></a>unregister</h3>\n<div class=\"paragraph\">\n<p>将当前 Git 仓库从仓库维护列表中移除。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git maintenance unregister</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>将当前仓库从 <code>maintenance.repo</code> 移除</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_仓库列表管理\"><a class=\"anchor\" href=\"#_仓库列表管理\"></a>仓库列表管理</h3>\n<div class=\"paragraph\">\n<p>可以通过 <code>git config</code> 批量添加或删除：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 添加 Git 仓库维护列表，绝对路径\ngit config --global --add maintenance.repo /home/git/docs.git\ngit config --global --add maintenance.repo /home/git/study.git\n\n# 查看 Git 仓库维护列表\ngit config --global --get-all maintenance.repo\n# 清空 Git 仓库维护列表\ngit config --global --unset-all maintenance.repo</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>与 <code>git maintenance register</code> 不同的是，重复执行会重复添加</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h3>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>git help maintenance</code></p>\n</li>\n<li>\n<p><a href=\"https://stackoverflow.com/questions/5101485/is-there-any-way-to-list-up-git-repositories-in-terminal\" class=\"bare\">https://stackoverflow.com/questions/5101485/is-there-any-way-to-list-up-git-repositories-in-terminal</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>","document":{"title":"Git Maintenance"},"pageAttributes":{"slug":"git-maintenance","category":"git"},"revision":{"date":"2021-04-23","number":"1.0"}}},"pageContext":{"id":"5d4fc4e4-93ec-5121-b93a-7346e798e868","pageAttributes__slug":"git-maintenance","__params":{"pageAttributes__slug":"git-maintenance"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}