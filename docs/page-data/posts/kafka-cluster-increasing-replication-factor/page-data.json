{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/kafka-cluster-increasing-replication-factor/","result":{"data":{"asciidoc":{"id":"e432bd1a-6cf6-5b19-a31a-91d748383eeb","html":"<div class=\"sect1\">\n<h2 id=\"_环境准备\">环境准备</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>集群存在 3 个节点，参考 <a href=\"/posts/kafka-cluster-start\">kafka 基本使用 (KRaft，集群)</a>。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export broker=kafka01:9092\nexport topic=foo\n\n# 创建主题，3 个分区， 1 个副本\nbin/kafka-topics.sh --bootstrap-server $broker --create --topic $topic --partitions 3 --replication-factor 1\n# 查看主题详情\nbin/kafka-topics.sh --bootstrap-server $broker --describe --topic $topic\n# 输出：\n#        Topic: foo      Partition: 0    Leader: 2       Replicas: 2     Isr: 2\n#        Topic: foo      Partition: 1    Leader: 3       Replicas: 3     Isr: 3\n#        Topic: foo      Partition: 2    Leader: 1       Replicas: 1     Isr: 1</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_修改复制系数\">修改复制系数</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>通过文件 <code>.increase-replication-factor.json</code> 传递参数：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">increase-replication-factor.json</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-json\" data-lang=\"json\">{\n  \"version\": 1,\n  \"partitions\": [\n    { \"topic\": \"foo\", \"partition\": 0, \"replicas\": [1, 2, 3] },\n    { \"topic\": \"foo\", \"partition\": 1, \"replicas\": [1, 2, 3] },\n    { \"topic\": \"foo\", \"partition\": 2, \"replicas\": [1, 2, 3] }\n  ]\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>主题 foo 的分区 0、1、2 由 1 个副本修改为 3 个副本。</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>执行：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 执行\nbin/kafka-reassign-partitions.sh --bootstrap-server $broker --reassignment-json-file increase-replication-factor.json --execute\n# 验证\nbin/kafka-reassign-partitions.sh --bootstrap-server $broker --reassignment-json-file increase-replication-factor.json --verify\n# 查看主题详情\nbin/kafka-topics.sh --bootstrap-server $broker --describe --topic $topic\n# 输出：\n#        Topic: foo      Partition: 0    Leader: 2       Replicas: 1,2,3 Isr: 2,3,1\n#        Topic: foo      Partition: 1    Leader: 3       Replicas: 1,2,3 Isr: 3,2,1\n#        Topic: foo      Partition: 2    Leader: 1       Replicas: 1,2,3 Isr: 1,2,3</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_相关问题\">相关问题</h2>\n<div class=\"sectionbody\">\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>客户端出现 <code>GROUP_COORDINATOR_NOT_AVAILABLE</code></p>\n<div class=\"listingblock\">\n<div class=\"title\">kafka-go 错误信息</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">Group Coordinator Not Available: the broker returns this error code for group coordinator requests,\noffset commits, and most group management requests if the offsets topic has not yet been created,\nor if the group coordinator is not active</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>主题 <code>__consumer_offsets</code> 仅复制 1 份且保存数据的节点故障，无法获取数据偏移信息：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export broker=kafka01:9092\nexport topic=__consumer_offsets\n\n# 无法查看到相关消费者群组\nbin/kafka-consumer-groups.sh --bootstrap-server $broker --list\n\n# 内置主题 __consumer_offsets 存在不可用分区\nbin/kafka-topics.sh --bootstrap-server $broker --describe --topic $topic --unavailable-partitions\n# 输出：\n# \tTopic: __consumer_offsets\tPartition: 2\tLeader: none\tReplicas: 2\tIsr: 2\n#   ....</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>解决方案，调整内置主题复制系数，确保单个节点故障时偏移量等信息不丢失（仅新环境可用）：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-properties\" data-lang=\"properties\"># 内置偏移量主题 __consumer_offsets 复制系数\noffsets.topic.replication.factor=3\n# 事务日志复制系数\ntransaction.state.log.replication.factor=3\n# 事务日志最小同步副本数 (in-sync replicas)\ntransaction.state.log.min.isr=2</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>或者，通过 <code>kafka-reassign-partitions.sh</code> 增加主题 <code>__consumer_offsets</code> 复制系数。 生成 json：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">#!/bin/bash\n\nprintf '{\\n'\nprintf '  \"version\": 1,\\n'\nprintf '  \"partitions\": [\\n'\nfor i in {0..48}\ndo\n    printf '    { \"topic\": \"__consumer_offsets\", \"partition\": %d, \"replicas\": [1, 2, 3] },\\n' $i\ndone\nprintf '    { \"topic\": \"__consumer_offsets\", \"partition\": %d, \"replicas\": [1, 2, 3] },\\n' 49\nprintf '  ]\\n'\nprintf '}\\n'</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>topic partition has no leader</p>\n<div class=\"paragraph\">\n<p>集群多个 broker，分区 1 个副本，当分区所在的 broker 挂掉时出现。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">kafka-go 错误信息，分区 1 所在 broker 挂掉</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\"># FetchMessage\nKafka write errors (1/1), errors: [kafka.(*Client).Produce: fetch request error: topic partition has no leader (topic=\"quickstart-events\" partition=1)]\n# WriteMessages\nfailed to dial: failed to open connection to :0: dial tcp :0: connect: connection refused</code></pre>\n</div>\n</div>\n</li>\n</ol>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://kafka.apache.org/documentation/#basic_ops_increase_replication_factor\" class=\"bare\">https://kafka.apache.org/documentation/#basic_ops_increase_replication_factor</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Kafka 增加复制系数"},"pageAttributes":{"slug":"kafka-cluster-increasing-replication-factor","category":"kafka"},"revision":{"date":"2023-01-04","number":"1.0"}}},"pageContext":{"id":"e432bd1a-6cf6-5b19-a31a-91d748383eeb","pageAttributes__slug":"kafka-cluster-increasing-replication-factor","__params":{"pageAttributes__slug":"kafka-cluster-increasing-replication-factor"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}