{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/jenkins-pipeline-sonarqube/","result":{"data":{"asciidoc":{"id":"01c174ac-8d2f-516b-bfc8-a1faa5304b9b","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Ubuntu 22.04</p>\n</li>\n<li>\n<p>Jenkins 2.361</p>\n</li>\n<li>\n<p>SonarQube 9.5</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_概览\"><a class=\"anchor\" href=\"#_概览\"></a>概览</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>使用 Git + Jenkins + SonarQube 进行持续集成、测试基本流程如下：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-plantuml\" data-lang=\"plantuml\">@startuml\nparticipant gc as \"Git Client\"\nparticipant gs as \"Git Server\"\nparticipant jk as \"Jenkins\"\nparticipant ss as \"SonarScanner\"\nparticipant sq as \"SonarQube\"\n\nactivate gc\n  gc --&gt; gs : git push, ssh\n  activate gs\n    gs --&gt; jk : git hook, http\n    activate jk\n    gs &lt;-- jk\n    gc &lt;-- gs\n  deactivate gs\ndeactivate gc\n\n    gs &lt;-- jk : git clone; ssh\n    activate gs\n    gs --&gt; jk\n    deactivate gs\n\n    jk --&gt; ss : exec\n    activate ss\n      ss --&gt; sq : http\n      activate sq\n      ss &lt;-- sq\n      deactivate sq\n    jk &lt;-- ss\n    deactivate ss\n@enduml</code></pre>\n</div>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>Git Client 通过 SSH 方式推送代码到 Git Server；</p>\n</li>\n<li>\n<p>代码推送完成后，Git Server 执行 Git Hook， 可通过 Git Hook 触发 Jenkins 构建；</p>\n</li>\n<li>\n<p>Jenkins 构建时，需要通过 SSH 从 Git Server 拉取代码。</p>\n</li>\n<li>\n<p>Jenkins 执行 SonarScanner 扫描代码</p>\n</li>\n<li>\n<p>SonnarScanner 将执行结果发送给 SonarQube</p>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>在本地演示整个配置流程：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Git Server，使用本地 git 用户，SSH 地址 git@localhost</p>\n</li>\n<li>\n<p>Git Client，当前用户</p>\n</li>\n<li>\n<p>Jenkins 本地测试地址 <a href=\"http://jenkins.notfound.cn\" class=\"bare\">http://jenkins.notfound.cn</a></p>\n</li>\n<li>\n<p>SonarQube 本地测试地址 <a href=\"http://sonarqube.notfound.cn\" class=\"bare\">http://sonarqube.notfound.cn</a></p>\n</li>\n<li>\n<p>测试仓库 <a href=\"https://github.com/SonarSource/sonar-scanning-examples.git\" class=\"bare\">https://github.com/SonarSource/sonar-scanning-examples.git</a></p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>之前的文章有介绍过 <a href=\"/posts/jenkins-pipeline-gradle/\">Jenkins Pipeline</a> 和 <a href=\"/posts/sonarqube-install/\">SonarQube</a> 安装配置，所以，这里只列出主要操作。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_sonarqube\"><a class=\"anchor\" href=\"#_sonarqube\"></a>SonarQube</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_生成_token\"><a class=\"anchor\" href=\"#_生成_token\"></a>生成 Token</h3>\n<div class=\"paragraph\">\n<p>Administration &#8594; Security &#8594; Users &#8594; Tokens：</p>\n</div>\n<div class=\"paragraph\">\n<p><a href=\"http://sonarqube.notfound.cn/admin/users\" class=\"bare\">http://sonarqube.notfound.cn/admin/users</a></p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/jenkins-pipeline-sonarqube-sonarqube-user-token.png\" alt=\"jenkins-pipeline-sonarqube-sonarqube-user-token\" width=\"500\">\n</div>\n<div class=\"title\">Figure 1. SonarQube 用户 Token</div>\n</div>\n<div class=\"paragraph\">\n<p>需要将生成的 Token 复制到 Jenkins 凭据中。</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_jenkins\"><a class=\"anchor\" href=\"#_jenkins\"></a>Jenkins</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_添加凭据\"><a class=\"anchor\" href=\"#_添加凭据\"></a>添加凭据</h3>\n<div class=\"paragraph\">\n<p>Dashboard &#8594; Manage Jenkins &#8594; Manage Credentials &#8594; (global) &#8594; Add Credentials</p>\n</div>\n<div class=\"paragraph\">\n<p><a href=\"http://jenkins.notfound.cn/credentials/store/system/domain/_/newCredentials\" class=\"bare\">http://jenkins.notfound.cn/credentials/store/system/domain/_/newCredentials</a> ：</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/jenkins-pipeline-sonarqube-credential.png\" alt=\"jenkins-pipeline-sonarqube-credential\" width=\"500\">\n</div>\n<div class=\"title\">Figure 2. 添加 SonarQube 凭据</div>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<caption class=\"title\">Table 1. New credentials 表单</caption>\n<colgroup>\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3334%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">属性</th>\n<th class=\"tableblock halign-left valign-top\">值</th>\n<th class=\"tableblock halign-left valign-top\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Kind</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Secret text</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">认证类型</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Scope</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Global (Jenkins, nodes, items, all child items, etc)</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">作用域，全局</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Secret</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">SONARQUBE_TOKEN</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">sonar scanner 访问 sonarqube 的 TOKEN</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ID</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">jenkins-to-sonarqube</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">使用凭据时，通过 ID 指定</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Description</p></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">凭据描述</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_安装插件\"><a class=\"anchor\" href=\"#_安装插件\"></a>安装插件</h3>\n<div class=\"paragraph\">\n<p>Manage Jenkins &#8594; Manage Plugins &#8594; Available &#8594; 输入 <code>SonarQube</code> 搜索，选择 SonarQube Scanner</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/jenkins-pipeline-sonarqube-plugin.png\" alt=\"jenkins-pipeline-sonarqube-plugin\" width=\"500\">\n</div>\n<div class=\"title\">Figure 3. 安装 SonarQube Scanner 插件</div>\n</div>\n<div class=\"paragraph\">\n<p>安装完成后，重启服务。</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_配置_sonarqube_server\"><a class=\"anchor\" href=\"#_配置_sonarqube_server\"></a>配置 SonarQube Server</h3>\n<div class=\"paragraph\">\n<p>Dashboard &#8594; Manage Jenkins &#8594; Configure System &#8594;  SonarQube servers</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/jenkins-pipeline-sonarqube-config-server.png\" alt=\"jenkins-pipeline-sonarqube-config-server\" width=\"500\">\n</div>\n<div class=\"title\">Figure 4. 配置 SonarQube server</div>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<colgroup>\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3334%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">属性</th>\n<th class=\"tableblock halign-left valign-top\">值</th>\n<th class=\"tableblock halign-left valign-top\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Name</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">sonarqube</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">使用时通过名称指定</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Server URL</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><a href=\"http://sonarqube.notfound.cn\" class=\"bare\">http://sonarqube.notfound.cn</a></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">SonarQube Server</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Server authentication token</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">jenkins-to-sonarqube</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">访问 SonarQube 使用的 Token</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_配置_sonarqube_scanner\"><a class=\"anchor\" href=\"#_配置_sonarqube_scanner\"></a>配置 SonarQube Scanner</h3>\n<div class=\"paragraph\">\n<p>Dashboard &#8594; Manage Jenkins &#8594; Global Tool Configuration &#8594; SonarQube Scanner</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/jenkins-pipeline-sonarqube-config-scanner.png\" alt=\"jenkins-pipeline-sonarqube-config-scanner\" width=\"500\">\n</div>\n<div class=\"title\">Figure 5. 配置 SonarQube Scanner</div>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<colgroup>\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3334%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">属性</th>\n<th class=\"tableblock halign-left valign-top\">值</th>\n<th class=\"tableblock halign-left valign-top\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Name</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">4.7</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">名称，也许叫 sq-scanner 更好</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Install automatically</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Install from Maven Central</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">自动安装</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Version</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">SonarQube Scanner 4.7.0.2747</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">选择最新版</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_配置_pipeline\"><a class=\"anchor\" href=\"#_配置_pipeline\"></a>配置 Pipeline</h3>\n<div class=\"paragraph\">\n<p>新建 Pipeline，配置如下：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">Pipeline Script</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-groovy\" data-lang=\"groovy\">pipeline {\n    agent any\n    stages {\n        stage('Source') {\n            steps {\n                git branch: 'master', credentialsId: 'jenkins-to-git-localhost', url: 'git@localhost:git-data/sonar-scanning-examples.git'\n            }\n        }\n        stage('SonarQube analysis') {\n            steps {\n                // 通过环境变量向 sonar-scanner 传递 TOKEN 和 SonarQube Server 地址\n                withSonarQubeEnv(credentialsId: 'jenkins-to-sonarqube', installationName: \"sonarqube\") {\n                    // tool '4.7': 安装 sonar-scanner，并获得 sonar-scanner 目录，（名字没有取好）\n                    // sonar.projectBaseDir: 这里只分析 sonarqube-scanner 目录下的文件\n                    sh \"${tool '4.7'}/bin/sonar-scanner -Dsonar.projectBaseDir=sonarqube-scanner\"\n                }\n            }\n        }\n        stage(\"Quality Gate\") {\n            steps {\n                timeout(time: 1, unit: 'HOURS') {\n                    // 从 SonarQube 获取 Quality Gate 数据， SonarQube Quality Gate 失败时，终止 Pipeline\n                    waitForQualityGate abortPipeline: true\n                }\n            }\n        }\n    }\n}</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_分析结果\"><a class=\"anchor\" href=\"#_分析结果\"></a>分析结果</h3>\n<div class=\"paragraph\">\n<p>当 SonarQube Quality Gate 未通过，也就是 SonarQube 页面显示 Failed 时：</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/jenkins-pipeline-sonarqube-result.png\" alt=\"jenkins-pipeline-sonarqube-result\" width=\"500\">\n</div>\n<div class=\"title\">Figure 6. SonarQube 分析结果</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-jenkins/\" class=\"bare\">https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-jenkins/</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Jenkins Pipeline: Sonarqube"},"pageAttributes":{"slug":"jenkins-pipeline-sonarqube","category":"jenkins"},"revision":{"date":"2022-07-31","number":"1.0"}}},"pageContext":{"id":"01c174ac-8d2f-516b-bfc8-a1faa5304b9b","pageAttributes__slug":"jenkins-pipeline-sonarqube","__params":{"pageAttributes__slug":"jenkins-pipeline-sonarqube"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}