{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/distribution-etcd-queue/","result":{"data":{"asciidoc":{"id":"976d28ea-9419-53bb-8c02-bc9bb3d80c0b","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>etcd 通过 put 和 delete 实现队列操作：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">PUT\nexample/queue/1679209937014545013\nvalue-0\nDELETE\nexample/queue/1679209937014545013</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_入队\">入队</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-go\" data-lang=\"go\">func enqueue(q *recipe.Queue, wg *sync.WaitGroup) {\n\tfor i := 0; i &lt; 60; i++ {\n\t\ttime.Sleep(1 * time.Second)\n\t\tif err := q.Enqueue(fmt.Sprintf(\"value-%d\", i)); err != nil { <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\t\t\tlog.Fatal(err)\n\t\t}\n\t}\n\tq.Enqueue(\"stop\")\n\tq.Enqueue(\"stop\")\n\twg.Done()\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>将值放入队列中</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>etcd 操作基本过程：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>以指定前缀和纳秒单位的时间戳做为 key；</p>\n</li>\n<li>\n<p>通过事务 <code>Txn</code> 比较 key version 保证 key 唯一，key 冲突时时生成新 key 并重试。</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_出队\">出队</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-go\" data-lang=\"go\">func dequeue(q *recipe.Queue, id int, wg *sync.WaitGroup) {\n\tfor {\n\t\tval, err := q.Dequeue() <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\t\tif err != nil {\n\t\t\tlog.Fatal(err)\n\t\t}\n\t\tlog.Printf(\"goroutine %d: %s\", id, val)\n\n\t\tif val == \"stop\" {\n\t\t\tbreak\n\t\t}\n\t}\n\twg.Done()\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>从队列中取出值</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>etcd 操作基本过程：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>先查询指定前缀的第一值 key；</p>\n</li>\n<li>\n<p>删除成功则出队成功，失败则重试；</p>\n</li>\n<li>\n<p>key 不存在时 watch。</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_main\">main</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-go\" data-lang=\"go\">package main\n\nimport (\n\t// ...\n\tclientv3 \"go.etcd.io/etcd/client/v3\"\n\trecipe \"go.etcd.io/etcd/client/v3/experimental/recipes\"\n)\n\nconst (\n\tKEY_PREFIX = \"example/queue\"\n)\n\nvar url = flag.String(\"url\", \"http://127.0.0.1:2379\", \"the etcd address to connect to\")\n\nfunc main() {\n\tflag.Parse()\n\n\tcli, err := clientv3.NewFromURL(*url) <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\tif err != nil {\n\t\tlog.Fatalf(\"new etcd client: %v\", err)\n\t}\n\tdefer cli.Close()\n\n\tq := recipe.NewQueue(cli, KEY_PREFIX) <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\tvar wg sync.WaitGroup\n\n\twg.Add(1)\n\tgo enqueue(q, &amp;wg)\n\twg.Add(1)\n\tgo dequeue(q, 1, &amp;wg)\n\twg.Add(1)\n\tgo dequeue(q, 2, &amp;wg)\n\twg.Wait()\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>创建 client 对象；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>创建队列对象。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>","document":{"title":"etcd go client 队列"},"pageAttributes":{"slug":"distribution-etcd-queue","category":"distribution"},"revision":{"date":"2023-03-19","number":"1.0"}}},"pageContext":{"id":"976d28ea-9419-53bb-8c02-bc9bb3d80c0b","pageAttributes__slug":"distribution-etcd-queue","__params":{"pageAttributes__slug":"distribution-etcd-queue"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}