{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/postgresql-queue/","result":{"data":{"asciidoc":{"id":"090286b5-3869-5db5-835e-a7c245e993e6","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>使用 PostgreSQL 作为消息队列</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_创建表\"><a class=\"anchor\" href=\"#_创建表\"></a>创建表</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">CREATE TABLE queues (\n    id BIGSERIAL PRIMARY KEY,\n    name CHARACTER VARYING(255) NOT NULL DEFAULT 'default', <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n    created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT now(),\n    updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT now(),\n    payload JSONB NOT NULL <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n);</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>队列名称</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>队列数据，存储为 JSON 格式</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_发送\"><a class=\"anchor\" href=\"#_发送\"></a>发送</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>通过插入数据发送新消息。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">INSERT INTO queues (payload) SELECT ('{\"data\":' || text(generate_series(1,1000)) || '}')::jsonb;</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_接收\"><a class=\"anchor\" href=\"#_接收\"></a>接收</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_查询消息\"><a class=\"anchor\" href=\"#_查询消息\"></a>查询消息</h3>\n<div class=\"paragraph\">\n<p>通过行锁避免获取重复消息。</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>终端 1:</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">BEGIN; <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nSELECT * FROM queues LIMIT 2 FOR UPDATE SKIP LOCKED; <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n--  id |  name   |         created_at         |         updated_at         |   payload\n-- ----+---------+----------------------------+----------------------------+-------------\n--   1 | default | 2022-06-22 15:34:43.671852 | 2022-06-22 15:34:43.671852 | {\"data\": 1}\n--   2 | default | 2022-06-22 15:34:43.671852 | 2022-06-22 15:34:43.671852 | {\"data\": 2}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>开始事务</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>通过 <code>FOR UPDATE</code> 锁定行，<code>SKIP LOCKED</code> 跳过被锁定的行</td>\n</tr>\n</table>\n</div>\n</li>\n<li>\n<p>终端 2</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">BEGIN; <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nSELECT * FROM queues LIMIT 2 FOR UPDATE SKIP LOCKED; <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n--  id |  name   |         created_at         |         updated_at         |   payload\n-- ----+---------+----------------------------+----------------------------+-------------\n--   3 | default | 2022-06-22 15:34:43.671852 | 2022-06-22 15:34:43.671852 | {\"data\": 3}\n--   4 | default | 2022-06-22 15:34:43.671852 | 2022-06-22 15:34:43.671852 | {\"data\": 4}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>开始事务</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>查询结果中，跳过了被锁定的行</td>\n</tr>\n</table>\n</div>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>通过事务锁定行，消费后解除锁定。</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_删除已消费消息\"><a class=\"anchor\" href=\"#_删除已消费消息\"></a>删除已消费消息</h3>\n<div class=\"paragraph\">\n<p>消费成功后，需要删除消息。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">DELETE FROM queues WHERE id = $id;\nCOMMIT;</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>消费成功后提交事务，消费失败则回滚。</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><a href=\"https://www.crunchydata.com/blog/message-queuing-using-native-postgresql\" class=\"bare\">https://www.crunchydata.com/blog/message-queuing-using-native-postgresql</a>\n<a href=\"https://github.com/QueueClassic/queue_classic\" class=\"bare\">https://github.com/QueueClassic/queue_classic</a></p>\n</div>\n</div>\n</div>","document":{"title":"使用 PostgreSQL 作为消息队列"},"pageAttributes":{"slug":"postgresql-queue","category":"database"},"revision":{"date":"2022-06-22","number":"1.0"}}},"pageContext":{"id":"090286b5-3869-5db5-835e-a7c245e993e6","pageAttributes__slug":"postgresql-queue","__params":{"pageAttributes__slug":"postgresql-queue"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}