{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/go-grpc-up-and-running-start/","result":{"data":{"asciidoc":{"id":"cbc9135d-eb4e-559d-a41b-c7a66cbd1d90","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>go 1.16.2</p>\n</li>\n<li>\n<p>protoc 3.15.6</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>《gRPC 与云原生应用开发》示例代码与当前版本有些许变化。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_安装\"><a class=\"anchor\" href=\"#_安装\"></a>安装</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># manjaro\nsudo pacman -S protobuf\n\ngo get -u google.golang.org/protobuf/cmd/protoc-gen-go\ngo get -u google.golang.org/grpc/cmd/protoc-gen-go-grpc</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_目录结构\"><a class=\"anchor\" href=\"#_目录结构\"></a>目录结构</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">ch02/productinfo/proto/product_info.proto\n\nch02/productinfo/go/go.sum\nch02/productinfo/go/go.mod\n\nch02/productinfo/go/ecommerce/product_info_grpc.pb.go\nch02/productinfo/go/ecommerce/product_info.pb.go\n\nch02/productinfo/go/client/main.go\nch02/productinfo/go/server/main.go</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_依赖\"><a class=\"anchor\" href=\"#_依赖\"></a>依赖</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>在 <code>ch02/productinfo/go</code> 目录下执行：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">go mod init productinfo\n\ngo get google.golang.org/grpc@latest\ngo get github.com/gofrs/uuid@latest\ngo get google.golang.org/protobuf@latest</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_protocol_buffers\"><a class=\"anchor\" href=\"#_protocol_buffers\"></a>Protocol Buffers</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>新建文件 <code>ch02/productinfo/proto/product_info.proto</code> ：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-protobuf\" data-lang=\"protobuf\">syntax = \"proto3\";\n\npackage ecommerce;\n\n// NOTE 需要添加 go_package\noption go_package = \"productinfo/ecommerce\";\n\nservice ProductInfo {\n  rpc addProduct(Product) returns (ProductID);\n  rpc getProduct(ProductID) returns (Product);\n}\n\nmessage Product {\n  string id = 1;\n  string name = 2;\n  string description = 3;\n}\n\nmessage ProductID {\n  string value = 1;\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>需要添加 go_package</p>\n</li>\n</ul>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_生成代码\"><a class=\"anchor\" href=\"#_生成代码\"></a>生成代码</h3>\n<div class=\"paragraph\">\n<p>在 <code>ch02/productinfo/go</code> 目录下执行</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">protoc --go_out=ecommerce \\\n       --go_opt=paths=source_relative \\\n       --go-grpc_out=ecommerce \\\n       --go-grpc_opt=paths=source_relative \\\n       -I ../proto product_info.proto</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_server\"><a class=\"anchor\" href=\"#_server\"></a>Server</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>新建文件 <code>ch02/productinfo/go/server/main.go</code> ：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-go\" data-lang=\"go\">package main\n\nimport (\n  \"context\"\n  \"log\"\n  \"net\"\n  pb \"productinfo/ecommerce\"\n\n  \"github.com/gofrs/uuid\"\n  \"google.golang.org/grpc\"\n  \"google.golang.org/grpc/codes\"\n  \"google.golang.org/grpc/status\"\n)\n\ntype server struct {\n  productMap map[string]*pb.Product\n  // NOTE 需要添加 unimplementedproductinfoserver\n  pb.UnimplementedProductInfoServer\n}\n\nfunc (s *server) AddProduct(ctx context.Context, in *pb.Product) (*pb.ProductID, error) {\n  out, err := uuid.NewV4()\n  if err != nil {\n    return nil, status.Errorf(codes.Internal, \"Error while generating Product ID\", err)\n  }\n\n  in.Id = out.String()\n  if s.productMap == nil {\n    s.productMap = make(map[string]*pb.Product)\n  }\n  s.productMap[in.Id] = in\n\n  return &amp;pb.ProductID{Value: in.Id}, status.New(codes.OK, \"\").Err()\n}\n\nfunc (s *server) GetProduct(ctx context.Context, in *pb.ProductID) (*pb.Product, error) {\n  value, exists := s.productMap[in.Value]\n  if exists {\n    return value, status.New(codes.OK, \"\").Err()\n  }\n\n  return nil, status.Errorf(codes.NotFound, \"Product does not exist.\", in.Value)\n}\n\nconst (\n  port = \":50051\"\n)\n\nfunc main() {\n  lis, err := net.Listen(\"tcp\", port)\n  if err != nil {\n    log.Fatalf(\"failed to listen: %v\", err)\n  }\n  s := grpc.NewServer()\n  pb.RegisterProductInfoServer(s, &amp;server{})\n\n  log.Printf(\"Starting gRPC listener o port \" + port)\n  if err := s.Serve(lis); err != nil {\n    log.Fatalf(\"failed to serve: %v\", err)\n  }\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>需要添加 unimplementedproductinfoserver</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_client\"><a class=\"anchor\" href=\"#_client\"></a>Client</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>新建文件 <code>ch02/productinfo/go/client/main.go</code> ：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-go\" data-lang=\"go\">package main\n\nimport (\n  \"context\"\n  \"log\"\n  \"time\"\n\n  pb \"productinfo/ecommerce\"\n\n  \"google.golang.org/grpc\"\n)\n\nconst (\n  address = \":50051\"\n)\n\nfunc main() {\n  conn, err := grpc.Dial(address, grpc.WithInsecure())\n  if err != nil {\n    log.Fatalf(\"did not connect: %v\", err)\n  }\n  defer conn.Close()\n\n  c := pb.NewProductInfoClient(conn)\n\n  ctx, cancel := context.WithTimeout(context.Background(), time.Second)\n  defer cancel()\n\n  name := \"Apple iPhone 11\"\n  description := \"Meet Apple iPhone 11. All-new dual-camera system with Ultra Wide and Night mode.\"\n  r, err := c.AddProduct(ctx, &amp;pb.Product{Name: name, Description: description})\n  if err != nil {\n    log.Fatalf(\"Could not add product: %v\", err)\n  }\n  log.Printf(\"Product ID : %s added successfully\", r.Value)\n\n  product, err := c.GetProduct(ctx, &amp;pb.ProductID{Value: r.Value})\n  if err != nil {\n    log.Fatalf(\"Could not get product: %v\", err)\n  }\n  log.Printf(\"Product %v\", product.String())\n}</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>《gRPC 与云原生应用开发》</p>\n</li>\n<li>\n<p><a href=\"https://github.com/grpc-up-and-running/samples.git\" class=\"bare\">https://github.com/grpc-up-and-running/samples.git</a></p>\n</li>\n<li>\n<p><a href=\"https://grpc.io/docs/languages/go/quickstart/\" class=\"bare\">https://grpc.io/docs/languages/go/quickstart/</a></p>\n</li>\n<li>\n<p><a href=\"https://developers.google.com/protocol-buffers/docs/reference/go-generated#package\" class=\"bare\">https://developers.google.com/protocol-buffers/docs/reference/go-generated#package</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/grpc/grpc-go/issues/3669\" class=\"bare\">https://github.com/grpc/grpc-go/issues/3669</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/grpc/grpc-go/issues/3794\" class=\"bare\">https://github.com/grpc/grpc-go/issues/3794</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"《gRPC 与云原生应用开发》开发环境"},"pageAttributes":{"slug":"go-grpc-up-and-running-start","category":"grpc"},"revision":{"date":"2021-03-31","number":"1.0"}}},"pageContext":{"id":"cbc9135d-eb4e-559d-a41b-c7a66cbd1d90","pageAttributes__slug":"go-grpc-up-and-running-start","__params":{"pageAttributes__slug":"go-grpc-up-and-running-start"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}