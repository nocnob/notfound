{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/distribution-paxos-basic/","result":{"data":{"asciidoc":{"id":"ed1365ce-b402-50ef-94b0-612f6cffdb17","html":"<div class=\"sect1\">\n<h2 id=\"_角色\">角色</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>客户端 (Client): 客户端向分布式系统发送一个请求，并等待响应。</p>\n</li>\n<li>\n<p>提议者 (Proposer)：收到客户端的请求后，提出相关提案。</p>\n</li>\n<li>\n<p>接受者 (Acceptor): 投票接受或拒绝提议者的提案，若超过半数的接受者接受提案，则该提案被批准。</p>\n</li>\n<li>\n<p>学习者 (Learner): 学习被批准的提案，不参与决议提案。</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_过程\">过程</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>两个阶段:</p>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>第一阶段</p>\n<div class=\"olist loweralpha\">\n<ol class=\"loweralpha\" type=\"a\">\n<li>\n<p>phase 1a (Prepare 阶段)，Proposer 向 Acceptor 发送 RPC 请求，请求中仅包含提案编号</p>\n</li>\n<li>\n<p>phase 1b (Promise 阶段)，Acceptor 向 Proposer 返回 RPC 响应，同意或者拒绝提案</p>\n</li>\n</ol>\n</div>\n</li>\n<li>\n<p>第二阶段</p>\n<div class=\"olist loweralpha\">\n<ol class=\"loweralpha\" type=\"a\">\n<li>\n<p>phase 2a (Accept 或 Propose 阶段)，Proposer 向 Acceptor 发送 RPC 请求，请求中包含提案编号和提案值</p>\n</li>\n<li>\n<p>phase 2b (Accepted 阶段)，Acceptor 向 Proposer 返回 RPC 响应，接受或者拒绝提案值</p>\n</li>\n</ol>\n</div>\n</li>\n</ol>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-plantuml\" data-lang=\"plantuml\">@startuml\nstart\n:Proposer 提出提案\\n(仅提案编号);\n:Acceptor 投票;\n\nif (Proposer 判断是否有超半数 Acceptor 同意？) then (yes)\n    :Proposer 发送提案\\n(提案编号和值);\n    :Acceptor 接受提案;\n\n    if (超半数 Acceptor 接受？) then (yes)\n    :批准提案;\n    else (no)\n    :未批准提案;\n    endif;\nelse (no)\n    :拒绝提案;\nendif\nstop\n@enduml</code></pre>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_时序图\">时序图</h3>\n<div class=\"paragraph\">\n<p>提案编号: <code>n.server_id</code></p>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_客户端无并发提案发送到所有节点\">客户端无并发，提案发送到所有节点</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-plantuml\" data-lang=\"plantuml\">@startuml\nparticipant Client as c\nparticipant \"Proposer 2\" as p\nparticipant \"Acceptor 1\" as a1\nparticipant \"Acceptor 2\" as a2\nparticipant \"Acceptor 3\" as a3\nparticipant \"Learner x\" as lx\n\nactivate c\nc -&gt; p : send(x)\nactivate p\nnote right p\n    id=1\n    &lt;font color=red&gt;round=1\n    &lt;font color=red&gt;number=1\nend note\n\np -&gt; a1 : Prepare(n=1.2)\nactivate a1\np -&gt; a2 : Prepare(n=1.2)\nactivate a2\np -&gt; a3 : Prepare(n=1.2)\nactivate a3\nnote right a3\n    id=3\n    &lt;font color=red&gt;minProposal=1\n    acceptedNumber=0\n    acceptedValue=nil\nend note\n\np &lt;-- a1 : Promise(n=1.2)\ndeactivate a1\np &lt;-- a2 : Promise(n=1.2)\ndeactivate a2\np &lt;-- a3 : Promise(n=1.2)\ndeactivate a3\n\np -&gt; a1 : Accept(n=1.2, v=x)\nactivate a1\np -&gt; a2 : Accept(n=1.2, v=x)\nactivate a2\np -&gt; a3 : Accept(n=1.2, v=x)\nactivate a3\nnote right a3\n    id=3\n    minProposal=1\n    &lt;font color=red&gt;acceptedNumber=1\n    &lt;font color=red&gt;acceptedValue=x\nend note\np &lt;-- a1 : Accepted(n=1.2, v=x)\n    a1 -&gt; lx\n    activate lx\n    a1 &lt;-- lx\n    deactivate lx\ndeactivate a1\np &lt;-- a2 : Accepted(n=1.2, v=x)\n    a2 -&gt; lx\n    activate lx\n    a2 &lt;-- lx\n    deactivate lx\ndeactivate a2\np &lt;-- a3 : Accepted(n=1.2, v=x)\n    a3 -&gt; lx\n    activate lx\n    a3 &lt;-- lx\n    deactivate lx\ndeactivate a3\n\nc &lt;-- p\ndeactivate p\ndeactivate c\n@enduml</code></pre>\n</div>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>提议者收到客户端的请求后，选择一个最新的提案编号 n（n 单调递增），向超过半数的接受者发送该编号；</p>\n</li>\n<li>\n<p>接受者检查提案编号，如果 n 大于之前接受的所有提案编号，返回 Promise 并承诺不再接受任何编号小于 n 的提案；</p>\n</li>\n<li>\n<p>提议者收到超过半数的接受者 Promise 响应后，向接受者发起 Accept(n, x) 请求，请求包括提案编号 n 和提案值 x；</p>\n</li>\n<li>\n<p>接受者收到 Accept 请求后，如果这个期间没有另外承诺提案编号比 n 更大的提案，则接受该提案。</p>\n</li>\n</ol>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_客户端无并发提案发送到半数以上节点\">客户端无并发，提案发送到半数以上节点</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-plantuml\" data-lang=\"plantuml\">@startuml\nparticipant Client as c\nparticipant \"Proposer 1\" as p1\nparticipant \"Proposer 2\" as p2\nparticipant \"Acceptor 1\" as a1\nparticipant \"Acceptor 2\" as a2\nparticipant \"Acceptor 3\" as a3\nparticipant \"Learner x\" as lx\n\nactivate c\nc -&gt; p1 : send(x)\nactivate p1\n\nnote right p1: id=1\\n&lt;font color=red&gt;round=1\\n&lt;font color=red&gt;number=1\np1 -&gt; a1 : Prepare(n=1)\nactivate a1\np1 -&gt; a2 : Prepare(n=1)\nactivate a2\np1 &lt;-- a1 : Promise(n=1)\ndeactivate a1\np1 &lt;-- a2 : Promise(n=1)\ndeactivate a2\nnote right a2: id=2\\n&lt;font color=red&gt;minProposal=1\\nacceptedNumber=0\\nacceptedValue=nil\n\np1 -&gt; a1 : Accept(n=1, v=x)\nactivate a1\np1 -&gt; a2 : Accept(n=1, v=x)\nactivate a2\np1 &lt;-- a1 : Accepted(n=1, v=x)\na1 -&gt; lx\nactivate lx\na1 &lt;-- lx\ndeactivate lx\ndeactivate a1\np1 &lt;-- a2 : Accepted(n=1, v=x)\na2 -&gt; lx\nactivate lx\na2 &lt;-- lx\ndeactivate lx\ndeactivate a2\nnote right a2: id=2\\nminProposal=1\\n&lt;font color=red&gt;acceptedNumber=1\\n&lt;font color=red&gt;acceptedValue=x\n\nc &lt;-- p1\ndeactivate p1\n\nc --&gt; p2 : send(y)\nactivate p2\n\nnote right p2: id=2\\n&lt;font color=red&gt;round=1\\n&lt;font color=red&gt;number=2\np2 -&gt; a2 : Prepare(n=2)\nactivate a2\np2 -&gt; a3 : Prepare(n=2)\nactivate a3\n\np2 &lt;-- a2 : &lt;font color=red&gt;Promise(n=2, n=1, v=x)\ndeactivate a2\nnote right a2: id=2\\n&lt;font color=red&gt;minProposal=2\\nacceptedNumber=1\\nacceptedValue=x\np2 &lt;-- a3 : Promise(n=2)\ndeactivate a3\nnote right a3: id=3\\n&lt;font color=red&gt;minProposal=2\\nacceptedNumber=0\\nacceptedValue=nil\n\np2 -&gt; a2 : &lt;font color=red&gt;Accept(n=2, v=x)\nactivate a2\np2 -&gt; a3 : &lt;font color=red&gt;Accept(n=2, v=x)\nactivate a3\np2 &lt;-- a2 : Accepted(n=2, v=x)\ndeactivate a2\np2 &lt;-- a3 : Accepted(n=2, v=x)\ndeactivate a3\nc &lt;-- p2\ndeactivate p2\nnote right a3: id=3\\nminProposal=2\\n&lt;font color=red&gt;acceptedNumber=2\\n&lt;font color=red&gt;acceptedValue=x\n@enduml</code></pre>\n</div>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>发送 x 时，Accetpor 3 数据未同步；</p>\n</li>\n<li>\n<p>发送 y 时，Acceptor 2 领先 Acceptor 3 ，所以第一阶段 Acceptor 2 返回了当前提案编号 n+1、前一次提案编号 n 和值 x；</p>\n</li>\n<li>\n<p>使用当前提案编号 n+1 和前一次提案值 x 发送 Accept 请求，之后 Acceptor 3  和其他节点数据保持一致。</p>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>send(y) 被批准但使用的是上一次的提案值 x。</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://book.douban.com/subject/35794814/\">《深入理解分布式系统》</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Basic Paxos 基本流程"},"pageAttributes":{"slug":"distribution-paxos-basic","category":"distribution"},"revision":{"date":"2023-01-20","number":"1.0"}}},"pageContext":{"id":"ed1365ce-b402-50ef-94b0-612f6cffdb17","pageAttributes__slug":"distribution-paxos-basic","__params":{"pageAttributes__slug":"distribution-paxos-basic"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}