{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/linux-nftables-start/","result":{"data":{"asciidoc":{"id":"d41c4f6c-2f25-50f8-865e-dae2b083e520","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>操作系统: Ubuntu 22.04</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p><code>nftables</code> 框架对数据包进行分类，它是 <code>iptables</code>、<code>ip6tables</code>、<code>arptables</code>、<code>ebtables</code> 和 <code>ipset</code> 实用程序的后续者。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_启动\">启动</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>nftables 通过 systemd 管理，配置文件路径 <code>/etc/nftables.conf</code>。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 查看 systemd 配置\nsystemctl cat nftables.service\n# 查看服务状态\nsystemctl status nftables.service\n# 启动服务\nsudo systemctl start nftables.service\n# 设置服务为开机启动\nsudo systemctl enable nftables.service</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p><code>nftables</code> 支持 <code>nft</code> 命令和 <code>nftables</code> 脚本，默认配置文件 <code>/etc/nftables.conf</code> 就是一个可执行的 <code>nftables</code> 脚本：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/etc/nftables.conf</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nft\" data-lang=\"nft\">#!/usr/sbin/nft -f\n\nflush ruleset <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\ntable inet filter { <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\tchain input { <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n\t\ttype filter hook input priority 0; <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\n\t}\n\tchain forward {\n\t\ttype filter hook forward priority 0;\n\t}\n\tchain output {\n\t\ttype filter hook output priority 0;\n\t}\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>清空规则集</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>创建表</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>创建链</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_netfilter\">Netfilter</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><a href=\"https://www.netfilter.org/index.html\">netfilter</a> 为 Linux 内核提供了包过滤功能，nftables 是 netfilter 的一部分。</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/nf-hooks.svg\" alt=\"nf hooks\">\n</div>\n<div class=\"title\">Figure 1. Netfilter hooks into Linux networking packet flows (<a href=\"https://wiki.nftables.org/wiki-nftables/index.php/Netfilter_hooks\">图片来源</a>)</div>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<caption class=\"title\">Table 1. address families</caption>\n<colgroup>\n<col style=\"width: 50%;\">\n<col style=\"width: 50%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">地址族</th>\n<th class=\"tableblock halign-left valign-top\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">netdev</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">匹配处理入口和出口的数据包</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">inet</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">匹配 IPv4 和 IPv6 数据包</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">仅匹配 IPv4 数据包，默认值</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip6</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">仅匹配 IPv6 数据包</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">bridge</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">匹配通过网桥设备的数据包</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">arp</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">匹配 IPv4 地址解析协议(ARP)数据包</p></td>\n</tr>\n</tbody>\n</table>\n<table class=\"tableblock frame-all grid-all stretch\">\n<caption class=\"title\">Table 2. hook</caption>\n<colgroup>\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3334%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">hook</th>\n<th class=\"tableblock halign-left valign-top\">地址族</th>\n<th class=\"tableblock halign-left valign-top\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ingress</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip/ip6/inet/netdev</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">所有进入系统的数据包都由这个钩子处理。它在第 3 层协议处理程序之前被调用，因此在 prerouting hook 之前被调用，并且它可以用于过滤和监管。Ingress 仅适用于 Inet 族（从 Linux 内核 5.10 起）。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">prerouting</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip/ip6/inet</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">所有进入系统的数据包都由 prerouting hook 处理，在路由过程之前调用。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">input</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip/ip6/inet/arp</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">传送到本地系统的数据包由 input hook 处理。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">output</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip/ip6/inet/arp</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">本地进程发送的数据包由 output hook 处理。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">forward</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip/ip6/inet</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">转发到不同主机的数据包由 forward hook 处理。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">postrouting</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip/ip6/inet</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">离开系统的所有数据包都由 postrouting hook 处理。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">egress</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">netdev</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">所有离开系统的数据包都由这个钩子处理。它在第 3 层协议处理程序之后和 tc engress 之前被调用。它可用于后期过滤和监管。</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_操作\">操作</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>nftables 中的表是一个包含链、规则、集合和其他对象集合的名字空间。</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_表\">表</h3>\n<div class=\"paragraph\">\n<p>创建表的语法如下：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nft\" data-lang=\"nft\">table &lt;table_address_family&gt; &lt;table_name&gt; {\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>等同于命令行：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft add table &lt;table_address_family&gt; &lt;table_name&gt;</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>table_address_family</code> 以下值其中之一: <code>netdev</code>, <code>inet</code>, <code>ip</code>, <code>ip6</code>,  <code>bridge</code>, <code>arp</code></p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>删除表：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft delete table &lt;table_address_family&gt; &lt;table_name&gt;</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_链\">链</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nft\" data-lang=\"nft\">chain &lt;chain_name&gt; {\n  type &lt;type&gt; hook &lt;hook&gt; priority &lt;priority&gt;\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>等同于：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft add chain &lt;table_address_family&gt; &lt;table_name&gt; &lt;chain_name&gt; \\\n\t{ type &lt;type&gt; hook &lt;hook&gt; priority &lt;priority&gt; \\; policy &lt;policy&gt; \\; }</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>参数说明：</p>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<caption class=\"title\">Table 3. 参数 &lt;type&gt;</caption>\n<colgroup>\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">类型</th>\n<th class=\"tableblock halign-left valign-top\">地址族</th>\n<th class=\"tableblock halign-left valign-top\">Hooks</th>\n<th class=\"tableblock halign-left valign-top\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">filter</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">arp, bridge, ip, ip6 and inet</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">all</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">标准链类型</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">nat</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip, ip6, inet</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">prerouting, input, output, postrouting</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">这个类型的链根据连接跟踪条目执行原生地址转换。只有第一个数据包遍历此链类型。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">route</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip, ip6</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">output</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">如果 IP 标头的相关部分已更改，则遍历此链类型的数据包会导致新的路由查找</p></td>\n</tr>\n</tbody>\n</table>\n<table class=\"tableblock frame-all grid-all stretch\">\n<caption class=\"title\">Table 4. 参数 &lt;priority&gt;</caption>\n<colgroup>\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">名称</th>\n<th class=\"tableblock halign-left valign-top\">值</th>\n<th class=\"tableblock halign-left valign-top\">地址族</th>\n<th class=\"tableblock halign-left valign-top\">Hooks</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">raw</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">-300</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip, ip6, inet</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">all</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">mangle</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">-150</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip, ip6, inet</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">all</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\" rowspan=\"2\"><p class=\"tableblock\">dstnat</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">-100</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip, ip6, inet</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">prerouting</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">-300</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">bridge</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">prerouting</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\" rowspan=\"2\"><p class=\"tableblock\">filter</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">0</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip, ip6, inet, arp, netdev</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">all</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">-200</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">bridge</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">all</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">security</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">50</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip, ip6, inet</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">all</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\" rowspan=\"2\"><p class=\"tableblock\">srcnat</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">100</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ip, ip6, inet</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">postrouting</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">300</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">bridge</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">postrouting</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">out</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">100</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">bridge</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">output</p></td>\n</tr>\n</tbody>\n</table>\n<table class=\"tableblock frame-all grid-all stretch\">\n<caption class=\"title\">Table 5. 参数 &lt;policy&gt;</caption>\n<colgroup>\n<col style=\"width: 50%;\">\n<col style=\"width: 50%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">policy</th>\n<th class=\"tableblock halign-left valign-top\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">accept</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">接受</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">drop</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">丢弃</p></td>\n</tr>\n</tbody>\n</table>\n<div class=\"paragraph\">\n<p>删除：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft delete chain &lt;table_name&gt; &lt;chain_name&gt;</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_规则\">规则</h3>\n<div class=\"paragraph\">\n<p>添加:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft add rule &lt;table_address_family&gt; &lt;table_name&gt; &lt;chain_name&gt; &lt;rule&gt;</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>删除：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 查看 handle\nnft --handle list chain &lt;table_address_family&gt; &lt;table_name&gt; &lt;chain_name&gt;\nnft delete rule &lt;table_address_family&gt; &lt;table_name&gt; &lt;chain_name&gt; handle &lt;handle&gt;</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_示例\">示例</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_备份和恢复\">备份和恢复</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 显示 nftables 规则集\nnft list ruleset\n# 备份\nnft list ruleset &gt; file.nft\n# 恢复\nnft -f file.nft\n# 清空\nnft flush ruleset</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_网络地址转换nat\">网络地址转换(NAT)</h3>\n<div class=\"paragraph\">\n<p>在 IP 数据包通过路由器或防火墙时重写来源 IP 地址或目的 IP 地址。</p>\n</div>\n<div class=\"paragraph\">\n<p>测试环境：</p>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<colgroup>\n<col style=\"width: 50%;\">\n<col style=\"width: 50%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">interface</th>\n<th class=\"tableblock halign-left valign-top\">IPv4</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">wlan0</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">192.168.0.3/24</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">eth0</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">192.168.1.3/24</p></td>\n</tr>\n</tbody>\n</table>\n<div class=\"paragraph\">\n<p>需要开启 Linux 转发功能：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 检查 net.ipv4.ip_forward 是否为开启\nsysctl -n net.ipv4.ip_forward\n# 配置\nsudo sysctl -w net.ipv4.ip_forward=1</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>或者修改文件 <code>/etc/sysctl.conf</code> 后执行 <code>sudo sysctl -p</code> 让配置生效：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">/etc/sysctl.conf</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-conf\" data-lang=\"conf\">net.ipv4.ip_forward=1</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_destination_natdnat\">Destination NAT(DNAT)</h3>\n<div class=\"paragraph\">\n<p>在 IP 数据包通过路由器或防火墙时重写目的 IP 地址。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nft\" data-lang=\"nft\">table ip nat {\n\tchain prerouting {\n\t\ttype nat hook prerouting priority dstnat; policy accept;\n\t\tiif \"wlan0\" tcp dport { 8080 } dnat to 192.168.1.3\n\t}\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>这将从接口 wlan0 (<code>iif</code>: Input interface index) 进入且 TCP 目标端口 8080 的流量重定向到 192.168.1.3。</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>命令行方式：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft add table nat\nnft 'add chain nat prerouting { type nat hook prerouting priority -100; }'\nnft 'add rule nat prerouting iif wlan0 tcp dport { 80, 443, 8080 } dnat to 192.168.1.3'</code></pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_测试\">测试</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 服务端\nruby -run -e httpd -- --bind-address=192.168.1.3 --port=8080 /tmp</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>启动 HTTP 服务并绑定 IP 192.168.1.3 和端口 8080</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>另一台主机做为客户端访问 <a href=\"http://192.168.0.3:8080\" class=\"bare\">http://192.168.0.3:8080</a> ，可正常访问到服务端</p>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_问题\">问题</h4>\n<div class=\"paragraph\">\n<p>这里的目标设置为 <code>127.0.0.1</code> 不会生效，需要修改 (<a href=\"https://serverfault.com/questions/1021798/how-to-redirect-requests-on-port-80-to-localhost3000-using-nftables\">参考</a>)：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo sysctl -w net.ipv4.conf.wlan0.route_localnet=1</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_redirectdnat\">Redirect(DNAT)</h3>\n<div class=\"paragraph\">\n<p>将 IP 数据包重定向到本机的另一个端口，重定向是 DNAT 的特例。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nft\" data-lang=\"nft\">table ip nat {\n\tchain prerouting {\n\t\ttype nat hook prerouting priority dstnat; policy accept;\n\t\ttcp dport 8081 redirect to :8080\n\t}\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>命令行方式：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft add table nat\nnft 'add chain nat prerouting { type nat hook prerouting priority -100; }'\nnft add rule nat prerouting tcp dport 8081 redirect to 8080</code></pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_测试_2\">测试</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">ruby -run -e httpd -- --bind-address=192.168.0.3 --port=8080 /tmp</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>启动 HTTP 服务并绑定 IP 192.168.0.3 和端口 8080</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>另一台主机做为客户端访问 <a href=\"http://192.168.0.3:8081\" class=\"bare\">http://192.168.0.3:8081</a> ，可正常访问到服务端</p>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_限制_ping_请求速率\">限制 ping 请求速率</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nft\" data-lang=\"nft\">table ip filter {\n\tchain input {\n\t\ttype filter hook input priority filter; policy accept;\n\t\ticmp type echo-request limit rate 10/second accept <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\t\ticmp type echo-request limit rate over 10/second drop <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\t}\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>此规则与低于10/秒速率的数据包匹配，接受；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>此规则与高于10/秒速率的数据包匹配，丢弃。</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>命令行方式：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft add table filter\nnft 'add chain filter input { type filter hook input priority 0; }'\nnft add rule filter input icmp type echo-request limit rate 10/second accept\nnft add rule filter input icmp type echo-request limit rate over 10/second drop</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>可在相同主机测试：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 并发执行多条\nping 192.168.1.3 -i 0.2</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>每 0.2 秒发送一条请求，请求频率过高，会存在丢包</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_限制数据传输速率\">限制数据传输速率</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nft\" data-lang=\"nft\">table ip filter {\n\tchain input {\n\t\ttype filter hook input priority filter; policy accept;\n\t\tlimit rate 1 mbytes/second accept <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\t\tlimit rate over 1 mbytes/second drop <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\t}\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>此规则与低于 1 mbytes/秒速率的数据包匹配，接受；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>此规则与高于 1 mbytes/秒速率的数据包匹配，丢弃。</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>命令行方式：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft add table filter\nnft 'add chain filter input { type filter hook input priority 0; }'\nnft add rule filter input limit rate 1 mbytes/second accept\nnft add rule filter input limit rate over 1 mbytes/second drop</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_限制连接数\">限制连接数</h3>\n<div class=\"paragraph\">\n<p>限制连接数需要使用 <code>ct</code> (connection tracking, conntrack)。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nft\" data-lang=\"nft\">table ip filter {\n\tchain input {\n\t\ttype filter hook input priority filter; policy accept;\n\t\ttcp dport 22 ct count 3 accept <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\t\ttcp dport 22 ct count over 3 reject <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\t}\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>此规则与低于 3 个连接的数据包匹配，接受；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>此规则与高于 3 个连接的数据包匹配，拒绝。</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>命令行方式：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft add table filter\nnft 'add chain filter input { type filter hook input priority 0; policy accept; }'\nnft add rule filter input tcp dport 22 ct count 3 accept\nnft add rule filter input tcp dport 22 ct count over 3 reject</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>连接超出限制时，会出现卡顿的现象。</p>\n</li>\n<li>\n<p>连接状态会保存一段时间。</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_禁止容器访问内网\">禁止容器访问内网</h3>\n<div class=\"paragraph\">\n<p>容器的网桥为 <code>docker0</code>，通过控制 <code>docker0</code> 可控制容器的网络。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nft\" data-lang=\"nft\">table ip filter {\n\tchain DOCKER-USER {\n\t\tiifname \"docker0\" ip daddr 192.168.0.4 accept <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\t\tiifname \"docker0\" ip daddr 192.168.0.0/24 drop <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\t}\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>匹配输入的接口名称(<code>iifname</code>: Input interface name)为 <code>docker 0</code> 且目标地址 <code>192.168.0.4</code>，接受；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>匹配输入的接口名称(<code>iifname</code>: Input interface name)为 <code>docker 0</code> 且目标地址 <code>192.168.0.4/24</code>，丢弃。</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>命令行方式：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft 'add rule filter DOCKER-USER iifname \"docker0\" ip daddr 192.168.0.4 accept'\nnft 'add rule filter DOCKER-USER iifname \"docker0\" ip daddr 192.168.0.0/24 drop'</code></pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_测试_3\">测试</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">docker run -d -i -t ubuntu:22.04 bash\napt update\napt install iputils-ping\n\n# 容器宿主机，通\nping 192.168.0.3\n# accept, 通\nping 192.168.0.4\n# drop, 不通\nping 192.168.0.5</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_外部请求转发到容器\">外部请求转发到容器</h3>\n<div class=\"paragraph\">\n<p>通过修改目标 IP 地址，将发送给宿主机请求转发到容器内。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-nft\" data-lang=\"nft\">table ip nat {\n\tchain DOCKER {\n\t\tiifname != \"docker0\" tcp dport 9090 dnat to 172.17.0.2:9090 <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\t}\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>匹配输入接口名称(Input interface name)不为 <code>docker0</code> 且目标端口为 <code>9090</code> 的请求，转发到容器内。</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>命令行方式：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">nft 'add rule ip nat DOCKER iifname != \"docker0\" tcp dport 9090 dnat to 172.17.0.2:9090'</code></pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_测试_4\">测试</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">docker run -d -i -t ubuntu:22.04 bash\napt update\napt install ruby\nruby -run -e httpd -- --bind-address=0.0.0.0 --port=9090 /tmp\n\n# 容器宿主机，通\ncurl http://192.168.0.3:9090\n# 其他机器，通\ncurl http://192.168.0.3:9090</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>man nft</p>\n</li>\n<li>\n<p><a href=\"https://access.redhat.com/docnft\" class=\"bare\">https://access.redhat.com/docnft</a>\numentation/zh-cn/red_hat_enterprise_linux/9/html/configuring_firewalls_and_packet_filters/getting-started-with-nftables_firewall-packet-filters</p>\n</li>\n<li>\n<p><a href=\"https://wiki.archlinuxcn.org/zh-hans/Nftables\" class=\"bare\">https://wiki.archlinuxcn.org/zh-hans/Nftables</a></p>\n</li>\n<li>\n<p><a href=\"https://jensd.be/1086/linux/forward-a-tcp-port-to-another-ip-or-port-using-nat-with-nftables\" class=\"bare\">https://jensd.be/1086/linux/forward-a-tcp-port-to-another-ip-or-port-using-nat-with-nftables</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.nftables.org/wiki-nftables/index.php/Main_Page\" class=\"bare\">https://wiki.nftables.org/wiki-nftables/index.php/Main_Page</a></p>\n</li>\n<li>\n<p><a href=\"https://docs.docker.com/network/iptables/\" class=\"bare\">https://docs.docker.com/network/iptables/</a></p>\n</li>\n<li>\n<p><a href=\"https://arthurchiao.art/blog/deep-dive-into-iptables-and-netfilter-arch-zh/\" class=\"bare\">https://arthurchiao.art/blog/deep-dive-into-iptables-and-netfilter-arch-zh/</a></p>\n</li>\n<li>\n<p><a href=\"https://arthurchiao.art/blog/conntrack-design-and-implementation-zh/\" class=\"bare\">https://arthurchiao.art/blog/conntrack-design-and-implementation-zh/</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Linux nftables 基本使用"},"pageAttributes":{"slug":"linux-nftables-start","category":"linux"},"revision":{"date":"2023-03-26","number":"1.0"}}},"pageContext":{"id":"d41c4f6c-2f25-50f8-865e-dae2b083e520","pageAttributes__slug":"linux-nftables-start","__params":{"pageAttributes__slug":"linux-nftables-start"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}