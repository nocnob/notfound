{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/postgresql-timestamp/","result":{"data":{"asciidoc":{"id":"a137c81a-55f1-5577-989f-4f59525c4dbc","html":"<div class=\"sect1\">\n<h2 id=\"_timestamp_with_time_zone\"><a class=\"anchor\" href=\"#_timestamp_with_time_zone\"></a>timestamp with time zone</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">SET TIME ZONE 'Asia/Shanghai'; <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nSHOW TIMEZONE; <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\nSELECT CURRENT_TIMESTAMP; <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n--        current_timestamp\n-- -------------------------------\n--  2022-07-17 22:04:51.014327+08\n-- (1 行记录)\n\nSET TIME ZONE 'UTC'; <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nSELECT CURRENT_TIMESTAMP; <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n--       current_timestamp\n---------------------------------\n-- 2022-07-17 14:04:51.015017+00</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>设置当前会话时区</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>查看时区</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>时间戳携带当前时区信息</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_timestamp_without_time_zone\"><a class=\"anchor\" href=\"#_timestamp_without_time_zone\"></a>timestamp without time zone</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">SET TIME ZONE 'Asia/Shanghai'; <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nSELECT CURRENT_TIMESTAMP::TIMESTAMP WITHOUT TIME ZONE, CURRENT_TIMESTAMP; <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n--      current_timestamp      |       current_timestamp\n-- ----------------------------+-------------------------------\n--  2022-07-17 22:13:00.745455 | 2022-07-17 22:13:00.745455+08\n\n\nSELECT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC')::TIMESTAMP WITHOUT TIME ZONE, CURRENT_TIMESTAMP; <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n--           timezone          |       current_timestamp\n-- ----------------------------+-------------------------------\n--  2022-07-17 14:35:31.766141 | 2022-07-17 22:35:31.766141+08\n\nSET TIME ZONE 'UTC'; <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nSELECT CURRENT_TIMESTAMP::TIMESTAMP WITHOUT TIME ZONE, CURRENT_TIMESTAMP; <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n--      current_timestamp      |       current_timestamp\n-- ----------------------------+-------------------------------\n--  2022-07-17 14:13:00.746729 | 2022-07-17 14:13:00.746729+00</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>设置当前会话时区</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>时区信息丢弃，值不会发生转换</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>通过 <code>AT TIME ZONE</code> 转换时区，然后再转换类型</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_测试\"><a class=\"anchor\" href=\"#_测试\"></a>测试</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">CREATE TABLE pg_time (\n    id SERIAL PRIMARY KEY,\n    name CHARACTER VARYING(255) NOT NULL,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP, <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n    updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n);\n\nSET TIME ZONE 'Asia/Shanghai';\nINSERT INTO pg_time(name) VALUES('Asia/Shanghai');\nSELECT * FROM pg_time ORDER BY id DESC LIMIT 1; <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n--  id |     name      |          created_at           |         updated_at\n-- ----+---------------+-------------------------------+----------------------------\n--   1 | Asia/Shanghai | 2022-07-17 22:23:49.659098+08 | 2022-07-17 22:23:49.659098\n\nSET TIME ZONE 'UTC';\nINSERT INTO pg_time(name) VALUES('UTC');\nSELECT * FROM pg_time ORDER BY id DESC LIMIT 1;\n--  id | name |          created_at           |         updated_at\n-- ----+------+-------------------------------+----------------------------\n--   2 | UTC  | 2022-07-17 14:24:23.926678+00 | 2022-07-17 14:24:23.926678\n\nSELECT * FROM pg_time WHERE id = 1; <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\n--  id |     name      |          created_at           |         updated_at\n-- ----+---------------+-------------------------------+----------------------------\n--   1 | Asia/Shanghai | 2022-07-17 14:23:49.659098+00 | 2022-07-17 22:23:49.659098</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td><code>created_at</code> 为 <code>TIMESTAMP WITH TIME ZONE</code></td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td><code>updated_at</code> 为 <code>TIMESTAMP WITHOUT TIME ZONE</code></td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td><code>created_at</code> 和 <code>updated_at</code> 使用 <code>CURRENT_TIMESTAMP</code> 生成，<code>updated_at</code> 直接丢弃了时区，值未进行转换</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>\n<td>修改会话时区后，<code>created_at</code> 时区自动转换，而 <code>updated_at</code> 值未发生变化，因为没有时区信息。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_时区设置\"><a class=\"anchor\" href=\"#_时区设置\"></a>时区设置</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">SELECT * FROM pg_timezone_names; <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\nALTER ROLE notfound SET timezone='UTC'; <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\nALTER ROLE notfound RESET timezone; <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n\nSELECT * FROM pg_db_role_setting; <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\n\nALTER DATABASE example_db SET timezone TO 'UTC';  <i class=\"conum\" data-value=\"5\"></i><b>(5)</b>\nALTER DATABASE example_db RESET timezone;  <i class=\"conum\" data-value=\"6\"></i><b>(6)</b></code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>查询时区名称</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>设置角色的时区</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>重置角色的时区</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>\n<td>查看角色设置</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"5\"></i><b>5</b></td>\n<td>设置数据库时区，角色时区优先于数据库时区</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"6\"></i><b>6</b></td>\n<td>重置数据库时区</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_rails\"><a class=\"anchor\" href=\"#_rails\"></a>Rails</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Rails 与 PostgreSQL timestamp</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">                                         数据表 \"public.articles\"\n    栏位    |              类型              | 校对规则 |  可空的  |                 预设\n------------+--------------------------------+----------+----------+--------------------------------------\n id         | bigint                         |          | not null | nextval('articles_id_seq'::regclass)\n title      | character varying              |          |          |\n body       | text                           |          |          |\n created_at | timestamp(6) without time zone |          | not null |\n updated_at | timestamp(6) without time zone |          | not null |\n索引：\n    \"articles_pkey\" PRIMARY KEY, btree (id)</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>created_at</code> 和 <code>updated_at</code> 默认使用 <code>timestamp(6) without time zone</code></p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">&gt; article.save\n  TRANSACTION (0.2ms)  BEGIN\n  Article Create (0.3ms)\n    INSERT INTO \"articles\" (\"title\", \"body\", \"created_at\", \"updated_at\")\n      VALUES ($1, $2, $3, $4)\n      RETURNING \"id\"  [[\"title\", \"Hello Rails\"], [\"body\", \"I am on Rails!\"],\n        [\"created_at\", \"2022-07-16 01:56:25.238458\"], [\"updated_at\", \"2022-07-16 01:56:25.238458\"]]\n  TRANSACTION (9.6ms)  COMMIT\n\n&gt; Time.now\n=&gt; 2022-07-16 09:56:28.085956916 +0800\n\n&gt; Article.last.created_at\n  Article Load (0.3ms)  SELECT \"articles\".* FROM \"articles\" ORDER BY \"articles\".\"id\" DESC LIMIT $1  [[\"LIMIT\", 1]]\n=&gt; Sat, 16 Jul 2022 01:56:25.238458000 UTC +00:00</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Rails 将时间戳转换到 UTC 时区后保存，读取时按照 UTC 时间读取</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_go\"><a class=\"anchor\" href=\"#_go\"></a>Go</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Go 与 PostgreSQL timestamp</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">CREATE TABLE pg_time (\n    id SERIAL PRIMARY KEY,\n    name CHARACTER VARYING(255) NOT NULL,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP, <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n    updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC') <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n);</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>携带时区，默认值为当前时间</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>不携带时区，且默认值为当前时间且转换到 UTC</td>\n</tr>\n</table>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">//\t\"github.com/jackc/pgx/v4\"\n\ntype PGTime struct {\n\tID        int\n\tName      string\n\tCreatedAt time.Time\n\tUpdatedAt time.Time\n}\n\nfunc (p *PGTime) String() string {\n\treturn fmt.Sprintf(\"id=%d,name=%s,createdAt=%s,updatedAt=%s\",\n\t\tp.ID, p.Name, p.CreatedAt.Local(), p.UpdatedAt.Local())\n}\n\nfunc main() {\n\tctx := context.Background()\n\n\t// postgres://postgres:123456@127.0.0.1:5432/example\n\tconn, err := pgx.Connect(ctx, os.Getenv(\"DATABASE_URL\"))\n\tif err != nil {\n\t\tlog.Fatalln(err)\n\t}\n\tdefer conn.Close(ctx)\n\n\tlog.Println(\"========== Asia/Shanghai\")\n\tconn.Exec(ctx, \"SET TIME ZONE 'Asia/Shanghai'\")\n\trun(ctx, conn)\n\n\tlog.Println(\"========== UTC\")\n\tconn.Exec(ctx, \"SET TIME ZONE 'UTC'\")\n\trun(ctx, conn)\n}\n\nfunc run(ctx context.Context, conn *pgx.Conn) {\n\tif _, err := conn.Exec(ctx, \"INSERT INTO pg_time(name) VALUES('def')\"); err != nil {\n\t\tlog.Fatalln(err)\n\t}\n\tPrintLast(ctx, conn)\n\n\tnow := time.Now()\n\tconn.Exec(ctx, \"INSERT INTO pg_time(name, created_at, updated_at) VALUES('now', $1, $2)\", now, now)\n\tPrintLast(ctx, conn)\n\n\tconn.Exec(ctx, \"INSERT INTO pg_time(name, created_at, updated_at) VALUES('utc', $1, $2)\", now, now.UTC())\n\tPrintLast(ctx, conn)\n}\n\nfunc PrintLast(ctx context.Context, conn *pgx.Conn) {\n\tvar pgTime PGTime\n\n\tconn.QueryRow(ctx, `\nSELECT id, name, created_at, updated_at FROM pg_time ORDER BY id DESC LIMIT 1`).\n\t\tScan(&amp;pgTime.ID, &amp;pgTime.Name, &amp;pgTime.CreatedAt, &amp;pgTime.UpdatedAt)\n\n\tlog.Println(pgTime.String())\n}</code></pre>\n</div>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">2022/07/17 22:56:52 ========== Asia/Shanghai\n2022/07/17 22:56:52 id=1,name=def,createdAt=2022-07-17 22:56:52.931521 +0800 CST,updatedAt=2022-07-17 22:56:52.931521 +0800 CST\n2022/07/17 22:56:52 id=2,name=now,createdAt=2022-07-17 22:56:52.946983 +0800 CST,updatedAt=2022-07-18 06:56:52.946983 +0800 CST\n2022/07/17 22:56:52 id=3,name=utc,createdAt=2022-07-17 22:56:52.946983 +0800 CST,updatedAt=2022-07-17 22:56:52.946983 +0800 CST\n2022/07/17 22:56:52 ========== UTC\n2022/07/17 22:56:52 id=4,name=def,createdAt=2022-07-17 22:56:52.951641 +0800 CST,updatedAt=2022-07-17 22:56:52.951641 +0800 CST\n2022/07/17 22:56:52 id=5,name=now,createdAt=2022-07-17 22:56:52.952978 +0800 CST,updatedAt=2022-07-18 06:56:52.952978 +0800 CST\n2022/07/17 22:56:52 id=6,name=utc,createdAt=2022-07-17 22:56:52.952978 +0800 CST,updatedAt=2022-07-17 22:56:52.952978 +0800 CST</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>id 2 和 id 5 中 updatedAt 出现错误，快了 8 个小时，保存时直接移除掉时区（东八区）而未转换，读取时按照 UTC 读取后转换到东八区（操作系统时区）</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">SELECT * FROM pg_time;\n id | name |          created_at           |         updated_at\n----+------+-------------------------------+----------------------------\n  1 | def  | 2022-07-17 22:56:52.931521+08 | 2022-07-17 14:56:52.931521\n  2 | now  | 2022-07-17 22:56:52.946983+08 | 2022-07-17 22:56:52.946983\n  3 | utc  | 2022-07-17 22:56:52.946983+08 | 2022-07-17 14:56:52.946983\n  4 | def  | 2022-07-17 22:56:52.951641+08 | 2022-07-17 14:56:52.951641\n  5 | now  | 2022-07-17 22:56:52.952978+08 | 2022-07-17 22:56:52.952978\n  6 | utc  | 2022-07-17 22:56:52.952978+08 | 2022-07-17 14:56:52.952978</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://www.postgresql.org/docs/current/datatype-datetime.html\" class=\"bare\">https://www.postgresql.org/docs/current/datatype-datetime.html</a></p>\n</li>\n<li>\n<p><a href=\"https://www.postgresql.org/docs/current/functions-datetime.html\" class=\"bare\">https://www.postgresql.org/docs/current/functions-datetime.html</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"PostgreSQL timestamp"},"pageAttributes":{"slug":"postgresql-timestamp","category":"database"},"revision":{"date":"2022-07-16","number":"1.0"}}},"pageContext":{"id":"a137c81a-55f1-5577-989f-4f59525c4dbc","pageAttributes__slug":"postgresql-timestamp","__params":{"pageAttributes__slug":"postgresql-timestamp"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}