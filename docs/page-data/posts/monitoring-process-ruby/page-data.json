{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/monitoring-process-ruby/","result":{"data":{"asciidoc":{"id":"420f32ea-1068-5b83-9cca-75edb2efa60b","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>系统环境 Ubuntu 18.04</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_指标\"><a class=\"anchor\" href=\"#_指标\"></a>指标</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>当前进程占用的内存：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">cat /proc/self/status | grep VmRSS\nVmRSS:       740 kB</code></pre>\n</div>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">match = File.read('/proc/self/status').match(/VmRSS:\\s+(\\d+)/)\nmatch &amp;&amp; match[1].to_f * 1024</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>当前进程打开的文件描述符总数：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">ls /proc/self/fd | wc -l</code></pre>\n</div>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">Dir.glob('/proc/self/fd/*').length</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>当前进程可打开的最大文件描述符数量：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">cat /proc/self/limits | grep \"Max open files\"</code></pre>\n</div>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">match = File.read('/proc/self/limits').match(/Max open files\\s*(\\d+)/)\nmatch &amp;&amp; match[1]</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>进程 CPU 时钟：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">Process.clock_gettime(Process::CLOCK_PROCESS_CPUTIME_ID, :float_second)</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>墙上时钟，受系统时间影响，调整系统时间时会发生变化：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">Process.clock_gettime(Process::CLOCK_REALTIME, :float_second)</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>系统启动时一直计数，不会受到系统时间的影响：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">Process.clock_gettime(Process::CLOCK_MONOTONIC, :float_second)</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>线程 CPU 时钟：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">Process.clock_gettime(Process::CLOCK_THREAD_CPUTIME_ID, :float_second)</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>测量 Ruby 代码执行时间：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">Benchmark.measure { \"a\"*1_000_000_000 }</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>返回 用户 CPU 时间、系统 CPU 时间、用户 CPU 时间以及 系统 CPU 时间之和。</p>\n</div>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>man 2 clock_gettime</p>\n</li>\n<li>\n<p><a href=\"https://ruby-doc.org/core-2.6.1/Process.html\">Process</a></p>\n</li>\n<li>\n<p><a href=\"https://ruby-doc.org/stdlib-2.6.1/libdoc/benchmark/rdoc/Benchmark.html\">Benchmark</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"监控 Ruby 进程"},"pageAttributes":{"slug":"monitoring-process-ruby","category":"monitoring"},"revision":{"date":"2020-05-14","number":"1.0"}}},"pageContext":{"id":"420f32ea-1068-5b83-9cca-75edb2efa60b","pageAttributes__slug":"monitoring-process-ruby","__params":{"pageAttributes__slug":"monitoring-process-ruby"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}