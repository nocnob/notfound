{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/git-protocol-pack-fetch/","result":{"data":{"asciidoc":{"id":"ee87f593-4fa2-5879-aac5-5be003b46aea","html":"<div class=\"sect1\">\n<h2 id=\"_git_协议启动\">Git 协议，启动</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>先启动 <a href=\"/posts/git-daemon/\">git daemon 服务，准备测试数据</a>。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 将协议版本设置为 1\ngit config --global protocol.version 1\n# git 日志保存到文件\nexport GIT_TRACE=$PWD/git-trace.log\nexport GIT_TRACE_PACKET=$PWD/git-trace-pack.log\n\ngit clone git://127.0.0.1/project.git --quiet</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>日志信息：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\"># 客户端先发送命令和仓库地址、host 以及附加的参数：\nC: git-upload-pack /project.git\\0host=127.0.0.1\\0\\0version=1\\0\nS: version 1</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>命令行模拟：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">echo -e -n \\\n    \"003bgit-upload-pack /project.git\\0host=127.0.0.1\\0\\0version=1\\0\" |\n    nc -v 127.0.0.1 9418</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_拉取\">拉取</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>服务端调用 <code>upload-pack</code>，客户端调用 <code>fetch-pack</code>。</p>\n</div>\n<div class=\"paragraph\">\n<p>在服务端仓库 reference 信息如下：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ git for-each-ref\n9f114f880890b39b0f862a05fd7f9ffa1283ec32 commit\trefs/heads/branch_2\nc4896697e257d5915e9a8f6f3460cab36ff8df9a commit\trefs/heads/main\nf5e9cea1914d420b24718a9a4336cf110836e8f0 commit\trefs/pull/8/head\n89c2910934c685b60d95532ccb48186c0ddbc6b0 commit\trefs/tags/v4.0\n94948ac8c40fc3f234a06595b3c5b4c70c4f43e0 tag\trefs/tags/v6.0</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>客户端拉取代码：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git clone git://127.0.0.1/project.git --quiet</code></pre>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_reference_发现\">reference 发现</h3>\n<div class=\"paragraph\">\n<p>服务端会发送 reference 列表。</p>\n</div>\n<div class=\"paragraph\">\n<p>日志信息：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">C: git-upload-pack /project.git\\0host=127.0.0.1\\0\\0version=1\\0\n\n# 1. 服务端返回版本号\nS: version 1\n\n# 2. 服务端列出所有 reference\nS: c4896697e257d5915e9a8f6f3460cab36ff8df9a HEAD\\0multi_ack thin-pack side-band side-band-64k ofs-delta shallow deepen-since deepen-not deepen-relative no-progress include-tag multi_ack_detailed symref=HEAD:refs/heads/main object-format=sha1 agent=git/2.39.1\nS: 9f114f880890b39b0f862a05fd7f9ffa1283ec32 refs/heads/branch_2\nS: c4896697e257d5915e9a8f6f3460cab36ff8df9a refs/heads/main\nS: f5e9cea1914d420b24718a9a4336cf110836e8f0 refs/pull/8/head\nS: 89c2910934c685b60d95532ccb48186c0ddbc6b0 refs/tags/v4.0\n# tag 对象\nS: 94948ac8c40fc3f234a06595b3c5b4c70c4f43e0 refs/tags/v6.0\n# tag 对象指向的对象\nS: 2f36731ec8d8b0e53fcfccd2cad413976aa47b69 refs/tags/v6.0^{}\nS: 0000</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>命令行模拟：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">echo -e -n \\\n    \"003bgit-upload-pack /project.git\\0host=127.0.0.1\\0\\0version=1\\0\" |\n    nc -v 127.0.0.1 9418</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_packfile_协商\">PACKFILE 协商</h3>\n<div class=\"sect3\">\n<h4 id=\"_全量\">全量</h4>\n<div class=\"paragraph\">\n<p>客户端必须发送所有需要的 obj-ids，这些 obj-ids 来自之前服务端发送的 reference 列表。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\"># 1. 客户端发送需要的 obj-ids\nC: want c4896697e257d5915e9a8f6f3460cab36ff8df9a multi_ack_detailed side-band-64k thin-pack no-progress ofs-delta deepen-since deepen-not agent=git/2.39.1\nC: want 9f114f880890b39b0f862a05fd7f9ffa1283ec32\nC: want c4896697e257d5915e9a8f6f3460cab36ff8df9a\nC: want 89c2910934c685b60d95532ccb48186c0ddbc6b0\nC: want 94948ac8c40fc3f234a06595b3c5b4c70c4f43e0\nC: 0000\nC: done\nS: NAK\n# 2. 服务端发送打包好的文件\nS: PACK ...\nS: 0000</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>执行 <code>git clone</code> 时默认会获取所有的 branch 和 tag</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_增量\">增量</h4>\n<div class=\"paragraph\">\n<p>服务端数据，新增两个提交共 6 个对象(2 commit, 2 tree, 2 blob)，其中 2 个对象之前就存在 (1 tree, 1 blob)：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ git log --pretty=oneline\n29901d7a4f8f4ae76920821d402de3e8dd151954 11:9 # 新增, 3 个对象，其中 tree blob 与 9 相同\n4eabd069067bc5de6fb281d792a6c10c4233475b 10   # 新增, 3 个对象都不同\nc4896697e257d5915e9a8f6f3460cab36ff8df9a 9\nf5e9cea1914d420b24718a9a4336cf110836e8f0 8\nfa679bfd70ac31dcb5862f9403ec4150d81b3d03 7\n2f36731ec8d8b0e53fcfccd2cad413976aa47b69 6\n9a533393b7342f34ceb497a1364d3bd84f54ce38 5\n89c2910934c685b60d95532ccb48186c0ddbc6b0 4\nf214f2bd153cdb1026183949d8cae10ed4470550 3\n9f114f880890b39b0f862a05fd7f9ffa1283ec32 2\ne40f1fece8708ed906683b13ecae19f57ae3660e 1</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>客户端执行：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 将接收到的 pack 内容保存到文件\nexport GIT_TRACE_PACKFILE=$PWD/git-trace-pack.pack\n\ngit pull origin main --quiet</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>日志信息：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">C: git-upload-pack /project.git\\0host=127.0.0.1\\0\\0version=1\\0\n\nS: version 1\nS: 29901d7a4f8f4ae76920821d402de3e8dd151954 HEAD\\0multi_ack thin-pack side-band side-band-64k ofs-delta shallow deepen-since deepen-not deepen-relative no-progress include-tag multi_ack_detailed symref=HEAD:refs/heads/main object-format=sha1 agent=git/2.39.1\nS: 9f114f880890b39b0f862a05fd7f9ffa1283ec32 refs/heads/branch_2\nS: 29901d7a4f8f4ae76920821d402de3e8dd151954 refs/heads/main\nS: f5e9cea1914d420b24718a9a4336cf110836e8f0 refs/pull/8/head\nS: 89c2910934c685b60d95532ccb48186c0ddbc6b0 refs/tags/v4.0\nS: 94948ac8c40fc3f234a06595b3c5b4c70c4f43e0 refs/tags/v6.0\nS: 2f36731ec8d8b0e53fcfccd2cad413976aa47b69 refs/tags/v6.0^{}\nS: 0000\n\nC: want 29901d7a4f8f4ae76920821d402de3e8dd151954 multi_ack_detailed side-band-64k thin-pack no-progress ofs-delta deepen-since deepen-not agent=git/2.39.1\nC: 0000\n\n# 客户端拥有的 obj-ids, multi_ack 模式下，一次最多发送 32 个 have\nC: have c4896697e257d5915e9a8f6f3460cab36ff8df9a\nC: have f5e9cea1914d420b24718a9a4336cf110836e8f0\nC: have 2f36731ec8d8b0e53fcfccd2cad413976aa47b69\nC: have 89c2910934c685b60d95532ccb48186c0ddbc6b0\nC: have 9f114f880890b39b0f862a05fd7f9ffa1283ec32\nC: done\n\n# 服务端响应公共的 obj-ids\nS: ACK c4896697e257d5915e9a8f6f3460cab36ff8df9a common\nS: ACK f5e9cea1914d420b24718a9a4336cf110836e8f0 common\nS: ACK 2f36731ec8d8b0e53fcfccd2cad413976aa47b69 common\nS: ACK 89c2910934c685b60d95532ccb48186c0ddbc6b0 common\nS: ACK 9f114f880890b39b0f862a05fd7f9ffa1283ec32 common\nS: ACK 9f114f880890b39b0f862a05fd7f9ffa1283ec32\nS: PACK ...\nS: 0000</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>packfile 实现了增量打包，仅发送了 6 个对象中的 4 个：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 创建空仓库\ngit init test\ncp  git-trace-pack.pack test\n# 解包\ngit unpack-objects &lt; git-trace-pack.pack\n\n# 查看解包后的对象\nfind .git/objects -type f\n## 版本 11:9 的 commit object\n# .git/objects/29/901d7a4f8f4ae76920821d402de3e8dd151954\n## 版本 10 中的 tree object\n# .git/objects/ac/ec268d33e842178aa07f409cc8631f261ae0b7\n## 版本 10 中的 blob object\n# .git/objects/87/2f83ba6a48c11095b25f3d44d99abbb370ad26\n## 版本 10 中的 commit object\n# .git/objects/4e/abd069067bc5de6fb281d792a6c10c4233475b</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>git help protocol-pack</p>\n</li>\n<li>\n<p>git help daemon</p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Git 协议 v1：fetch"},"pageAttributes":{"slug":"git-protocol-pack-fetch","category":"git"},"revision":{"date":"2023-01-19","number":"1.0"}}},"pageContext":{"id":"ee87f593-4fa2-5879-aac5-5be003b46aea","pageAttributes__slug":"git-protocol-pack-fetch","__params":{"pageAttributes__slug":"git-protocol-pack-fetch"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}