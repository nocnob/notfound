{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/java-jgit-http-server-start/","result":{"data":{"asciidoc":{"id":"d3749346-c6e6-5d4c-bcca-f67ad3aa77b1","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Gradle</p>\n</li>\n<li>\n<p>Tomcat</p>\n</li>\n<li>\n<p>JGit</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_jgit_http_server_使用\"><a class=\"anchor\" href=\"#_jgit_http_server_使用\"></a>JGit HTTP Server 使用</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>使用 JGit 实现 git HTTP server。</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_实现\"><a class=\"anchor\" href=\"#_实现\"></a>实现</h3>\n<div class=\"sect3\">\n<h4 id=\"_依赖\"><a class=\"anchor\" href=\"#_依赖\"></a>依赖</h4>\n<div class=\"paragraph\">\n<p>新建文件 <code>build.gradle</code> ：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-groovy\" data-lang=\"groovy\">plugins {\n    id 'war'\n}\n\nrepositories {\n    mavenCentral()\n}\n\ndependencies {\n    compileOnly group: 'javax.servlet', name: 'javax.servlet-api', version: '4.0.1'\n    implementation group: 'org.eclipse.jgit', name: 'org.eclipse.jgit.http.server', version: '5.10.0.202012080955-r'\n}</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_配置\"><a class=\"anchor\" href=\"#_配置\"></a>配置</h4>\n<div class=\"paragraph\">\n<p>新建文件 <code>src/main/webapp/WEB-INF/web.xml</code> ：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-xml\" data-lang=\"xml\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n&lt;web-app xmlns=\"http://xmlns.jcp.org/xml/ns/javaee\"\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://xmlns.jcp.org/xml/ns/javaee\n                             http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd\"\n         version=\"4.0\"\n         metadata-complete=\"true\"&gt;\n  &lt;display-name&gt;JGit HTTP Server&lt;/display-name&gt;\n  &lt;description&gt;Welcome to JGit HTTP Server&lt;/description&gt;\n\n  &lt;servlet&gt;\n    &lt;servlet-name&gt;GitServlet&lt;/servlet-name&gt;\n    &lt;servlet-class&gt;org.eclipse.jgit.http.server.GitServlet&lt;/servlet-class&gt;\n    &lt;init-param&gt;\n      &lt;param-name&gt;base-path&lt;/param-name&gt;\n      &lt;param-value&gt;/srv/git-data&lt;/param-value&gt;\n    &lt;/init-param&gt;\n    &lt;init-param&gt;\n      &lt;param-name&gt;export-all&lt;/param-name&gt;\n      &lt;param-value&gt;0&lt;/param-value&gt;\n    &lt;/init-param&gt;\n  &lt;/servlet&gt;\n  &lt;servlet-mapping&gt;\n    &lt;servlet-name&gt;GitServlet&lt;/servlet-name&gt;\n    &lt;url-pattern&gt;/git/*&lt;/url-pattern&gt;\n  &lt;/servlet-mapping&gt;\n&lt;/web-app&gt;</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>base-path</code> 仓库根目录。</p>\n</li>\n<li>\n<p><code>export-all</code> 是否可导出</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_仓库\"><a class=\"anchor\" href=\"#_仓库\"></a>仓库</h4>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>创建仓库目录：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">mkdir -p /srv/git-data\ncd /srv/git-data\ngit init --bare exampl.git</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>设置仓库为可导出，不需要鉴权：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">touch example.git/git-daemon-export-ok</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>可以拉取，但无法推送：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git clone http://localhost:8080/xxx/git/example.git</code></pre>\n</div>\n</div>\n</li>\n</ol>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_工作过程\"><a class=\"anchor\" href=\"#_工作过程\"></a>工作过程</h3>\n<div class=\"sect3\">\n<h4 id=\"_upload_pack_过程\"><a class=\"anchor\" href=\"#_upload_pack_过程\"></a>upload-pack 过程</h4>\n<div class=\"paragraph\">\n<p><span class=\"image\"><img src=\"/images/jgit-http-server-filter.svg\" alt=\"jgit http server filter\"></span></p>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_receive_pack_过程\"><a class=\"anchor\" href=\"#_receive_pack_过程\"></a>receive-pack 过程</h4>\n<div class=\"paragraph\">\n<p>与 upload-pack 相似，将其中关键字 <code>UploadPack</code> 替换为 <code>ReceivePack</code> 。</p>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_自定义访问控制\"><a class=\"anchor\" href=\"#_自定义访问控制\"></a>自定义访问控制</h3>\n<div class=\"sect3\">\n<h4 id=\"_实现_repositoryresolver_接口\"><a class=\"anchor\" href=\"#_实现_repositoryresolver_接口\"></a>实现 RepositoryResolver 接口</h4>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>参照 <code>FileResolver</code> 实现 <code>RepositoryResolver</code> ，默认实现查看 web.xml <code>export-all</code> 配置或者 .git 仓库目录下是否存在 <code>git-daemon-export-ok</code> 文件；</p>\n</li>\n<li>\n<p>继承 <code>GitServlet</code> 并通过 <code>setRepositoryResolver</code> 替换掉 <code>resolver</code> ；</p>\n</li>\n<li>\n<p>需要自定义 <code>Filter</code> 修改 <code>HttpServletResponse</code> ，在需要认证时 JGit 返回 401，但未添加 <code>WWW-Authenticate</code> 头部，导致输入密码也无效。</p>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>可控制仓库的访问，但无法直接区读、写操作。</p>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_实现_uploadpackfactory_接口\"><a class=\"anchor\" href=\"#_实现_uploadpackfactory_接口\"></a>实现 UploadPackFactory 接口</h4>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>参考 <code>DefaultUploadPackFactory</code> 实现 <code>UploadPackFactory</code> 接口，默认可拉取；</p>\n</li>\n<li>\n<p>继承 <code>GitServlet</code> 并通过 <code>setUploadPackFactory</code> 替换掉 <code>uploadPackFactory</code> ；</p>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>可对仓库进行读权限控制。</p>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_实现_receivepackfactory_接口\"><a class=\"anchor\" href=\"#_实现_receivepackfactory_接口\"></a>实现 ReceivePackFactory 接口</h4>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>参考 <code>DefaultReceivePackFactory</code> 实现 <code>ReceivePackFactory</code> 接口，默认不可推送；</p>\n</li>\n<li>\n<p>继承 <code>GitServlet</code> 并通过 <code>setReceivePackFactory</code> 替换掉 <code>receivePackFactory</code> 。</p>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>可对仓库进行写权限控制。</p>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h3>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://download.eclipse.org/jgit/site/5.10.0.202012080955-r/apidocs/index.html\">Class GitServlet</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>","document":{"title":"JGit HTTP Server 使用"},"pageAttributes":{"slug":"java-jgit-http-server-start","category":"java"},"revision":{"date":"2021-02-21","number":"1.0"}}},"pageContext":{"id":"d3749346-c6e6-5d4c-bcca-f67ad3aa77b1","pageAttributes__slug":"java-jgit-http-server-start","__params":{"pageAttributes__slug":"java-jgit-http-server-start"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}