{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/distribution-paxos-multi/","result":{"data":{"asciidoc":{"id":"a10d57e2-c725-52a7-878c-94a111ddc66d","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>对每条日志单独运行一次 Paxos 算法决议其中的值，添加日志索引 index 参数表示某一轮 Paxos 正在决策哪一个日志条目。</p>\n</div>\n<div class=\"paragraph\">\n<p>提案编号: <code>n.server_id</code></p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_顺序发送\">顺序发送</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-plantuml\" data-lang=\"plantuml\">@startuml\nparticipant Client as c\nparticipant \"Leader\" as l\nparticipant \"Acceptor 1\" as a1\nparticipant \"Acceptor 2\" as a2\nparticipant \"Acceptor 3\" as a3\n\nactivate c\nc -&gt; l : send(a)\nactivate l\nnote right l\n    &lt;font color=red&gt;maxRound=1\n    &lt;font color=red&gt;nextIndex=2\n    prepared=false\n    firstUnchosenIndex=1\nend note\n    l -&gt; a1 : Prepare(n=1.1, index=1) : a\n    activate a1\n    l -&gt; a2 : Prepare(n=1.1, index=1) : a\n    activate a2\n    note right a2\n        id=2\n        &lt;font color=red&gt;minProposal=1\n        firstUnchonsenIndex=1\n    end note\n\n    l &lt;-- a1 : Promise(acceptedProposal=0,acceptedValue=0,noMoreAccepted=true) : a\n    deactivate a1\n    l &lt;-- a2 : Promise(acceptedProposal=0,acceptedValue=0,noMoreAccepted=true) : a\n    deactivate a2\n    note right l\n        maxRound=1\n        nextIndex=2\n        &lt;font color=red&gt;prepared=true\n        firstUnchosenIndex=1\n    end note\n\n    l -&gt; a1 : Accept(n=1.1,index=1,v=a,firstUnchosenIndex=1) : a\n    activate a1\n    l -&gt; a2 : Accept(n=1.1,index=1,v=a,firstUnchosenIndex=1) : a\n    activate a2\n    note right a2\n        id=2\n        minProposal=1\n        firstUnchonsenIndex=1\n        &lt;font color=red&gt;acceptedProposal[1]=1.1\n        &lt;font color=red&gt;acceptedValue[1]=a\n    end note\n    l &lt;-- a1 : Accepted(n=1.1,firstUnchosenIndex=1) : a\n    deactivate a1\n    l &lt;-- a2 : Accepted(n=1.1,firstUnchosenIndex=1) : a\n    deactivate a2\nnote right l\nend note\nnote right l\n    maxRound=1\n    nextIndex=2\n    prepared=true\n    &lt;font color=red&gt;firstUnchosenIndex=2\n    &lt;font color=red&gt;acceptedProposal[1]=oo\n    &lt;font color=red&gt;acceptedValue[1]=a\nend note\nc &lt;-- l : a\ndeactivate l\n\nc -&gt; l : send(b)\nactivate l\nnote right l\n    maxRound=1\n    &lt;font color=red&gt;nextIndex=3\n    prepared=true\n    firstUnchosenIndex=2\nend note\n    l -&gt; a1 : Accept(n=1.1,index=2,v=b,firstUnchosenIndex=2) : b\n    activate a1\n    l -&gt; a2 : Accept(n=1.1,index=2,v=b,firstUnchosenIndex=2) : b\n    activate a2\n    note right a2\n        id=2\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=2\n        &lt;font color=red&gt;acceptedProposal[1]=oo\n        &lt;font color=red&gt;acceptedProposal[2]=1.1\n        acceptedValue[1]=a\n        &lt;font color=red&gt;acceptedValue[2]=b\n    end note\n    l &lt;-- a1 : Accepted(n=1.1,firstUnchosenIndex=2) : b\n    deactivate a1\n    l &lt;-- a2 : Accepted(n=1.1,firstUnchosenIndex=2) : b\n    deactivate a2\nnote right l\n    maxRound=1\n    nextIndex=3\n    prepared=true\n    &lt;font color=red&gt;firstUnchosenIndex=3\n    &lt;font color=red&gt;acceptedProposal[2]=oo\n    &lt;font color=red&gt;acceptedValue[2]=b\nend note\nc &lt;-- l : b\ndeactivate l\n\nc -&gt; l : send(c)\nactivate l\nnote right l\n    maxRound=1\n    &lt;font color=red&gt;nextIndex=4\n    prepared=true\n    firstUnchosenIndex=3\nend note\n    l -&gt; a1 : Accept(n=1.1,index=3,v=c,firstUnchosenIndex=3) : c\n    activate a1\n    l -&gt; a2 : Accept(n=1.1,index=3,v=c,firstUnchosenIndex=3) : c\n    activate a2\n    note right a2\n        id=2\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=3\n        &lt;font color=red&gt;acceptedProposal[2]=oo\n        &lt;font color=red&gt;acceptedProposal[3]=1.1\n        acceptedValue[2]=b\n        &lt;font color=red&gt;acceptedValue[3]=c\n    end note\n    l &lt;-- a1 : Accepted(n=1.1,firstUnchosenIndex=3) : c\n    deactivate a1\n    l &lt;-- a2 : Accepted(n=1.1,firstUnchosenIndex=3) : c\n    deactivate a2\nnote right l\n    maxRound=1\n    nextIndex=4\n    prepared=true\n    &lt;font color=red&gt;firstUnchosenIndex=4\n    &lt;font color=red&gt;acceptedValue[3]=oo\n    &lt;font color=red&gt;acceptedValue[3]=c\nend note\nc &lt;-- l : c\ndeactivate l\n@enduml</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>send(a) 存在第一阶段和阶段</p>\n</li>\n<li>\n<p>send(b) 和 send(c) 直接进入第二阶段，直接使用之前的提案编号 n。</p>\n</li>\n</ul>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_补全副本\">补全副本</h3>\n<div class=\"paragraph\">\n<p>Acceptor 3 副本不完整，通过 Success 请求补全。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-plantuml\" data-lang=\"plantuml\">@startuml\nparticipant Client as c\nparticipant \"Leader\" as l\nparticipant \"Acceptor 1\" as a1\nparticipant \"Acceptor 2\" as a2\nparticipant \"Acceptor 3\" as a3\n\nc -&gt; l : send(d)\nactivate l\nnote right l\n    maxRound=1\n    &lt;font color=red&gt;nextIndex=5\n    prepared=true\n    firstUnchonsenIndex=4\nend note\nnote right a2\n    id=2\n    minProposal=1\n    firstUnchonsenIndex=3\n    acceptedProposal[3]=1.1\n    acceptedValue[3]=c\nend note\n    l -&gt; a2 : Accept(n=1.1,index=4,v=d,firstUnchosenIndex=4) : d\n    activate a2\n    note right a2\n        id=2\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=4\n        &lt;font color=red&gt;acceptedProposal[3]=oo\n        &lt;font color=red&gt;acceptedProposal[4]=1.1\n        acceptedValue[3]=c\n        &lt;font color=red&gt;acceptedValue[4]=d\n    end note\n    l &lt;-- a2 : Accepted(n=1.1,firstUnchosenIndex=4) : d\n    deactivate a2\n\n    note right a3\n        id=3\n        minProposal=0\n        firstUnchonsenIndex=1\n    end note\n    l -&gt; a3 : Accept(n=1.1,index=4,v=d,firstUnchosenIndex=4) : d\n    activate a3\n    note right a3\n        id=3\n        &lt;font color=red&gt;minProposal=1\n        firstUnchonsenIndex=1\n        &lt;font color=red&gt;acceptedProposal[4]=1.1\n        &lt;font color=red&gt;acceptedValue[4]=d\n    end note\n    l &lt;-- a3 : Accepted(n=1.1,&lt;font color=red&gt;firstUnchosenIndex=1&lt;/font&gt;) : d\n    deactivate a3\n\nnote right l\n    maxRound=1\n    nextIndex=5\n    prepared=true\n    &lt;font color=red&gt;firstUnchosenIndex=5\n    &lt;font color=red&gt;acceptedProposal[4]=oo\n    &lt;font color=red&gt;acceptedValue[4]=d\nend note\nc &lt;-- l: d\n    l -&gt; a3 : Success(index=1,value=a) : a\n    activate a3\n    note right a3\n        id=3\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=2\n        &lt;font color=red&gt;acceptedProposal[1]=oo\n        &lt;font color=red&gt;acceptedValue[1]=a\n    end note\n    l &lt;-- a3 : Succeed(firstUnchonsenIndex=2)\n    deactivate a3\n\n    l -&gt; a3 : Success(index=2,value=b) : b\n    activate a3\n    note right a3\n        id=3\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=3\n        &lt;font color=red&gt;acceptedProposal[2]=oo\n        &lt;font color=red&gt;acceptedValue[2]=b\n    end note\n    l &lt;-- a3 : Succeed(firstUnchonsenIndex=3)\n    deactivate a3\n\n    l -&gt; a3 : Success(index=3,value=c) : c\n    activate a3\n    note right a3\n        id=4\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=4\n        &lt;font color=red&gt;acceptedProposal[3]=oo\n        &lt;font color=red&gt;acceptedValue[3]=c\n    end note\n    l &lt;-- a3 : Succeed(firstUnchonsenIndex=4)\n    deactivate a3\n\n    l -&gt; a3 : Success(index=4,value=d) : d\n    activate a3\n    note right a3\n        id=4\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=5\n        &lt;font color=red&gt;acceptedProposal[4]=oo\n        &lt;font color=red&gt;acceptedValue[4]=d\n    end note\n    l &lt;-- a3 : Succeed(firstUnchonsenIndex=5)\n    deactivate a3\n@enduml</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_leader_并发\">Leader 并发</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_acceptor_顺序相同\">Acceptor 顺序相同</h3>\n<div class=\"paragraph\">\n<p>从 Leader 角度看请求并发，但从所有 Acceptor 角度看都和 Leader 收到的请求的顺序相同。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-plantuml\" data-lang=\"plantuml\">@startuml\nparticipant Client as c\nparticipant \"Leader\" as l\nparticipant \"Acceptor 1\" as a1\nparticipant \"Acceptor 2\" as a2\nparticipant \"Acceptor 3\" as a3\n\nactivate c\nc -&gt; l : send(d)\nactivate l\nnote right l\n    maxRound=1\n    &lt;font color=red&gt;nextIndex=5\n    prepared=true\n    firstUnchonsenIndex=4\nend note\nnote right a2\n    id=2\n    minProposal=1\n    firstUnchonsenIndex=3\n    acceptedProposal[3]=1.1\n    acceptedValue[3]=c\nend note\n    l -&gt; a1 : Accept(n=1.1,index=4,v=d,firstUnchosenIndex=4) : d\n    activate a1\n    note right a1\n        id=1\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=4\n        &lt;font color=red&gt;acceptedProposal[3]=oo\n        &lt;font color=red&gt;acceptedProposal[4]=1.1\n        acceptedValue[3]=c\n        &lt;font color=red&gt;acceptedValue[4]=d\n    end note\n    l &lt;-- a1 : Accepted(n=1.1,firstUnchosenIndex=4) : d\n    deactivate a1\n\nc -&gt; l : send(e)\nactivate l\nnote right l\n    maxRound=1\n    &lt;font color=red&gt;nextIndex=6\n    prepared=true\n    firstUnchonsenIndex=4\nend note\n    l -&gt; a1 : Accept(n=1.1,index=5,v=e,firstUnchosenIndex=4) : e\n    activate a1\n    note right a1\n        id=1\n        minProposal=1\n        firstUnchonsenIndex=4\n        acceptedProposal[4]=1.1\n        &lt;font color=red&gt;acceptedProposal[5]=1.1\n        acceptedValue[4]=d\n        &lt;font color=red&gt;acceptedValue[5]=e\n    end note\n    l &lt;-- a1 : Accepted(n=1.1,firstUnchosenIndex=4) : e\n    deactivate a1\n\n    l -&gt; a2 : Accept(n=1.1,index=4,v=c,firstUnchosenIndex=4) : d\n    activate a2\n    note right a2\n        id=2\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=4\n        &lt;font color=red&gt;acceptedProposal[3]=oo\n        &lt;font color=red&gt;acceptedProposal[4]=1.1\n        acceptedValue[3]=c\n        &lt;font color=red&gt;acceptedValue[4]=d\n    end note\n    l &lt;-- a2 : Accepted(n=1.1,firstUnchosenIndex=4) : d\n    deactivate a2\n    note right l\n        maxRound=1\n        nextIndex=6\n        prepared=true\n        &lt;font color=red&gt;firstUnchonsenIndex=5\n        &lt;font color=red&gt;acceptedProposal[4]=oo\n        &lt;font color=red&gt;acceptedValue[4]=d\n    end note\nc &lt;-- l : d\n\n    l -&gt; a2 : Accept(n=1.1,index=5,v=e,firstUnchosenIndex=5) : e\n    activate a2\n    note right a2\n        id=2\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=5\n        &lt;font color=red&gt;acceptedProposal[4]=oo\n        &lt;font color=red&gt;acceptedProposal[5]=1.1\n        acceptedValue[4]=d\n        &lt;font color=red&gt;acceptedValue[5]=e\n    end note\n    l &lt;-- a2 : Accepted(n=1.1,firstUnchosenIndex=5) : e\n    deactivate a2\nnote right l\n    maxRound=1\n    nextIndex=6\n    prepared=true\n    &lt;font color=red&gt;firstUnchonsenIndex=6\n    &lt;font color=red&gt;acceptedProposal[5]=oo\n    &lt;font color=red&gt;acceptedValue[5]=e\nend note\nc &lt;-- l : e\ndeactivate l\ndeactivate l\n\nc -&gt; l : send(f)\nactivate l\nnote right l\n    maxRound=1\n    &lt;font color=red&gt;nextIndex=7\n    prepared=true\n    firstUnchonsenIndex=6\nend note\n    l -&gt; a1 : Accept(n=1.1,index=6,v=f,firstUnchosenIndex=6) : f\n    activate a1\n    l -&gt; a2 : Accept(n=1.1,index=6,v=f,firstUnchosenIndex=6) : f\n    activate a2\n    note right a2\n        id=2\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=6\n        &lt;font color=red&gt;acceptedProposal[5]=oo\n        &lt;font color=red&gt;acceptedProposal[6]=1.1\n        acceptedValue[5]=e\n        &lt;font color=red&gt;acceptedValue[6]=f\n    end note\n    l &lt;-- a1 : Accepted(n=1.1,firstUnchosenIndex=6) : f\n    deactivate a1\n    l &lt;-- a2 : Accepted(n=1.1,firstUnchosenIndex=6) : f\n    deactivate a2\nnote right l\n    maxRound=1\n    nextIndex=7\n    prepared=true\n    &lt;font color=red&gt;firstUnchonsenIndex=7\n    &lt;font color=red&gt;acceptedProposal[6]=oo\n    &lt;font color=red&gt;acceptedValue[6]=f\nend note\nc &lt;-- l : f\ndeactivate l\n@enduml</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>从 Leader 角度看，请求处理过程有重叠，但每个 Acceptor 都是先处理 d，后处理 e。</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_acceptor_顺序不同\">Acceptor 顺序不同</h3>\n<div class=\"paragraph\">\n<p>从 Leader 角度看请求并发，且不同的 Acceptor 处理顺序不同。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-plantuml\" data-lang=\"plantuml\">@startuml\nparticipant Client as c\nparticipant \"Leader\" as l\nparticipant \"Acceptor 1\" as a1\nparticipant \"Acceptor 2\" as a2\nparticipant \"Acceptor 3\" as a3\n\nactivate c\nc -&gt; l : send(d)\nactivate l\nnote right l\n    maxRound=1\n    &lt;font color=red&gt;nextIndex=5\n    prepared=true\n    firstUnchonsenIndex=4\nend note\nnote right a2\n    id=2\n    minProposal=1\n    firstUnchonsenIndex=3\n    acceptedProposal[3]=1.1\n    acceptedValue[3]=c\nend note\n    l -&gt; a1 : Accept(n=1.1,index=4.1,v=d,firstUnchosenIndex=4) : d\n    activate a1\n    note right a1\n        id=1\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=4\n        &lt;font color=red&gt;acceptedProposal[3]=oo\n        &lt;font color=red&gt;acceptedProposal[4]=1.1\n        acceptedValue[3]=c\n        &lt;font color=red&gt;acceptedValue[4]=d\n    end note\n    l &lt;-- a1 : Accepted(n=1.1,firstUnchosenIndex=4) : d\n    deactivate a1\n\nc -&gt; l : send(e)\nactivate l\nnote right l\n    maxRound=1\n    &lt;font color=red&gt;nextIndex=6\n    prepared=true\n    firstUnchonsenIndex=4\nend note\n    l -&gt; a1 : Accept(n=1.1,index=5,v=e,firstUnchosenIndex=4) : e\n    activate a1\n    note right a1\n        id=1\n        minProposal=1\n        firstUnchonsenIndex=4\n        acceptedProposal[4]=1.1\n        &lt;font color=red&gt;acceptedProposal[5]=1.1\n        acceptedValue[4]=d\n        &lt;font color=red&gt;acceptedValue[5]=e\n    end note\n\n    l -&gt; a2 : Accept(n=1.1,index=5,v=e,firstUnchosenIndex=4) : e\n    activate a2\n    note right a2\n        id=2\n        minProposal=1\n        &lt;font color=red&gt;firstUnchonsenIndex=4\n        &lt;font color=red&gt;acceptedProposal[3]=oo\n        &lt;font color=red&gt;acceptedProposal[5]=1.1\n        acceptedValue[3]=d\n        &lt;font color=red&gt;acceptedValue[5]=e\n    end note\n    l &lt;-- a1 : Accepted(n=1.1,firstUnchosenIndex=4) : e\n    deactivate a1\n    l &lt;-- a2 : Accepted(n=1.1,firstUnchosenIndex=4) : e\n    deactivate a2\nnote right l\n    maxRound=1\n    nextIndex=6\n    prepared=true\n    firstUnchonsenIndex=4\n    &lt;font color=red&gt;acceptedProposal[5]=oo\n    &lt;font color=red&gt;acceptedValue[5]=e\nend note\nc &lt;-- l : e\ndeactivate l\n\n    l -&gt; a2 : Accept(n=1.1,index=4,v=c,firstUnchosenIndex=4) : d\n    activate a2\n    note right a2\n        id=2\n        minProposal=1\n        firstUnchonsenIndex=4\n        &lt;font color=red&gt;acceptedProposal[4]=1.1\n        acceptedProposal[5]=1.1\n        &lt;font color=red&gt;acceptedValue[4]=d\n        acceptedValue[5]=e\n    end note\n    l &lt;-- a2 : Accepted(n=1.1,firstUnchosenIndex=4) : d\n    deactivate a2\n\n    note right l\n        maxRound=1\n        nextIndex=6\n        prepared=true\n        &lt;font color=red&gt;firstUnchonsenIndex=6\n        &lt;font color=red&gt;acceptedProposal[4]=oo\n        &lt;font color=red&gt;acceptedValue[4]=d\n    end note\nc &lt;-- l : d\ndeactivate l\n@enduml</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Acceptor 1 先处理 index=4 的请求，在处理 index=5 的请求</p>\n</li>\n<li>\n<p>Acceptor 2 先处理 index=5 的请求，再处理 index=4 的请求</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://book.douban.com/subject/35794814/\">《深入理解分布式系统》</a></p>\n</li>\n<li>\n<p><a href=\"https://liu-jianhao.github.io/2019/05/paxosmulti-paxos%E8%AF%A6%E8%A7%A3/\" class=\"bare\">https://liu-jianhao.github.io/2019/05/paxosmulti-paxos%E8%AF%A6%E8%A7%A3/</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Multi Paxos 基本流程"},"pageAttributes":{"slug":"distribution-paxos-multi","category":"distribution"},"revision":{"date":"2023-02-02","number":"1.0"}}},"pageContext":{"id":"a10d57e2-c725-52a7-878c-94a111ddc66d","pageAttributes__slug":"distribution-paxos-multi","__params":{"pageAttributes__slug":"distribution-paxos-multi"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}