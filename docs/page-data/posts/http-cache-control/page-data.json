{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/http-cache-control/","result":{"data":{"asciidoc":{"id":"0836bc86-82d1-594c-be92-5fb09fe4ac29","html":"<div class=\"sect1\">\n<h2 id=\"_etag_与_if_none_match\"><a class=\"anchor\" href=\"#_etag_与_if_none_match\"></a><code>ETag</code> 与 <code>If-None-Match</code></h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>新建 <code>app.rb</code>:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">require 'sinatra'\nrequire 'digest'\n\nget '/req1' do\n  etag Digest::MD5.hexdigest('Hello ETag!')\n\n  'Hello ETag!'\nend</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>执行 <code>ruby app.rb</code> 启动服务。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ curl -I http://localhost:4567/req1\nHTTP/1.1 200 OK\nETag: \"7a6ee48ea7568446c2658e55ac389b1a\"\nContent-Type: text/html;charset=utf-8\nContent-Length: 11\n\n$ curl -I -H 'If-None-Match: \"7a6ee48ea7568446c2658e55ac389b1a\"' http://localhost:4567/req1\nHTTP/1.1 304 Not Modified\nETag: \"7a6ee48ea7568446c2658e55ac389b1a\"</code></pre>\n</div>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>第一次客户端直接请求</p>\n<div class=\"olist loweralpha\">\n<ol class=\"loweralpha\" type=\"a\">\n<li>\n<p>服务务端返回 200，并包含头部 <code>ETag</code> 和完整 body</p>\n</li>\n</ol>\n</div>\n</li>\n<li>\n<p>第二次客户端发送请求时携带头部 <code>If-None-Match: {ETag}</code></p>\n<div class=\"olist loweralpha\">\n<ol class=\"loweralpha\" type=\"a\">\n<li>\n<p>服务端通过 <code>If-None-Match</code> 的值 <code>ETag</code> 判断数据是否过期，未过期时直接返回 304 和 ETag，body 为空</p>\n</li>\n</ol>\n</div>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>ETag 可以是内容的哈希或者其他值，在命中 ETag 的情况下，减少了数据的传输。</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_强弱_etag\"><a class=\"anchor\" href=\"#_强弱_etag\"></a>强/弱 ETag</h3>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>强 ETag 要求数据每个字节完全一致，未经过任何处理，包括压缩。</p>\n</li>\n<li>\n<p>弱 ETag 以 <code>W/</code> 开头，Nginx 在开启 gzip 的情况下，会变成弱 ETag。</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_last_modified_与_if_modified_since\"><a class=\"anchor\" href=\"#_last_modified_与_if_modified_since\"></a><code>Last-Modified</code> 与 <code>If-Modified-Since</code></h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>新建 <code>app.rb</code>:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">require 'sinatra'\n\nget '/req2' do\n  last_modified Time.new(2022, 1, 1, 8)\n\n  'Hello, Last-Modified!'\nend</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>执行 <code>ruby app.rb</code> 启动服务。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ curl -I http://localhost:4567/req2\nHTTP/1.1 200 OK\nLast-Modified: Sat, 01 Jan 2022 00:00:00 GMT\nContent-Type: text/html;charset=utf-8\nContent-Length: 21\n\n$ curl -I -H \"If-Modified-Since: Sat, 01 Jan 2022 00:00:00 GMT\" http://localhost:4567/req2\nHTTP/1.1 304 Not Modified\nLast-Modified: Sat, 01 Jan 2022 00:00:00 GMT</code></pre>\n</div>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>第一次客户端直接请求</p>\n<div class=\"olist loweralpha\">\n<ol class=\"loweralpha\" type=\"a\">\n<li>\n<p>服务务端返回 200，并包含 <code>Last-Modified:</code> 头部和完整 body</p>\n</li>\n</ol>\n</div>\n</li>\n<li>\n<p>第二次客户端发送请求时携带 <code>If-Modified-Since: {Date}</code> 头部</p>\n<div class=\"olist loweralpha\">\n<ol class=\"loweralpha\" type=\"a\">\n<li>\n<p>服务端通过 <code>If-Modified-Since</code> 的值 <code>Date</code> 判断数据是否过期，未过期时直接返回 304 和 Last-Modified，body 为空</p>\n</li>\n</ol>\n</div>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p><code>Last-Modified</code> 为最后修改时间，内容为更改的情况下可以减少数据的传输。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_cache_control\"><a class=\"anchor\" href=\"#_cache_control\"></a><code>Cache-Control</code></h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><code>Cache-Control</code> 通过指定指令来实现缓存机制。包括可缓存性、到期时间等等。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">require 'sinatra'\n\nget '/req3' do\n  cache_control :public, :max_age =&gt; 60\n\n  'Hello, Cache Control!'\nend</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>重复请求会重复发送数据，需要与 <code>ETag</code> 和 <code>Last-Modified</code> 一起使用。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Conditional_requests\" class=\"bare\">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Conditional_requests</a></p>\n</li>\n<li>\n<p><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/ETag\" class=\"bare\">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/ETag</a></p>\n</li>\n<li>\n<p><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Last-Modified\" class=\"bare\">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Last-Modified</a></p>\n</li>\n<li>\n<p><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Cache-Control\" class=\"bare\">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Cache-Control</a></p>\n</li>\n<li>\n<p><a href=\"http://sinatrarb.com/intro-zh.html\" class=\"bare\">http://sinatrarb.com/intro-zh.html</a></p>\n</li>\n<li>\n<p><a href=\"https://naluduo.vip/Web-Performance-Optimization\" class=\"bare\">https://naluduo.vip/Web-Performance-Optimization</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Http Etag 与 Last-Modified"},"pageAttributes":{"slug":"http-cache-control","category":"http"},"revision":{"date":"2022-02-16","number":"1.0"}}},"pageContext":{"id":"0836bc86-82d1-594c-be92-5fb09fe4ac29","pageAttributes__slug":"http-cache-control","__params":{"pageAttributes__slug":"http-cache-control"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}