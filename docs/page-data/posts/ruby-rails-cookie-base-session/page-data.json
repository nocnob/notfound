{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/ruby-rails-cookie-base-session/","result":{"data":{"asciidoc":{"id":"caac0cb1-f917-5f18-8848-bca7681923a0","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Rails 7.0.4</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>解密保存在 cookies 中被加密的 session 内容。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_准备\">准备</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>选择任意 controller#action 添加如下内容，然后从浏览器访问 controller#action：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">cookies.encrypted[:id] = 1</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>获取名称为 id 的 cookie 值，如:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">pmbaXUEFu3pbBHQebd%2BNerKE%2FuzRiXTnoPFWubjcisZb1Y7NLtA3m%2BCpKcXUCI1p4GwfmUZr9SWzNg%3D%3D--TfiLwy6bzjGOLtl5--uhJZLGVSXo6P0iojTFoCpQ%3D%3D</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_解密_cookie\">解密 cookie</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>在 <code>rails c</code> 中执行：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\"># 参考 https://github.com/rails/rails/blob/v7.0.4/actionpack/lib/action_dispatch/middleware/cookies.rb#L644-L646\ndef decrypt_cookie(value)\n  value = CGI::unescape(value)\n\n  authenticated_encrypted_cookie_salt = \"authenticated encrypted cookie\"\n  encrypted_cookie_cipher = \"aes-256-gcm\"\n\n  key_len = ActiveSupport::MessageEncryptor.key_len(encrypted_cookie_cipher)\n  secret = MyApp::Application.key_generator.generate_key(authenticated_encrypted_cookie_salt, key_len)\n\n  serializer = ActiveSupport::MessageEncryptor::NullSerializer\n  encryptor = ActiveSupport::MessageEncryptor.new(secret, cipher: encrypted_cookie_cipher, serializer: serializer)\n\n  # 解密\n  encryptor.decrypt_and_verify(value, purpose: \"cookie.id\")\n  # 加密\n  # encryptor.encrypt_and_sign('1', purpose: \"cookie.id\")\nend\n\nvalue = \"pmbaXUEFu3pbBHQebd%2BNerKE%2FuzRiXTnoPFWubjcisZb1Y7NLtA3m%2BCpKcXUCI1p4GwfmUZr9SWzNg%3D%3D--TfiLwy6bzjGOLtl5--uhJZLGVSXo6P0iojTFoCpQ%3D%3D\"\ndecrypt_cookie(value)</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_messageencryptor\">MessageEncryptor</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>在 rails 中，可以使用 MessageEncryptor 加、解密</p>\n</div>\n<div class=\"paragraph\">\n<p>MessageEncryptor#encrypt_and_sign 方法：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">def encrypt_and_sign(value, expires_at: nil, expires_in: nil, purpose: nil)</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>可以传入过期时间、用途</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p><code>rails c</code> 中加、解密示例：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">len = ActiveSupport::MessageEncryptor.key_len\nsalt = SecureRandom.random_bytes(len)\nkey = MyApp::Application.key_generator.generate_key(salt, len)\ncrypt = ActiveSupport::MessageEncryptor.new(key)\n# 加密\nencrypted_data = crypt.encrypt_and_sign('my secret data')\n# 解密\ncrypt.decrypt_and_verify(encrypted_data)</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://guides.rubyonrails.org/action_controller_overview.html#cookies\" class=\"bare\">https://guides.rubyonrails.org/action_controller_overview.html#cookies</a></p>\n</li>\n<li>\n<p><a href=\"https://ihower.tw/rails/fullstack-security-cookie.html\" class=\"bare\">https://ihower.tw/rails/fullstack-security-cookie.html</a></p>\n</li>\n<li>\n<p><a href=\"https://api.rubyonrails.org/classes/ActiveSupport/MessageEncryptor.html\" class=\"bare\">https://api.rubyonrails.org/classes/ActiveSupport/MessageEncryptor.html</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"解密 rails Cookie-based Session"},"pageAttributes":{"slug":"ruby-rails-cookie-base-session","category":"ruby"},"revision":{"date":"2023-01-11","number":"1.0"}}},"pageContext":{"id":"caac0cb1-f917-5f18-8848-bca7681923a0","pageAttributes__slug":"ruby-rails-cookie-base-session","__params":{"pageAttributes__slug":"ruby-rails-cookie-base-session"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}