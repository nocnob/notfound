{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/ssh-config/","result":{"data":{"asciidoc":{"id":"16f081c1-ceec-5c6a-864d-afd75a5bf946","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>系统环境 Ubuntu</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_生成_ssh_key\"><a class=\"anchor\" href=\"#_生成_ssh_key\"></a>生成 SSH KEY</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">ssh-keygen -t ed25519 -C \"notfound@local\"</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>-t</code> 密钥类型为 ed25519</p>\n</li>\n<li>\n<p><code>-C</code> 注释</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_服务器免密登录\"><a class=\"anchor\" href=\"#_服务器免密登录\"></a>服务器免密登录</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>将本地公钥复制到远程：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">ssh-copy-id -i ~/.ssh/id_ed25519 notfound@notfound.cn</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>以上操作等同于：在服务器文件 <code>~/.ssh/authorized_keys</code> 中添加客户端的 SSH 公钥(如 <code>~/.ssh/id_ed25519.pub</code>)：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">~/.ssh/authorized_keys</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">ssh-ed25519 AAAA***************************************************************7 notfound@local</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>~/.ssh/authorized_keys</code> (600) 文件或者 <code>~/.ssh</code> (700) 目录权限过大或者不正确时不会生效。</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>在客户端上编辑文件 <code>~/.ssh/config</code>：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ssh\" data-lang=\"ssh\">Host notfound\n  User notfound\n  Hostname notfound.cn\n  Port 22\n  IdentityFile ~/.ssh/id_ed25519</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>直接执行 <code>ssh notfound</code> 即可登录服务器。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_客户端配置_key\"><a class=\"anchor\" href=\"#_客户端配置_key\"></a>客户端配置 KEY</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>可以实现：</p>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>同一主机使用不同 KEY。</p>\n</li>\n<li>\n<p>不同主机使用不同 KEY。</p>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>编辑文件 <code>~/.ssh/config</code>：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ssh\" data-lang=\"ssh\">Host gh1\n  User git\n  Hostname github.com\n  Port 22\n  IdentityFile ~/.ssh/id_ecdsa\nHost gh2\n  User git\n  Hostname github.com\n  Port 22\n  IdentityFile ~/.ssh/id_ed25519</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>SSH 客户端通过 Host 即可使用对应的配置。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git clone gh1:owner/repo.git\ngit clone gh2:owner/repo.git</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>git 调用了 ssh 命令</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_远程执行命令\"><a class=\"anchor\" href=\"#_远程执行命令\"></a>远程执行命令</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>配置好服务器免密登录后，通过 <code>ssh -T HOST command</code> 可以直接在服务器 HOST 上执行 command 命令。</p>\n</div>\n<div class=\"paragraph\">\n<p>如 hugo 编译，省去了手动登录的步骤：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">ssh -T notfound hugo -s work/notfound.cn -d /var/www/notfound.cn</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_客户端心跳\"><a class=\"anchor\" href=\"#_客户端心跳\"></a>客户端心跳</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>客户端上编辑文件 <code>~/.ssh/config</code>：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ssh\" data-lang=\"ssh\">  ServerAliveInterval 60</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>ServerAliveInterval</code> 客户端 60s 未接收到服务端数据时，发送一个数据包给服务端</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_连接复用\"><a class=\"anchor\" href=\"#_连接复用\"></a>连接复用</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>客户端上编辑文件 <code>~/.ssh/config</code>：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ssh\" data-lang=\"ssh\">  ControlMaster auto\n  ControlPath ~/.ssh/connection-%r@%h:%p\n  ControlPersist 4h</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>终端多个窗口连接同一个服务器可以复用一个网络连接。</p>\n</li>\n<li>\n<p>连接保持 4 小时</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_自建服务器保存_git_仓库\"><a class=\"anchor\" href=\"#_自建服务器保存_git_仓库\"></a>自建服务器保存 Git 仓库</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>配置服务器免密，登录服务器创建 git 仓库，在 <code>$HOME</code> 目录执行：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git init --bare demo.git</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>客户端配置 <code>~/.ssh/config</code> 后， 执行：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">git clone notfound:demo.git\n# 如果未配置 `~/.ssh/config`, 则执行\ngit clone user@notfound.cn:demo.git</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_proxycommand\"><a class=\"anchor\" href=\"#_proxycommand\"></a>ProxyCommand</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ssh\" data-lang=\"ssh\">Host host_a\n   User a\n   Port 22\n   HostName a.notfound.cn\nHost host_b\n   User b\n   Port 22\n   HostName b.notfound.cn\n   ProxyCommand ssh -W %h:%p host_a</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>通过 <code>host_a</code> 跳转到 <code>host_b</code></p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_隧道\"><a class=\"anchor\" href=\"#_隧道\"></a>隧道</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_本地端口转发\"><a class=\"anchor\" href=\"#_本地端口转发\"></a>本地端口转发</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">ssh -fNL 3001:localhost:3000 192.168.1.2\n# 等效\nssh -fNL 127.0.0.1:3001:localhost:3000 192.168.1.2</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>-f 后台执行</p>\n</li>\n<li>\n<p>-N 不执行远程命令</p>\n</li>\n<li>\n<p>-L 指定端口映射参数</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>在本地机器使用 <code>127.0.0.1:3001</code> 如同在远程机器 192.168.1.2 上通过 <code>localhost:3000</code> 访问</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">127.0.0.1:3001(本地) --&gt; 192.168.1.2 --&gt; localhost:3000(192.168.2)</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_远程端口转发\"><a class=\"anchor\" href=\"#_远程端口转发\"></a>远程端口转发</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">ssh -R localhost:3000:127.0.0.1:3001 192.168.1.2</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>在远程机器 192.168.1.2 上使用 <code>localhost:3001</code> 如同在本地通过 <code>127.0.0.1:3000</code> 访问</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_签名\"><a class=\"anchor\" href=\"#_签名\"></a>签名</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>OpenSSH 8.0+</p>\n</li>\n</ul>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_签名_2\"><a class=\"anchor\" href=\"#_签名_2\"></a>签名</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># ssh-keygen -Y sign -f key_file -n namespace file\nssh-keygen -Y sign -f ~/.ssh/id_ed25519 -n git README.md</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>-f</code> 私钥文件路径 <code>~/.ssh/id_ed25519</code></p>\n</li>\n<li>\n<p><code>-n</code> namespace 为 <code>git</code></p>\n</li>\n<li>\n<p>被签名的文件路径为 <code>README.md</code></p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_验证\"><a class=\"anchor\" href=\"#_验证\"></a>验证</h3>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>新建文件 <code>~/.ssh/allowed_signers_file</code></p>\n</li>\n</ol>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">notfound@notfound.cn ssh-ed25519 AAAAC3N*************************************************************</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>邮箱(可使用其他值)与 SSH 公钥映射</p>\n</li>\n</ul>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\" start=\"2\">\n<li>\n<p>验证</p>\n</li>\n</ol>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># ssh-keygen -Y verify -f allowed_signers_file -I signer_identity -n namespace -s signature_file [-r revocation_file]\nssh-keygen -Y verify -f ~/.ssh/allowed_signers_file -I notfound@notfound.cn -n git -s README.md.sig &lt; README.md</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>-f</code> 邮箱(可使用其他值)与 SSH 公钥映射文件路径</p>\n</li>\n<li>\n<p><code>-I</code> 邮箱(可使用其他值)</p>\n</li>\n<li>\n<p><code>-n</code> namespace</p>\n</li>\n<li>\n<p><code>-s</code> 签名</p>\n</li>\n<li>\n<p>被签名的内容，从标准输入读取</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>输出</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">Good \"git\" signature for notfound@notfound.cn with ED25519 key SHA256:q0FZbVN2eFXQYON1n85nYhMAFfV1hk65Wt88YuQ2WF0</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://man.openbsd.org/ssh_config#ServerAliveInterval\" class=\"bare\">https://man.openbsd.org/ssh_config#ServerAliveInterval</a></p>\n</li>\n<li>\n<p><a href=\"https://einverne.github.io/post/2017/05/ssh-keep-alive.html\" class=\"bare\">https://einverne.github.io/post/2017/05/ssh-keep-alive.html</a></p>\n</li>\n<li>\n<p><a href=\"https://askubuntu.com/questions/87956/can-you-set-passwords-in-ssh-config-to-allow-automatic-login\" class=\"bare\">https://askubuntu.com/questions/87956/can-you-set-passwords-in-ssh-config-to-allow-automatic-login</a></p>\n</li>\n<li>\n<p><a href=\"https://wangdoc.com/ssh/basic.html\" class=\"bare\">https://wangdoc.com/ssh/basic.html</a></p>\n</li>\n<li>\n<p><a href=\"https://www.agwa.name/blog/post/ssh_signatures\" class=\"bare\">https://www.agwa.name/blog/post/ssh_signatures</a></p>\n</li>\n<li>\n<p><a href=\"https://www.cnblogs.com/f-ck-need-u/p/10482832.html\" class=\"bare\">https://www.cnblogs.com/f-ck-need-u/p/10482832.html</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"SSH 配置"},"pageAttributes":{"slug":"ssh-config","category":"tool"},"revision":{"date":"2020-05-01","number":"1.0"}}},"pageContext":{"id":"16f081c1-ceec-5c6a-864d-afd75a5bf946","pageAttributes__slug":"ssh-config","__params":{"pageAttributes__slug":"ssh-config"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}