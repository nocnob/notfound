{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/kafka-start/","result":{"data":{"asciidoc":{"id":"8f80a662-67ed-55cc-b776-ea46f59b11e4","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>系统 Ubuntu 22.04</p>\n</li>\n<li>\n<p>Kafka 3.3.1</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_获取_kafka\"><a class=\"anchor\" href=\"#_获取_kafka\"></a>获取 Kafka</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>下载安装 kafka ：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 安装 Java 17 (Java 8+)\nsudo apt install openjdk-17-jre\n# 下载\nwget https://downloads.apache.org/kafka/3.3.1/kafka_2.13-3.3.1.tgz\n# 解压\nsudo tar -zxvf kafka_2.13-3.3.1.tgz -C /opt\n# 重命名\nsudo mv /opt/kafka_2.13-3.3.1 /opt/kafka\n# 修改权限\nsudo chown -R $(id -u):$(id -g) /opt/kafka</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_运行_kafka\"><a class=\"anchor\" href=\"#_运行_kafka\"></a>运行 Kafka</h2>\n<div class=\"sectionbody\">\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>修改配置文件：</p>\n<div class=\"listingblock\">\n<div class=\"title\">config/kraft/server.properties</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-properties\" data-lang=\"properties\"># kafka 日志目录\nlog.dirs=/opt/kafka/kraft-combined-log\n# 默认分区数\nnum.partitions=4\n# 禁止自动创建主题\nauto.create.topics.enable=false</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>生成集群 UUID，同一个集群要使用相同的 UUID ：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">KAFKA_CLUSTER_ID=\"$(bin/kafka-storage.sh random-uuid)\"</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>格式化日志目录，会生成 <code>bootstrap.checkpoint</code> 和 <code>meta.properties</code> 两个文件，其中 <code>meta.properties</code> 包含了集群和节点 ID ：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">bin/kafka-storage.sh format -t $KAFKA_CLUSTER_ID -c config/kraft/server.properties</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>启动 Kafka 服务：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 启动\nbin/kafka-server-start.sh -daemon config/kraft/server.properties\n# 停止\nbin/kafka-server-stop.sh</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>-daemon</code> 守护进程方式启动，启动日志保存在 <code>logs</code> 目录。</p>\n</li>\n</ul>\n</div>\n</li>\n</ol>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_常用命令\"><a class=\"anchor\" href=\"#_常用命令\"></a>常用命令</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_主题操作\"><a class=\"anchor\" href=\"#_主题操作\"></a>主题操作</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export broker=localhost:9092\nexport topic=quickstart-events\n\n# 创建主题\nbin/kafka-topics.sh --bootstrap-server $broker --create --topic $topic\n# 查看主题列表\nbin/kafka-topics.sh --bootstrap-server $broker --list\n# 查看主题详情\nbin/kafka-topics.sh --bootstrap-server $broker --describe --topic $topic\n# 增加主题分区数，无法减少\nbin/kafka-topics.sh --bootstrap-server $broker --alter --topic $topic --partitions 8\n# 删除主题\nbin/kafka-topics.sh --bootstrap-server $broker --delete --topic $topic</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>主题详情示例：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">Topic: quickstart-events        TopicId: o9gbGYYTTmCbF7xToxRD8Q PartitionCount: 4       ReplicationFactor: 1    Configs: segment.bytes=1073741824\n        Topic: quickstart-events        Partition: 0    Leader: 1       Replicas: 1     Isr: 1\n        Topic: quickstart-events        Partition: 1    Leader: 1       Replicas: 1     Isr: 1\n        Topic: quickstart-events        Partition: 2    Leader: 1       Replicas: 1     Isr: 1\n        Topic: quickstart-events        Partition: 3    Leader: 1       Replicas: 1     Isr: 1</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>字段说明：</p>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<colgroup>\n<col style=\"width: 50%;\">\n<col style=\"width: 50%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">字段</th>\n<th class=\"tableblock halign-left valign-top\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Topic</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">主题名</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">TopicId</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">主题 ID</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">PartitionCount</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">分区数量</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ReplicationFactor</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">复制因子</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">segment.bytes</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">日志片段大小</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Partition</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">分区 ID</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Leader</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">首领</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Replicas</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">副本集合</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Isr (in-sync replicas)</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">同步副本集合</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_生产消费\"><a class=\"anchor\" href=\"#_生产消费\"></a>生产、消费</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export broker=localhost:9092\nexport topic=quickstart-events\n\n# 生产\nbin/kafka-console-producer.sh --bootstrap-server $broker --topic $topic\nThis is my first event\nThis is my second event\n# Ctrl+D/Ctrl+C\n\n# 消费\nbin/kafka-console-consumer.sh --bootstrap-server $broker --topic $topic --from-beginning\n# Ctrl+C</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>--from-beginning</code> 如果消费者还没有一个确定的偏移量来消费，那么从日志中出现的最早消息而不是最新消息开始。</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_消费者群组\"><a class=\"anchor\" href=\"#_消费者群组\"></a>消费者群组</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export broker=localhost:9092\nexport topic=quickstart-events\n\n# 查看消费者群组列表\nbin/kafka-consumer-groups.sh --bootstrap-server $broker --list\n# 查看消费者群组详情\nbin/kafka-consumer-groups.sh --bootstrap-server $broker --describe --group $group\n# 删除消费者群组，操作前需要关闭所有消费者\nbin/kafka-consumer-groups.sh --bootstrap-server $broker --delete --group $group</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>消费者群组详情示例：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">GROUP                  TOPIC             PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                           HOST            CLIENT-ID\nconsole-consumer-72635 quickstart-events 0          -               0               -               console-consumer-ecce13ae-89f1-4c61-95df-c5ca2dbb018c /127.0.0.1      console-consumer\nconsole-consumer-72635 quickstart-events 1          -               0               -               console-consumer-ecce13ae-89f1-4c61-95df-c5ca2dbb018c /127.0.0.1      console-consumer\nconsole-consumer-72635 quickstart-events 2          -               0               -               console-consumer-ecce13ae-89f1-4c61-95df-c5ca2dbb018c /127.0.0.1      console-consumer\nconsole-consumer-72635 quickstart-events 3          -               2               -               console-consumer-ecce13ae-89f1-4c61-95df-c5ca2dbb018c /127.0.0.1      console-consumer</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>字段说明：</p>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<colgroup>\n<col style=\"width: 50%;\">\n<col style=\"width: 50%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">字段</th>\n<th class=\"tableblock halign-left valign-top\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">GROUP</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">消费者群组名</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">TOPIC</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">主题名</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">PARTITION</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">分区 ID</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">CURRENT-OFFSET</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">消费者群组最近提交的偏移量，也就是消费者在分区里读取的当前位置</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">LOG-END-OFFSET</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">当前高水位偏移量，也就是最近一个被读取消息的偏移量，同时也是最近一个被提交到集群的偏移量</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">LAG</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">消费者的 CURRENT-OFFSET 和 broker 的 LOG-END-OFFSET 之间的差距</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">CONSUMER-ID</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">消费者 ID</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">HOST</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">客户端主机</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">CLIENT-ID</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">客户端 ID</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_动态配置\"><a class=\"anchor\" href=\"#_动态配置\"></a>动态配置</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export broker=localhost:9092\nexport topic=quickstart-events\n\n# 查看被覆盖的配置\nbin/kafka-configs.sh --bootstrap-server $broker --describe --entity-type topics --entity-name $topic\n# 查看所有配置\nbin/kafka-configs.sh --bootstrap-server $broker --describe --entity-type topics --entity-name $topic --all</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_metadata_shell\"><a class=\"anchor\" href=\"#_metadata_shell\"></a>Metadata Shell</h3>\n<div class=\"paragraph\">\n<p>通过 Metadata Shell 查看元数据。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">$ bin/kafka-metadata-shell.sh --snapshot kraft-combined-logs/__cluster_metadata-0/00000000000000000000.log\nLoading...\nStarting...\n[ Kafka Metadata Shell ]\n&gt;&gt; ls /\nbrokers  features  local  metadataQuorum  producerIds  topicIds  topics\n&gt;&gt; ls /topics\nquickstart-events\n&gt;&gt; cat /topics/quickstart-events/0/data\n{\n  \"partitionId\" : 0,\n  \"topicId\" : \"CGb8nD0BQDu8kNQD_vbR0Q\",\n  \"replicas\" : [ 1 ],\n  \"isr\" : [ 1 ],\n  \"removingReplicas\" : [ ],\n  \"addingReplicas\" : [ ],\n  \"leader\" : -1,\n  \"leaderEpoch\" : 2,\n  \"partitionEpoch\" : 2\n}\n&gt;&gt; exit</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://kafka.apache.org/quickstart\" class=\"bare\">https://kafka.apache.org/quickstart</a></p>\n</li>\n<li>\n<p><a href=\"https://kafka.apache.org/documentation/#kraft\" class=\"bare\">https://kafka.apache.org/documentation/#kraft</a></p>\n</li>\n<li>\n<p>《Kafka 权威指南》</p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"kafka 基本使用 (KRaft，单机)"},"pageAttributes":{"slug":"kafka-start","category":"kafka"},"revision":{"date":"2022-12-14","number":"1.0"}}},"pageContext":{"id":"8f80a662-67ed-55cc-b776-ea46f59b11e4","pageAttributes__slug":"kafka-start","__params":{"pageAttributes__slug":"kafka-start"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}