{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/distribution-etcd-start/","result":{"data":{"asciidoc":{"id":"6321c4fc-4bcd-5b8d-bf19-a63179bf7b65","html":"<div class=\"sect1\">\n<h2 id=\"_安装\">安装</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo mkdir /opt/etcd\nsudo chown $USER:$USER /opt/etcd\n\nETCD_VER=v3.5.7\nGOOGLE_URL=https://storage.googleapis.com/etcd\nDOWNLOAD_URL=${GOOGLE_URL}\n\nwget ${DOWNLOAD_URL}/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz\ntar xzvf etcd-${ETCD_VER}-linux-amd64.tar.gz -C /opt/etcd --strip-components=1\n\nexport PATH=/opt/etcd:$PATH\netcd --version\netcdctl version</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_单机\">单机</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>启动 etcd：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">etcd</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>在当前目录创建 <code>default.etcd</code> 目录保存数据；</p>\n</li>\n<li>\n<p>默认使用 <code>localhost:2379</code> 监听来自客户端的请求；</p>\n</li>\n<li>\n<p>默认使用 <code>localhost:2380</code> 监听 etcd 服务之间的通信。</p>\n</li>\n</ul>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_命令\">命令</h3>\n<div class=\"sect3\">\n<h4 id=\"_put\">put</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 设置键值\netcdctl --endpoints=127.0.0.1:2379 put greeting \"Hello, etcd\"\netcdctl put greeting1 \"Hello, etcd1\"\netcdctl put greeting2 \"Hello, etcd2\"</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_get\">get</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 获取键值\netcdctl get greeting\netcdctl get greeting1 --print-value-only\n# 获取一个范围内的 key，[greeting, greeting2)\netcdctl get greeting greeting2\n#&gt; greeting\n#&gt; Hello, etcd\n#&gt; greeting1\n#&gt; Hello, etcd1\n# 获取以 greeting 开头的所有 key\netcdctl get --prefix greeting\netcdctl get --prefix --limit=2 greeting\n# 获取指定版本以 greeting 开头的所有 key\netcdctl get --prefix --rev=2 greeting\n\n# 获取当前 etcd 服务端版本号\netcdctl get mykey -w=json</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>--endpoints</code> gRPC 端点，默认值为 <code>127.0.0.1:2379</code></p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_del\">del</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 删除一个 key\netcdctl del greeting\n# 删除一个范围内的 key，[greeting, greeting2)\netcdctl del greeting greeting2</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_watch\">watch</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># watch 一个 key\netcdctl watch greeting\n# watch 一个 key，获取从指定版本起的所有变化信息\netcdctl watch --rev=2 greeting</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_lease\">lease</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 租约授予 TTL 10s，租约 TTL 超时后，租约和绑定的 key 都会删除\netcdctl lease grant 10\n#&gt; lease 694d86d641c2d01a granted with TTL(10s)\n# 租约和 key 绑定\netcdctl put --lease=694d86d641c2d01a foo bar\n# 撤销租约，会删除绑定在上面的所有 key\netcdctl lease revoke 694d86d641c2d01a\n# 续租，租约快过期时续租\netcdctl lease keep-alive 694d86d641c2d02a\n# 获取租约 TTL 以及剩余时间\netcdctl lease timetolive --keys 694d86d641c2d02a\n# 获取租约上的 keys\netcdctl lease timetolive 694d86d641c2d02a</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_集群\">集群</h2>\n<div class=\"sectionbody\">\n<table class=\"tableblock frame-all grid-all stretch\">\n<colgroup>\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3334%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">名称</th>\n<th class=\"tableblock halign-left valign-top\">客户端通信地址</th>\n<th class=\"tableblock halign-left valign-top\">服务间通信地址</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">infra1</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">127.0.0.1:12379</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">127.0.0.1:12380</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">infra2</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">127.0.0.1:22379</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">127.0.0.1:22380</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">infra3</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">127.0.0.1:32379</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">127.0.0.1:32380</p></td>\n</tr>\n</tbody>\n</table>\n<div class=\"paragraph\">\n<p>依次启动三个节点：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">etcd --name infra1 --initial-advertise-peer-urls http://127.0.0.1:12380 \\\n  --listen-peer-urls http://0.0.0.0:12380 \\\n  --listen-client-urls http://0.0.0.0:12379 \\\n  --advertise-client-urls http://127.0.0.1:12379 \\\n  --initial-cluster-token etcd-cluster-1 \\\n  --initial-cluster infra1=http://127.0.0.1:12380,infra2=http://127.0.0.1:22380,infra3=http://127.0.0.1:32380 \\\n  --initial-cluster-state new\n\netcd --name infra2 --initial-advertise-peer-urls http://127.0.0.1:22380 \\\n  --listen-peer-urls http://0.0.0.0:22380 \\\n  --listen-client-urls http://0.0.0.0:22379 \\\n  --advertise-client-urls http://127.0.0.1:22379 \\\n  --initial-cluster-token etcd-cluster-1 \\\n  --initial-cluster infra1=http://127.0.0.1:12380,infra2=http://127.0.0.1:22380,infra3=http://127.0.0.1:32380 \\\n  --initial-cluster-state new\n\netcd --name infra3 --initial-advertise-peer-urls http://127.0.0.1:32380 \\\n  --listen-peer-urls http://0.0.0.0:32380 \\\n  --listen-client-urls http://0.0.0.0:32379 \\\n  --advertise-client-urls http://127.0.0.1:32379 \\\n  --initial-cluster-token etcd-cluster-1 \\\n  --initial-cluster infra1=http://127.0.0.1:12380,infra2=http://127.0.0.1:22380,infra3=http://127.0.0.1:32380 \\\n  --initial-cluster-state new</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>--name</code> 名称，<code>--data-dir</code> 为 <code>${name}.etcd</code></p>\n</li>\n<li>\n<p><code>--initial-advertise-peer-urls</code> 向其他成员发布的用于集群节点之间通信监听的 URL</p>\n</li>\n<li>\n<p><code>--listen-peer-urls</code> 集群节点之间通信监听的 URL</p>\n</li>\n<li>\n<p><code>--listen-client-urls</code> 监听客户端请求的 URL</p>\n</li>\n<li>\n<p><code>--advertise-client-urls</code> 向其他成员发布的用户监听客户端请求的 URL</p>\n</li>\n<li>\n<p><code>--initial-cluster-token</code> 集群初始化 token</p>\n</li>\n<li>\n<p><code>--initial-cluster</code> 初始指定的集群配置，指定各节点的 <code>advertise-peer-urls</code></p>\n</li>\n<li>\n<p><code>--initial-cluster-state</code> 初始化集群状态</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>可以和任一服务交互：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">ENDPOINTS=127.0.0.1:12379,127.0.0.1:22379,127.0.0.1:32379\n# 获取集群成员列表\netcdctl --endpoints=$ENDPOINTS member list\n# 获取集群状态信息\netcdctl --endpoints=$ENDPOINTS --write-out=table endpoint status\n# 获取集群健康信息\netcdctl --endpoints=$ENDPOINTS endpoint health</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://github.com/etcd-io/etcd/releases/\" class=\"bare\">https://github.com/etcd-io/etcd/releases/</a></p>\n</li>\n<li>\n<p><a href=\"https://etcd.io/docs/v3.5/quickstart/\" class=\"bare\">https://etcd.io/docs/v3.5/quickstart/</a></p>\n</li>\n<li>\n<p><a href=\"https://etcd.io/docs/v3.5/op-guide/clustering/\" class=\"bare\">https://etcd.io/docs/v3.5/op-guide/clustering/</a></p>\n</li>\n<li>\n<p><a href=\"https://book.douban.com/subject/30386518/\">《云原生分布式存储基石：etcd深入解析》</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"etcd 安装和基本使用"},"pageAttributes":{"slug":"distribution-etcd-start","category":"distribution"},"revision":{"date":"2023-03-10","number":"1.0"}}},"pageContext":{"id":"6321c4fc-4bcd-5b8d-bf19-a63179bf7b65","pageAttributes__slug":"distribution-etcd-start","__params":{"pageAttributes__slug":"distribution-etcd-start"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}