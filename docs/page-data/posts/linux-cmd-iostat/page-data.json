{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/linux-cmd-iostat/","result":{"data":{"asciidoc":{"id":"d5bc9296-73a8-5db3-a7f6-f2a1fb7ef0cf","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>系统环境 Ubuntu 20.04</p>\n</div>\n<div class=\"paragraph\">\n<p><code>iostat</code> 可以获取 CPU 和 IO 设备统计信息，这里我们只关注 IO。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_iostat\"><a class=\"anchor\" href=\"#_iostat\"></a>iostat</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">iostat -dx</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>-d</code> 显示设备利用率报告</p>\n</li>\n<li>\n<p><code>-x</code> 显示扩展的统计信息</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>输出结果如下：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">Device            r/s     rkB/s   rrqm/s  %rrqm r_await rareq-sz     w/s     wkB/s   wrqm/s  %wrqm w_await wareq-sz     d/s     dkB/s   drqm/s  %drqm d_await dareq-sz     f/s f_await  aqu-sz  %util\nnvme0n1         29.06    925.15    13.46  31.66    0.23    31.83   44.07   2957.49    60.43  57.83    3.29    67.11    0.00      0.00     0.00   0.00    0.00     0.00   10.05    0.17    0.15   3.52</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>Device</code> 设备</p>\n</li>\n<li>\n<p><code>r/s</code> 设备每秒完成的读取请求数（合并后）。</p>\n</li>\n<li>\n<p><code>w/s</code> 设备每秒完成的写入请求数（合并后）。</p>\n</li>\n<li>\n<p><code>d/s</code> 设备每秒完成的丢弃请求数（合并后）。</p>\n</li>\n<li>\n<p><code>f/s</code> 设备每秒完成的刷新请求数（合并后）。这会计算磁盘执行的刷新请求。不跟踪分区的刷新请求。在被合并之前，刷新操作被算作写入</p>\n</li>\n<li>\n<p><code>rsec/s (rkB/s, rMB/s)</code> 每秒从设备读取的扇区数（千字节、兆字节）。</p>\n</li>\n<li>\n<p><code>wsec/s (wkB/s, wMB/s)</code> 每秒写入设备的扇区数（千字节、兆字节）。</p>\n</li>\n<li>\n<p><code>dsec/s (dkB/s, dMB/s)</code> 每秒为设备丢弃的扇区数（千字节、兆字节）。</p>\n</li>\n<li>\n<p><code>rrqm/s</code> 每秒合并的排队到设备的读取请求数。</p>\n</li>\n<li>\n<p><code>wrqm/s</code> 每秒合并并排队到设备的写入请求数。</p>\n</li>\n<li>\n<p><code>drqm/s</code> 每秒合并的排队到设备的丢弃请求数。</p>\n</li>\n<li>\n<p><code>%rrqm</code> 在发送到设备之前合并在一起的读取请求的百分比。</p>\n</li>\n<li>\n<p><code>%wrqm</code> 写入请求在发送到设备之前合并在一起的百分比。</p>\n</li>\n<li>\n<p><code>%drqm</code> 在发送到设备之前合并在一起的丢弃请求的百分比。</p>\n</li>\n<li>\n<p><code>rareq-sz</code> 向设备发出的读取请求的平均大小（以千字节为单位）。</p>\n</li>\n<li>\n<p><code>wareq-sz</code> 向设备发出的写入请求的平均大小（以千字节为单位）。</p>\n</li>\n<li>\n<p><code>dareq-sz</code> 向设备发出的丢弃请求的平均大小（以千字节为单位）。</p>\n</li>\n<li>\n<p><code>r_await</code> 向要服务的设备发出读取请求的平均时间（以毫秒为单位）。 这包括队列中的请求所花费的时间以及为它们提供服务所花费的时间。</p>\n</li>\n<li>\n<p><code>w_await</code> 向要服务的设备发出的写入请求的平均时间（以毫秒为单位）。 这包括队列中的请求所花费的时间以及为它们提供服务所花费的时间。</p>\n</li>\n<li>\n<p><code>d_await</code> 向要服务的设备发出丢弃请求的平均时间（以毫秒为单位）。 这包括队列中的请求所花费的时间以及为它们提供服务所花费的时间。</p>\n</li>\n<li>\n<p><code>f_await</code> 向要服务的设备发出刷新请求的平均时间（以毫秒为单位）。 块层结合刷新请求，一次最多执行一个。 因此刷新操作的时间可能是原来的两倍：等待当前的刷新请求，然后执行它，然后等待下一个。</p>\n</li>\n<li>\n<p><code>aqu-sz</code> 向设备发出的请求的平均队列长度。 注意：在以前的版本中，此字段称为 avgqu-sz。</p>\n</li>\n<li>\n<p><code>%util</code> 向设备发出 I/O 请求的已用时间百分比（设备的带宽利用率）。对于串行服务请求的设备，当该值接近 100% 时，会发生设备饱和。但是对于并行处理请求的设备，例如 RAID 阵列和现代 SSD，这个数字并不能反映它们的性能限制。</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_gnuplot_画图\"><a class=\"anchor\" href=\"#_gnuplot_画图\"></a>gnuplot 画图</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_数据\"><a class=\"anchor\" href=\"#_数据\"></a>数据</h3>\n<div class=\"paragraph\">\n<p>通过 iostat 生成数据</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">iostat -dx 1 10 | grep nvme0n1 &gt; iostat.txt</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>每 1 秒采集一次数据，采集 10 次</p>\n</li>\n<li>\n<p>仅显示设备 nvme0n1 这一行</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_画图\"><a class=\"anchor\" href=\"#_画图\"></a>画图</h3>\n<div class=\"listingblock\">\n<div class=\"title\">iostat.gnuplot</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-gnuplot\" data-lang=\"gnuplot\"># set terminal qt persist\nset terminal svg  <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nset output 'iostat.svg' <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\nset title 'iostat -dx 1 10'\n\nset xlabel \"时间 (秒)\"\nset ylabel \"操作次数\"\nset y2label \"百分比\" <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\nset ytics nomirror <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\nset y2tics <i class=\"conum\" data-value=\"5\"></i><b>(5)</b>\nset y2range [0:14] <i class=\"conum\" data-value=\"6\"></i><b>(6)</b>\nset grid <i class=\"conum\" data-value=\"7\"></i><b>(7)</b>\n<i class=\"conum\" data-value=\"8\"></i><b>(8)</b>\nplot \\\n         'iostat.txt' using  2 with lines linewidth 2 axis x1y1 title 'r/s', \\\n         'iostat.txt' using  8 with lines linewidth 2 axis x1y1 title 'w/s', \\\n         'iostat.txt' using 23 with lines linewidth 2 axis x1y2 title '%util'</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>生成 SVG</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>输出文件名</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>设置 y2 （第二坐标轴）标签</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>\n<td>不使用 y1 刻度镜像</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"5\"></i><b>5</b></td>\n<td>添加 y2 刻度标记</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"6\"></i><b>6</b></td>\n<td>设置 y2 范围</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"7\"></i><b>7</b></td>\n<td>设置网格</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"8\"></i><b>8</b></td>\n<td>使用 2、8、23 列划线图</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>之后，执行命令：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">gnuplot iostat.gnuplot</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>生成图片：</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/iostat.svg\" alt=\"iostat\">\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_测试\"><a class=\"anchor\" href=\"#_测试\"></a>测试</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"title\">test.sh</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">#!/bin/bash\n\nulimit -n 16400\n\nargs='--threads=1 --time=30 --file-num=1024 --file-total-size=1G --file-test-mode=rndrw'\ndevise=/dev/sdb4\noptions=\"relatime noatime\"\noutput=$PWD\n\ndevise_name=$(basename $devise)\n\nset -x\nfor option in $options\ndo\n    if [ $option = \"noatime\" ]; then\n        sudo mount -o rw,noatime $devise /mnt/hdd\n        echo \"noatime\"\n    elif [ $option = \"relatime\" ]; then\n        sudo mount $devise /mnt/hdd\n        echo \"relatime\"\n    else\n        exit -1\n    fi\n\n    findmnt /mnt/hdd &gt; $output/$option.txt\n    cd /mnt/hdd/tmp/sysbench\n\n    sysbench fileio $args prepare &gt; $output/$option.prepare.txt\n\n    sleep 10\n\n    iostat -dx 1 $devise | grep --line-buffered $devise_name &gt; $output/$option.run.iostat.txt &amp;\n    systemd-run --user --scope -p MemoryMax=128M sysbench fileio $args run  &gt; $output/$option.run.txt\n    kill %%\n\n    sysbench fileio $args cleanup &gt; $output/$option.cleanup.txt\n\n    cd -\n    sudo umount /mnt/hdd\ndone\n\n# https://askubuntu.com/questions/488324/redirect-an-output-to-a-file-from-command-piping-grep\n# https://unix.stackexchange.com/questions/44985/limit-memory-usage-for-a-single-linux-process</code></pre>\n</div>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">iostat.gnuplot</div>\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-gnuplot\" data-lang=\"gnuplot\">set terminal qt persist\nset title 'iostat relatime and noatime'\nset xlabel \"时间 (秒)\"\nset ylabel \"kB/s\"\nset y2label \"百分比\"\nset ytics nomirror\nset y2tics\nset y2range [0:120]\nset grid\n\nplot \\\n         'relatime.run.iostat.txt' using  3 with lines linewidth 2 axis x1y1 title 'relatime rkB/s', \\\n         'relatime.run.iostat.txt' using  9 with lines linewidth 2 axis x1y1 title 'relatime wkB/s', \\\n         'relatime.run.iostat.txt' using 21 with lines linewidth 2 axis x1y2 title '%util', \\\n         'noatime.run.iostat.txt'  using  3 with lines linewidth 2 axis x1y1 title 'noatime rkB/s', \\\n         'noatime.run.iostat.txt'  using  9 with lines linewidth 2 axis x1y1 title 'noatime wkB/s', \\\n         'noatime.run.iostat.txt'  using 21 with lines linewidth 2 axis x1y2 title '%util'</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>man iostat</p>\n</li>\n<li>\n<p><a href=\"https://book.douban.com/subject/23008813/\">《 高性能MySQL(第3版) 》</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Linux 环境使用 iostat 分析存储设备 IO"},"pageAttributes":{"slug":"linux-cmd-iostat","category":"linux"},"revision":{"date":"2022-07-10","number":"1.0"}}},"pageContext":{"id":"d5bc9296-73a8-5db3-a7f6-f2a1fb7ef0cf","pageAttributes__slug":"linux-cmd-iostat","__params":{"pageAttributes__slug":"linux-cmd-iostat"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}