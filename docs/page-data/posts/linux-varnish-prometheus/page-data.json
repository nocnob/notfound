{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/linux-varnish-prometheus/","result":{"data":{"asciidoc":{"id":"96128b1b-3311-5619-902b-889a5a76edcc","html":"<div class=\"sect1\">\n<h2 id=\"_安装\"><a class=\"anchor\" href=\"#_安装\"></a>安装</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>根据 <a href=\"https://prometheus.io/docs/instrumenting/exporters/\">prometheus exporter 列表</a> 选择第三方维护的https://github.com/jonnenauha/prometheus_varnish_exporter/[Varnish exporter]。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">wget https://github.com/jonnenauha/prometheus_varnish_exporter/releases/download/1.6.1/prometheus_varnish_exporter-1.6.1.linux-amd64.tar.gz\ntar -zxvf prometheus_varnish_exporter-1.6.1.linux-amd64.tar.gz\ncd prometheus_varnish_exporter-1.6.1.linux-amd64/</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>varnish 以用户 <code>vcache</code> 身份运行，因此，需要以用户 <code>vcache</code> 身份运行 prometheus_varnish_exporter。https://github.com/jonnenauha/prometheus_varnish_exporter/issues/62[参考]</p>\n</div>\n<div class=\"paragraph\">\n<p>prometheus_varnish_exporter 使用命令 varnishstat 采集数据，先通过用户 <code>vcache</code> 测试 varnishstat：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo -u vcache varnishstat -j</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>通过用户 <code>vcache</code> 测试 exporter：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo -u vcache ./prometheus_varnish_exporter -test</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>确定无误后，启动 exporter ：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo -u vcache ./prometheus_varnish_exporter</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>访问 exporter 数据 <a href=\"http://127.0.0.1:9131/metrics\" class=\"bare\">http://127.0.0.1:9131/metrics</a></p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_systemd_管理_exporter\"><a class=\"anchor\" href=\"#_systemd_管理_exporter\"></a>Systemd 管理 exporter</h3>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>新文件 exporter 配置文件 <code>/usr/local/etc/prometheus_varnish_exporter</code>：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-conf\" data-lang=\"conf\">OPTIONS=\"-web.listen-address :9131\"</code></pre>\n</div>\n</div>\n</li>\n<li>\n<p>新建 systemd 配置文件 <code>/usr/lib/systemd/system/prometheus_varnish_exporter.service</code>：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-systemd\" data-lang=\"systemd\">[Unit]\nDescription=Prometheus Varnish Exporter\nAfter=network.target\n\n[Service]\nUser=vcache\nEnvironmentFile=/usr/local/etc/prometheus_varnish_exporter\nExecStart=/usr/local/bin/prometheus_varnish_exporter $OPTIONS\n\n[Install]\nWantedBy=multi-user.target</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>通过环境变量传递参数</p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p>启动 exporter</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo systemctl start prometheus_varnish_exporter.service</code></pre>\n</div>\n</div>\n</li>\n</ol>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_配置指标\"><a class=\"anchor\" href=\"#_配置指标\"></a>配置指标</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>exporter 提供了 <a href=\"https://github.com/jonnenauha/prometheus_varnish_exporter/blob/master/dashboards/jonnenauha/dashboard.json\">grafana dashboard.json</a>，复制即可使用</p>\n</div>\n<div class=\"paragraph\">\n<p><span class=\"image\"><img src=\"https://raw.githubusercontent.com/jonnenauha/prometheus_varnish_exporter/master/dashboards/jonnenauha/dashboard.png\" alt=\"image\"></span></p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://github.com/jonnenauha/prometheus_varnish_exporter\" class=\"bare\">https://github.com/jonnenauha/prometheus_varnish_exporter</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Linux Varnish 添加 Prometheus 监控"},"pageAttributes":{"slug":"linux-varnish-prometheus","category":"varnish"},"revision":{"date":"2022-02-22","number":"1.0"}}},"pageContext":{"id":"96128b1b-3311-5619-902b-889a5a76edcc","pageAttributes__slug":"linux-varnish-prometheus","__params":{"pageAttributes__slug":"linux-varnish-prometheus"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}