{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/postgresql-listen-notify/","result":{"data":{"asciidoc":{"id":"d16d6df3-85f6-5334-969d-7f26503d713b","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>PostgreSQL 实现了轻量级消息队列。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_listennotify\"><a class=\"anchor\" href=\"#_listennotify\"></a>Listen/Notify</h2>\n<div class=\"sectionbody\">\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>消费者 Listen（终端 1)：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">LISTEN virtual; <i class=\"conum\" data-value=\"1\"></i><b>(1)</b></code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>监听 channel <code>virtual</code>，连接到同一个数据库的不同会话都会接收到通知（广播）。</td>\n</tr>\n</table>\n</div>\n</li>\n<li>\n<p>生产者 Notify（终端 2），有种方式生成通知</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">NOTIFY virtual, 'This is the payload 1'; <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nNOTIFY virtual, 'This is the payload 2';\n\nSELECT pg_notify('virtual', 'select payload 1'); <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\nSELECT pg_notify('virtual', 'select payload 2');</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>通过 <code>NOTIFY</code> 生成通知</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>通过 <code>pg_notify</code> 生成通知</td>\n</tr>\n</table>\n</div>\n</li>\n<li>\n<p>消费者（终端 1)：</p>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">select now(); <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n--               now\n-- -------------------------------\n--  2022-06-22 17:44:46.764593+08\n-- (1 行记录)\n--  <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n-- 从PID为128203的服务器进程接收到带有字节流量\"This is the payload 1\"的异步通知消息\"virtual\".\n-- 从PID为128203的服务器进程接收到带有字节流量\"This is the payload 2\"的异步通知消息\"virtual\".\n-- 从PID为128203的服务器进程接收到带有字节流量\"This is the payload 3\"的异步通知消息\"virtual\".\n-- 从PID为128203的服务器进程接收到带有字节流量\"select payload 1\"的异步通知消息\"virtual\".\n-- 从PID为128203的服务器进程接收到带有字节流量\"select payload 2\"的异步通知消息\"virtual\".</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>在终端需要通过执行 SQL 检测通知事件，使用 libpq 等直接调用监听方法即可。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>如果连续发送多个消息，消息会被一次接收</td>\n</tr>\n</table>\n</div>\n</li>\n</ol>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://www.postgresql.org/docs/current/sql-listen.html\" class=\"bare\">https://www.postgresql.org/docs/current/sql-listen.html</a></p>\n</li>\n<li>\n<p><a href=\"https://www.postgresql.org/docs/current/sql-notify.html\" class=\"bare\">https://www.postgresql.org/docs/current/sql-notify.html</a></p>\n</li>\n<li>\n<p><a href=\"https://tapoueh.org/blog/2018/07/postgresql-listen-notify/\" class=\"bare\">https://tapoueh.org/blog/2018/07/postgresql-listen-notify/</a></p>\n</li>\n<li>\n<p><a href=\"http://mysql.taobao.org/monthly/2015/06/06/\" class=\"bare\">http://mysql.taobao.org/monthly/2015/06/06/</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"PostgreSQL Listen Notify"},"pageAttributes":{"slug":"postgresql-listen-notify","category":"database"},"revision":{"date":"2022-06-16","number":"1.0"}}},"pageContext":{"id":"d16d6df3-85f6-5334-969d-7f26503d713b","pageAttributes__slug":"postgresql-listen-notify","__params":{"pageAttributes__slug":"postgresql-listen-notify"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}