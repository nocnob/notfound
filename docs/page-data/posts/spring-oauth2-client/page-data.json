{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/spring-oauth2-client/","result":{"data":{"asciidoc":{"id":"9aea6093-cb4d-5a50-adad-5f2652c678de","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Spring Boot 2.5.5</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_依赖\"><a class=\"anchor\" href=\"#_依赖\"></a>依赖</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-gradle\" data-lang=\"gradle\">implementation 'org.springframework.boot:spring-boot-starter-security'\nimplementation 'org.springframework.boot:spring-boot-starter-web'\nimplementation 'org.springframework.boot:spring-boot-starter-oauth2-client'</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_配置\"><a class=\"anchor\" href=\"#_配置\"></a>配置</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>修改 <code>application.properties</code></p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-properties\" data-lang=\"properties\">spring.security.oauth2.client.registration.github.client-id=CLIENT_ID\nspring.security.oauth2.client.registration.github.client-secret=CLIENT_SECRET\nspring.security.oauth2.client.registration.github.scope=read:user</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_代码\"><a class=\"anchor\" href=\"#_代码\"></a>代码</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>添加 <code>SecurityConfig.java</code> 开启 oauth2 登陆功能:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">@EnableWebSecurity\npublic class SecurityConfig extends WebSecurityConfigurerAdapter {\n    @Override\n    protected void configure(HttpSecurity http) throws Exception {\n        http.authorizeRequests((requests) -&gt; requests.anyRequest().authenticated());\n        http.oauth2Login();\n    }\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>添加 <code>HomeController.java</code> 获取当前用户:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">@RestController\npublic class HomeController {\n    @GetMapping(\"/\")\n    public ResponseEntity&lt;String&gt; index(Authentication authentication) {\n        return ResponseEntity.ok(\"Hello, \" + authentication.getName());\n    }\n}</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_登陆过程\"><a class=\"anchor\" href=\"#_登陆过程\"></a>登陆过程</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>客户端将浏览器重定向到授权端点：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">GET http://localhost:8080/oauth2/authorization/github\nReferer: http://localhost:8080/login\n\n# 响应\nHTTP/1.1 302\nhttps://github.com/login/oauth/authorize?response_type=code&amp;client_id=532062cd2c5d82582dd5&amp;scope=read:user public_repo&amp;state=yDLHE9yFhA8X6P3hoTeZdirVXp2XTER1IghdjIM6W5A=&amp;redirect_uri=http://localhost:8080/login/oauth2/code/github</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>OAuth2AuthorizationRequestRedirectFilter#doFilterInternal</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>DefaultOAuth2AuthorizationRequestResolver#resolve</code> 创建 OAuth2AuthorizationRequest</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>DefaultOAuth2AuthorizationRequestResolver#resolve</code> 创建 OAuth2AuthorizationRequest</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>InMemoryClientRegistrationRepository#findByRegistrationId</code> 通过 <code>registrationId</code>(github) 查询 ClientRegistration</p>\n</li>\n<li>\n<p><code>DefaultOAuth2AuthorizationRequestResolver#expandRedirectUri</code> 计算 redirect url</p>\n</li>\n<li>\n<p><code>OAuth2AuthorizationRequest.Build</code> 通过 builder 构建 <code>OAuth2AuthorizationRequest</code></p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p><code>OAuth2AuthorizationRequestRedirectFilter#sendRedirectForAuthorization</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>HttpSessionOAuth2AuthorizationRequestRepository#saveAuthorizationRequest</code> 将 <code>authorizationRequest</code> 保存到 session</p>\n</li>\n<li>\n<p>DefaultRedirectStrategy#sendRedirect 重定向</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>资源所有者向授权服务器进行身份认证，并向客户端授权，授权服务器将浏览器重定向到客户端，并携带授权码：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">GET https://github.com/login/oauth/authorize?response_type=code&amp;client_id=532062cd2c5d82582dd5&amp;scope=read:user%20public_repo&amp;state=yDLHE9yFhA8X6P3hoTeZdirVXp2XTER1IghdjIM6W5A%3D&amp;redirect_uri=http://localhost:8080/login/oauth2/code/github\nReferer: http://localhost:8080/\n\n# 响应\nHTTP/1.1 302\nLocation: http://localhost:8080/login/oauth2/code/github?code=2208a051c97858d376b9&amp;state=yDLHE9yFhA8X6P3hoTeZdirVXp2XTER1IghdjIM6W5A%3D</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>客户端将授权码和自身凭据发送至令牌端点，授权服务器向客户端发送令牌，客户端向首保护资源发送令牌：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">GET http://localhost:8080/login/oauth2/code/github?code=2208a051c97858d376b9&amp;state=yDLHE9yFhA8X6P3hoTeZdirVXp2XTER1IghdjIM6W5A%3D\nReferer: http://localhost:8080/\n\n# 响应\nHTTP/1.1 302\nLocation: http://localhost:8080/\nSet-Cookie: JSESSIONID=2DABF2CECF52AB6AF4F16351202F4435; Path=/; HttpOnly</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>OAuth2LoginAuthenticationFilter#requiresAuthentication</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>HttpSessionOAuth2AuthorizationRequestRepository#removeAuthorizationRequest</code> session 中读取 OAuth2AuthorizationRequest 后移除</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>HttpSessionOAuth2AuthorizationRequestRepository#getAuthorizationRequests</code> 从 session 中获取 <code>OAuth2AuthorizationRequest</code></p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p><code>InMemoryClientRegistrationRepository#findByRegistrationId</code> 查询 Registration</p>\n</li>\n<li>\n<p><code>new OAuth2LoginAuthenticationToken</code> 创建认证对象</p>\n</li>\n<li>\n<p><code>OAuth2LoginAuthenticationToken#setDetails</code> 创建认证对象</p>\n</li>\n<li>\n<p><code>OAuth2LoginAuthenticationProvider#authenticate</code> 认证</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>OAuth2AuthorizationCodeAuthenticationProvider#authenticate</code> 对比 state</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>DefaultAuthorizationCodeTokenResponseClient#getTokenResponse</code> 获取 token</p>\n</li>\n<li>\n<p><code>DefaultOAuth2UserService#loadUser</code> 加载用户信息</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>DefaultOAuth2UserService#getResponse</code> 使用 token 查询用户信息</p>\n</li>\n<li>\n<p>通过返回的用户信息创建 <code>DefaultOAuth2User</code></p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p>创建 <code>OAuth2LoginAuthenticationToken</code>，设置后返回</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p><code>AbstractAuthenticationProcessingFilter#successfulAuthentication</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SecurityContextHolder.getContext().setAuthentication()</code> 在 context 中设置认证信息</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>需要 session 保存 OAuth2AuthorizationRequest 对象，<code>/oauth2/authorization/github</code> 和 <code>/login/oauth2/code/github</code> 要使用同一个 session</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>《OAuth2 实战》</p>\n</li>\n<li>\n<p><a href=\"https://spring.io/guides/tutorials/spring-boot-oauth2/\" class=\"bare\">https://spring.io/guides/tutorials/spring-boot-oauth2/</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Spring OAuth2 Client"},"pageAttributes":{"slug":"spring-oauth2-client","category":"spring"},"revision":{"date":"2021-10-26","number":"1.0"}}},"pageContext":{"id":"9aea6093-cb4d-5a50-adad-5f2652c678de","pageAttributes__slug":"spring-oauth2-client","__params":{"pageAttributes__slug":"spring-oauth2-client"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}