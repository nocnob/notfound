{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/grpc-proto-custom-options/","result":{"data":{"asciidoc":{"id":"864eb2c2-47ac-5743-b6d1-34143ffb684c","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>可对多种结构使用自定义 options：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>google.protobuf.FileOptions</p>\n</li>\n<li>\n<p>google.protobuf.MessageOptions</p>\n</li>\n<li>\n<p>google.protobuf.FieldOptions</p>\n</li>\n<li>\n<p>google.protobuf.OneofOptions</p>\n</li>\n<li>\n<p>google.protobuf.EnumOptions</p>\n</li>\n<li>\n<p>google.protobuf.EnumValueOptions</p>\n</li>\n<li>\n<p>google.protobuf.ServiceOptions</p>\n</li>\n<li>\n<p>google.protobuf.MethodOptions</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>测试代码改自 <a href=\"/posts/grpc-go-start/\">Go gRPC 基本使用</a></p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_proto\">proto</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>以 <code>MethodOptions</code> 为例，需要区分 RPC 方法操作类型是读(QUERY)或写(MUTATION)。</p>\n</div>\n<div class=\"paragraph\">\n<p>创建 proto 文件, 文件中包含了四种不同的 RPC 模式：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-protobuf\" data-lang=\"protobuf\">syntax = \"proto3\";\n\nimport \"google/protobuf/descriptor.proto\"; <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\noption go_package = \"grpc.examples/proto/echo\";\n\npackage examples;\n\nenum Operation {\n  UNKNOWN = 0;\n  QUERY = 1;\n  MUTATION = 2;\n}\n\nextend google.protobuf.MethodOptions { <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n  optional Operation op = 1000;\n}\n\n// EchoRequest is the request for echo.\nmessage EchoRequest {\n  string message = 1;\n}\n\n// EchoResponse is the response for echo.\nmessage EchoResponse {\n  string message = 1;\n}\n\n// Echo is the echo service.\nservice Echo {\n  // UnaryEcho is unary echo.\n  rpc UnaryEcho(EchoRequest) returns (EchoResponse) {\n    option (op) = QUERY; <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n  }\n  // ServerStreamingEcho is server side streaming.\n  rpc ServerStreamingEcho(EchoRequest) returns (stream EchoResponse) {\n    option (op) = MUTATION;\n  }\n  // ClientStreamingEcho is client side streaming.\n  rpc ClientStreamingEcho(stream EchoRequest) returns (EchoResponse) {\n    option (op) = QUERY;\n  }\n  // BidirectionalStreamingEcho is bidi streaming.\n  rpc BidirectionalStreamingEcho(stream EchoRequest) returns (stream EchoResponse) {}\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>自定义 options 在文件 <code>google/protobuf/descriptor.proto</code> 中，需要导入该文件；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>扩展 <code>google.protobuf.MethodOptions</code> 添加自定义字段 <code>op</code>；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>在 RPC 方法中设置自定义字段并设置值。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_main\">main</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>读取 option 信息：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-go\" data-lang=\"go\">package main\n\nimport (\n\t\"fmt\"\n\t\"log\"\n\n\t\"google.golang.org/protobuf/proto\"\n\t\"google.golang.org/protobuf/reflect/protodesc\"\n\t\"google.golang.org/protobuf/reflect/protoregistry\"\n\n\tpb \"grpc.examples/proto/echo\"\n)\n\nfunc main() {\n\tfd, err := protoregistry.GlobalFiles.FindFileByPath(\"echo/echo.proto\") <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\tif err != nil {\n\t\tlog.Fatalln(err)\n\t}\n\n\tfdp := protodesc.ToFileDescriptorProto(fd) <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n\tfor _, svc := range fdp.GetService() {\n\t\tfor _, method := range svc.GetMethod() {\n\t\t\tfmt.Printf(\"/%s.%s/%s: \", fdp.GetPackage(), svc.GetName(), method.GetName())\n\t\t\toptions := method.GetOptions()\n\t\t\tif proto.HasExtension(options, pb.E_Op) {\n\t\t\t\tfmt.Printf(\"op=%s\\n\", proto.GetExtension(options, pb.E_Op).(pb.Operation)) <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n\t\t\t} else {\n\t\t\t\tfmt.Println(\"\")\n\t\t\t}\n\t\t}\n\t}\n}</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>导入 <code>grpc.examples/proto/echo</code> 后，pb 文件信息被添加到 <code>protoregistry.GlobalFiles</code>，之后可通过 proto 文件路径查询；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>转换；</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>获取 option 信息。</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p><code>FileDescriptorProto</code> 中可以获取：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>func (*FileDescriptorProto) GetService</code> ：获取 service</p>\n</li>\n<li>\n<p><code>func (*FileDescriptorProto) GetMessageType</code>：获取 message</p>\n</li>\n<li>\n<p><code>func (*FileDescriptorProto) GetEnumType()</code>：获取 enum</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://protobuf.dev/programming-guides/proto/#customoptions\" class=\"bare\">https://protobuf.dev/programming-guides/proto/#customoptions</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"gRPC proto 自定义 options"},"pageAttributes":{"slug":"grpc-proto-custom-options","category":"grpc"},"revision":{"date":"2023-03-03","number":"1.0"}}},"pageContext":{"id":"864eb2c2-47ac-5743-b6d1-34143ffb684c","pageAttributes__slug":"grpc-proto-custom-options","__params":{"pageAttributes__slug":"grpc-proto-custom-options"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}