{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/ruby-gc/","result":{"data":{"asciidoc":{"id":"33c83c22-82c6-5e9b-ab6d-7418c4d8dfed","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\"># ruby 2.7.2\n\n{\n  :count=&gt;24,          # GC 次数\n  :minor_gc_count=&gt;20, # 尝试回收生存时间小于等于 3 个 GC 周期的对象\n  :major_gc_count=&gt;4,  # 尝试回收所有对象\n  :compact_count=&gt;0,   # 压缩移动对象次数，可减少内存碎片\n\n  :heap_sorted_length=&gt;119,\n\n  :heap_available_slots=&gt;48505,  # 所有 slots 数量\n  :heap_live_slots=&gt;48330,       # 存活 slots 数量\n  :heap_free_slots=&gt;175,         # 空闲 slots 数量\n  :heap_final_slots=&gt;0,          #\n  :heap_marked_slots=&gt;36741,     # 旧对象 slots 数量\n\n  :heap_allocated_pages=&gt;119,    # 已分配堆 page 数量\n  :heap_allocatable_pages=&gt;0,    # 可分配堆 page 数量\n\n  :heap_eden_pages=&gt;119,\n  :heap_tomb_pages=&gt;0,\n  :total_allocated_pages=&gt;119,\n  :total_freed_pages=&gt;0,\n\n  :total_allocated_objects=&gt;200406,\n  :total_freed_objects=&gt;152076,\n\n  :remembered_wb_unprotected_objects=&gt;434,\n  :remembered_wb_unprotected_objects_limit=&gt;644,\n\n  :old_objects=&gt;35848,           # 老对象数量\n  :old_objects_limit=&gt;56878,\n\n  :malloc_increase_bytes=&gt;81712,             # 堆外对象分配的空间\n  :malloc_increase_bytes_limit=&gt;16777216,\n  :oldmalloc_increase_bytes=&gt;1243928,        # old 堆外对象分配空间\n  :oldmalloc_increase_bytes_limit=&gt;16777216\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>测试代码</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">#!/usr/bin/env ruby\n\ndef memory_usage\n  # KB\n  File.read('/proc/self/status').match(/VmRSS:\\s+(\\d+)/)[1].to_f\nend\n\ndef memory\n  puts \"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;\"\n  puts gc_stat\n  puts memory_usage\n  yield\n  puts gc_stat\n  puts memory_usage\n  puts \"&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;\"\nend\n\ndef gc_stat\n  GC.stat.slice(\n    :count,\n    :heap_live_slots,\n    :heap_free_slots,\n    :heap_available_slots,\n    :malloc_increase_bytes,\n  )\nend\n\ndef main\n  memory do\n    str = \"a\" * 10_000_000\n    #arr = 10_000_000.times.map(&amp;:to_s)\n  end\n\n  memory do\n    GC.start\n  end\nend</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_长字符串\"><a class=\"anchor\" href=\"#_长字符串\"></a>长字符串</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><code>str = \"a\" * 10_000_000</code> 前后</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">{:major_gc_count=&gt;1, :minor_gc_count=&gt;7, :heap_live_slots=&gt;18305, :heap_free_slots=&gt;35, :heap_available_slots=&gt;18340, :malloc_increase_bytes=&gt;144584}\n22488.0\n{:major_gc_count=&gt;1, :minor_gc_count=&gt;7, :heap_live_slots=&gt;18300, :heap_free_slots=&gt;40, :heap_available_slots=&gt;18340, :malloc_increase_bytes=&gt;10150208}\n32244.0</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>heap_available_slots</code>: 没有发生变化</p>\n</li>\n<li>\n<p><code>malloc_increase_bytes</code>: +9.54 MB</p>\n</li>\n<li>\n<p>内存变化: +9.53 MB</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>说明 在堆中分配</p>\n</div>\n<div class=\"paragraph\">\n<p><code>GC.start</code> 前后</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">{:major_gc_count=&gt;1, :minor_gc_count=&gt;7, :heap_live_slots=&gt;18207, :heap_free_slots=&gt;133, :heap_available_slots=&gt;18340, :malloc_increase_bytes=&gt;10153000}\n32244.0\n{:major_gc_count=&gt;2, :minor_gc_count=&gt;7, :heap_live_slots=&gt;14605, :heap_free_slots=&gt;4143, :heap_available_slots=&gt;18748, :malloc_increase_bytes=&gt;3576}\n22548.0</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>内存变化: -9.47 MB</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>堆中内存大部分都会释放</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_长数组\"><a class=\"anchor\" href=\"#_长数组\"></a>长数组</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">{:count=&gt;8, :heap_live_slots=&gt;18305, :heap_free_slots=&gt;39, :heap_available_slots=&gt;18344, :malloc_increase_bytes=&gt;143440}\n22408.0\n{:count=&gt;27, :heap_live_slots=&gt;10014612, :heap_free_slots=&gt;124, :heap_available_slots=&gt;10014736, :malloc_increase_bytes=&gt;904}\n540508.0</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>heap_live_slots</code>: 10 M, 每个字符一个 slot</p>\n</li>\n<li>\n<p>内存变化: + 505.97 MB</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>40 bytes * 10 M = 400MB</p>\n</div>\n<div class=\"paragraph\">\n<p><code>GC.start</code> 前后</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">{:count=&gt;27, :heap_live_slots=&gt;10014637, :heap_free_slots=&gt;99, :heap_available_slots=&gt;10014736, :malloc_increase_bytes=&gt;3568}\n540508.0\n{:count=&gt;28, :heap_live_slots=&gt;14604, :heap_free_slots=&gt;5169255, :heap_available_slots=&gt;5183859, :malloc_increase_bytes=&gt;904}\n462480.0</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>内存变化: -76.20MB</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>很多内存并没有释放</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://ruby-china.org/topics/27057\">关于 Ruby 内存使用的一些优化和探索</a></p>\n</li>\n<li>\n<p><a href=\"https://ruby-china.org/topics/37982\">Understanding Ruby GC through GC.stat</a></p>\n</li>\n<li>\n<p><a href=\"https://www.jianshu.com/p/e4f184e92375\">Ruby 内存分配</a></p>\n</li>\n<li>\n<p><a href=\"https://ruby-china.org/topics/25790\">How Ruby Uses Memory</a></p>\n</li>\n<li>\n<p><a href=\"https://ruby-china.org/topics/37699\">Ruby 的好朋友 – jemalloc</a></p>\n</li>\n<li>\n<p><a href=\"https://www.jianshu.com/p/af6549f3eda0\">Ruby GC自述</a></p>\n</li>\n<li>\n<p><a href=\"https://ruby-china.org/topics/37699\">Ruby 的好朋友 – jemalloc</a></p>\n</li>\n<li>\n<p><a href=\"https://www.jianshu.com/p/cf98f86e82d7\">Malloc 会加倍 Ruby 多线程应用的内存消耗</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Ruby GC"},"pageAttributes":{"slug":"ruby-gc","category":"ruby"},"revision":{"date":"2021-01-20","number":"1.0"}}},"pageContext":{"id":"33c83c22-82c6-5e9b-ab6d-7418c4d8dfed","pageAttributes__slug":"ruby-gc","__params":{"pageAttributes__slug":"ruby-gc"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}