{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/spring-login-remember-me/","result":{"data":{"asciidoc":{"id":"3d483926-4d37-585b-871b-f6d2279e35a3","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Spring Boot 2.5.5</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_依赖\"><a class=\"anchor\" href=\"#_依赖\"></a>依赖</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-gradle\" data-lang=\"gradle\">implementation 'org.springframework.boot:spring-boot-starter-security'\nimplementation 'org.springframework.boot:spring-boot-starter-web'</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_配置\"><a class=\"anchor\" href=\"#_配置\"></a>配置</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>修改 <code>application.properties</code>，设置用户名和密码</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-properties\" data-lang=\"properties\">spring.security.user.name=admin\nspring.security.user.password=123456</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_代码\"><a class=\"anchor\" href=\"#_代码\"></a>代码</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>配置 rememberMe <code>SecurityConfig.java</code>:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">@EnableWebSecurity\npublic class SecurityConfig extends WebSecurityConfigurerAdapter {\n    @Autowired\n    private UserDetailsService userDetailsService;\n\n    @Override\n    protected void configure(HttpSecurity http) throws Exception {\n        super.configure(http);\n        http.rememberMe()\n                .key(\"1234567890\")\n                .userDetailsService(userDetailsService);\n    }\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>配置 RememberMe <code>key</code> 以及 <code>userDetailsService</code></p>\n</li>\n<li>\n<p>将会使用 <code>TokenBasedRememberMeServices</code> 处理 rememberMe token</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>受保护的资源 <code>HomeController.java</code>:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">@RestController\npublic class HomeController {\n    @GetMapping(\"/\")\n    public ResponseEntity&lt;String&gt; index(Authentication authentication) {\n        return ResponseEntity.ok(\"Hello, \" + authentication.getName());\n    }\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>RememberMe token 格式:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">base64(username + \":\" + expirationTime + \":\" +\n  md5Hex(username + \":\" + expirationTime + \":\" password + \":\" + key))</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>password 为持久化所保存的被 hash 的 <code>password</code></p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_过程\"><a class=\"anchor\" href=\"#_过程\"></a>过程</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_登陆\"><a class=\"anchor\" href=\"#_登陆\"></a>登陆</h3>\n<div class=\"paragraph\">\n<p><code>UsernamePasswordAuthenticationFilter</code> 处理登陆：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>UsernamePasswordAuthenticationFilter#doFilter</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>UsernamePasswordAuthenticationFilter#successfulAuthentication</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>TokenBasedRememberMeServices#loginSuccess</code> 记住登陆状态</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>TokenBasedRememberMeServices#onLoginSuccess</code> 计算 rememberMe 的 token，并添加到 cookie</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_认证\"><a class=\"anchor\" href=\"#_认证\"></a>认证</h3>\n<div class=\"paragraph\">\n<p><code>RememberMeAuthenticationFilter</code> 处理认证:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>RememberMeAuthenticationFilter#doFilter</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>TokenBasedRememberMeServices#autoLogin</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>TokenBasedRememberMeServices#processAutoLoginCookie</code> 从 cookie 中提取 token 并验证过期以及签名</p>\n</li>\n<li>\n<p><code>TokenBasedRememberMeServices#createSuccessfulAuthentication</code> 创建 <code>Authentication</code>(RememberMeAuthenticationToken)</p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p><code>RememberMeAuthenticationProvider#authenticate</code> 验证 <code>key</code></p>\n</li>\n<li>\n<p><code>SecurityContextHolder.getContext().setAuthentication()</code> 设置 authentication</p>\n</li>\n<li>\n<p><code>RememberMeAuthenticationFilter#onSuccessfulAuthentication</code></p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>","document":{"title":"Spring 记住登陆状态"},"pageAttributes":{"slug":"spring-login-remember-me","category":"spring"},"revision":{"date":"2021-10-23","number":"1.0"}}},"pageContext":{"id":"3d483926-4d37-585b-871b-f6d2279e35a3","pageAttributes__slug":"spring-login-remember-me","__params":{"pageAttributes__slug":"spring-login-remember-me"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}