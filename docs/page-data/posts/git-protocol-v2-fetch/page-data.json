{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/git-protocol-v2-fetch/","result":{"data":{"asciidoc":{"id":"4411b3de-303f-54a0-9e42-b1937a93f90c","html":"<div class=\"sect1\">\n<h2 id=\"_准备\">准备</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>先启动 <a href=\"/posts/git-daemon/\">git daemon 服务，准备测试数据</a>。</p>\n</div>\n<div class=\"paragraph\">\n<p>设置环境变量并拉取代码：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 将协议版本设置为 2\ngit config --global protocol.version 2\n# git 日志保存到文件\nexport GIT_TRACE=$PWD/git-trace.log\nexport GIT_TRACE_PACKET=$PWD/git-trace-pack.log</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_拉取\">拉取</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>服务端调用 <code>upload-pack</code>，客户端调用 <code>fetch-pack</code>。</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_全量\">全量</h3>\n<div class=\"paragraph\">\n<p>在服务端仓库 reference 信息如下：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ git for-each-ref\n9f114f880890b39b0f862a05fd7f9ffa1283ec32 commit\trefs/heads/branch_2\nc4896697e257d5915e9a8f6f3460cab36ff8df9a commit\trefs/heads/main\nf5e9cea1914d420b24718a9a4336cf110836e8f0 commit\trefs/pull/8/head\n89c2910934c685b60d95532ccb48186c0ddbc6b0 commit\trefs/tags/v4.0\n94948ac8c40fc3f234a06595b3c5b4c70c4f43e0 tag\trefs/tags/v6.0</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>客户端拉取代码：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 将接收到的 pack 内容保存到文件\nexport GIT_TRACE_PACKFILE=$PWD/git-trace-pack.pack\n\ngit clone git://127.0.0.1/project.git --quiet</code></pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_initial_client_request\">Initial Client Request</h4>\n<div class=\"paragraph\">\n<p>客户端发送请求，其中协议版本号为 2：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">C: git-upload-pack /project.git\\0host=127.0.0.1\\0\\0version=2\\0</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_capability_advertisement\">Capability Advertisement</h4>\n<div class=\"paragraph\">\n<p>服务端响应，发送自己所具备的能力：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">S: version 2\nS: agent=git/2.39.1\nS: ls-refs=unborn\nS: fetch=shallow wait-for-done\nS: server-option\nS: object-format=sha1\nS: object-info\nS: 0000</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_command_request_ls_refs\">Command Request: ls-refs</h4>\n<div class=\"paragraph\">\n<p>客户端发送命令 ls-refs，之后服务端将结果返回：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">C: command=ls-refs\nC: agent=git/2.39.1\nC: object-format=sha1\nC: 0001\nC: peel\nC: symrefs\nC: unborn\nC: ref-prefix HEAD\nC: ref-prefix refs/heads/\nC: ref-prefix refs/tags/\nC: 0000\nS: c4896697e257d5915e9a8f6f3460cab36ff8df9a HEAD symref-target:refs/heads/main\nS: 9f114f880890b39b0f862a05fd7f9ffa1283ec32 refs/heads/branch_2\nS: c4896697e257d5915e9a8f6f3460cab36ff8df9a refs/heads/main\nS: 89c2910934c685b60d95532ccb48186c0ddbc6b0 refs/tags/v4.0\nS: 94948ac8c40fc3f234a06595b3c5b4c70c4f43e0 refs/tags/v6.0 peeled:2f36731ec8d8b0e53fcfccd2cad413976aa47b69\nS: 0000</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_command_request_fetch\">Command Request: fetch</h4>\n<div class=\"paragraph\">\n<p>客户端发送命令 fetch，服务端返回 packfile：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">C: command=fetch\nC: agent=git/2.39.1\nC: object-format=sha1\nC: 0001\nC: thin-pack\nC: no-progress\nC: ofs-delta\nC: want c4896697e257d5915e9a8f6f3460cab36ff8df9a\nC: want 9f114f880890b39b0f862a05fd7f9ffa1283ec32\nC: want c4896697e257d5915e9a8f6f3460cab36ff8df9a\nC: want 89c2910934c685b60d95532ccb48186c0ddbc6b0\nC: want 94948ac8c40fc3f234a06595b3c5b4c70c4f43e0\nC: done\nC: 0000\nS: packfile\nS: PACK ...\nS: 0000</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_增量\">增量</h3>\n<div class=\"paragraph\">\n<p>服务端数据，新增两个提交共 6 个对象(2 commit, 2 tree, 2 blob)，其中 2 个对象之前就存在 (1 tree, 1 blob)：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ git log --pretty=oneline\n29901d7a4f8f4ae76920821d402de3e8dd151954 11:9 # 新增, 3 个对象，其中 tree blob 与 9 相同\n4eabd069067bc5de6fb281d792a6c10c4233475b 10   # 新增, 3 个对象都不同\nc4896697e257d5915e9a8f6f3460cab36ff8df9a 9\nf5e9cea1914d420b24718a9a4336cf110836e8f0 8\nfa679bfd70ac31dcb5862f9403ec4150d81b3d03 7\n2f36731ec8d8b0e53fcfccd2cad413976aa47b69 6\n9a533393b7342f34ceb497a1364d3bd84f54ce38 5\n89c2910934c685b60d95532ccb48186c0ddbc6b0 4\nf214f2bd153cdb1026183949d8cae10ed4470550 3\n9f114f880890b39b0f862a05fd7f9ffa1283ec32 2\ne40f1fece8708ed906683b13ecae19f57ae3660e 1</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>客户端执行：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\"># 将接收到的 pack 内容保存到文件\nexport GIT_TRACE_PACKFILE=$PWD/git-trace-pack.pack\n\ngit pull origin main --quiet</code></pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_initial_client_request_2\">Initial Client Request</h4>\n<div class=\"paragraph\">\n<p>客户端发送请求，其中协议版本号为 2：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">C: git-upload-pack /project.git\\0host=127.0.0.1\\0\\0version=2\\0</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_capability_advertisement_2\">Capability Advertisement</h4>\n<div class=\"paragraph\">\n<p>服务端响应，发送自己所具备的能力：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">S: version 2\nS: agent=git/2.39.1\nS: ls-refs=unborn\nS: fetch=shallow wait-for-done\nS: server-option\nS: object-format=sha1\nS: object-info\nS: 0000</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_command_request_ls_refs_2\">Command Request: ls-refs</h4>\n<div class=\"paragraph\">\n<p>客户端发送命令 ls-refs，之后服务端将结果返回：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">C: command=ls-refs\nC: agent=git/2.39.1\nC: object-format=sha1\nC: 0001\nC: peel\nC: symrefs\nC: unborn\nC: ref-prefix main\nC: ref-prefix refs/main\nC: ref-prefix refs/tags/main\nC: ref-prefix refs/heads/main\nC: ref-prefix refs/remotes/main\nC: ref-prefix refs/remotes/main/HEAD\nC: ref-prefix refs/tags/\nC: 0000\nS: 29901d7a4f8f4ae76920821d402de3e8dd151954 refs/heads/main\nS: 89c2910934c685b60d95532ccb48186c0ddbc6b0 refs/tags/v4.0\nS: 94948ac8c40fc3f234a06595b3c5b4c70c4f43e0 refs/tags/v6.0 peeled:2f36731ec8d8b0e53fcfccd2cad413976aa47b69\nS: 0000</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_command_request_fetch_2\">Command Request: fetch</h4>\n<div class=\"paragraph\">\n<p>客户端发送命令 fetch，服务端返回 packfile：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">C: command=fetch\nC: agent=git/2.39.1\nC: object-format=sha1\nC: 0001\nC: thin-pack\nC: no-progress\nC: ofs-delta\nC: want 29901d7a4f8f4ae76920821d402de3e8dd151954\nC: have c4896697e257d5915e9a8f6f3460cab36ff8df9a\nC: have f5e9cea1914d420b24718a9a4336cf110836e8f0\nC: have fa679bfd70ac31dcb5862f9403ec4150d81b3d03\nC: have 2f36731ec8d8b0e53fcfccd2cad413976aa47b69\nC: have 89c2910934c685b60d95532ccb48186c0ddbc6b0\nC: have 9f114f880890b39b0f862a05fd7f9ffa1283ec32\nC: 0000\nS: acknowledgments\nS: ACK c4896697e257d5915e9a8f6f3460cab36ff8df9a\nS: ACK f5e9cea1914d420b24718a9a4336cf110836e8f0\nS: ACK fa679bfd70ac31dcb5862f9403ec4150d81b3d03\nS: ACK 2f36731ec8d8b0e53fcfccd2cad413976aa47b69\nS: ACK 89c2910934c685b60d95532ccb48186c0ddbc6b0\nS: ACK 9f114f880890b39b0f862a05fd7f9ffa1283ec32\nS: ready\nS: 0001\nS: packfile\nS: PACK ...\nS: 0000</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>git help protocol-v2</code></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Git 协议 v2：fetch"},"pageAttributes":{"slug":"git-protocol-v2-fetch","category":"git"},"revision":{"date":"2023-01-28","number":"1.0"}}},"pageContext":{"id":"4411b3de-303f-54a0-9e42-b1937a93f90c","pageAttributes__slug":"git-protocol-v2-fetch","__params":{"pageAttributes__slug":"git-protocol-v2-fetch"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}