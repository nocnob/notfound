{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/mysql-ruby-client/","result":{"data":{"asciidoc":{"id":"147ecb80-f498-539d-9419-a3082aebe18d","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>目标：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>MySQL 通过 Ruby 客户端批量生成数据用于测试。</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_安装配置_mysql\"><a class=\"anchor\" href=\"#_安装配置_mysql\"></a>安装配置 MySQL</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">docker run --name mysql.test -e MYSQL_ROOT_PASSWORD=123456 -d mysql <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\ndocker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' mysql.test <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\nmysql -h 172.17.0.2 -uroot -p123456 <i class=\"conum\" data-value=\"3\"></i><b>(3)</b></code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>通过容器安装，并设置 root 密码</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>获取容器 IP</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>通过容器 IP 访问 MySQL</td>\n</tr>\n</table>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_创建测试用户\"><a class=\"anchor\" href=\"#_创建测试用户\"></a>创建测试用户</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\">CREATE DATABASE test; <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nCREATE USER 'test'@'172.17.0.1' IDENTIFIED BY ''; <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\nGRANT ALL PRIVILEGES ON test.* TO 'test'@'172.17.0.1'; <i class=\"conum\" data-value=\"3\"></i><b>(3)</b></code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>创建数据库</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>创建用户并允许该用户通过指定 IP 免密登陆</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>授权用户通过指定 IP 访问测试数据库</td>\n</tr>\n</table>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_创建测试表\"><a class=\"anchor\" href=\"#_创建测试表\"></a>创建测试表</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-sql\" data-lang=\"sql\"><i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nDROP TABLE IF EXISTS `test`;\nCREATE TABLE `test` (\n  `id` int NOT NULL AUTO_INCREMENT,\n  `storage` varchar(255) NOT NULL,\n  `hash` varchar(255) NOT NULL,\n  `remark` varchar(255),\n  PRIMARY KEY (`id`)\n);</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>旧表存则删除</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_ruby_客户端\"><a class=\"anchor\" href=\"#_ruby_客户端\"></a>Ruby 客户端</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_安装_gem\"><a class=\"anchor\" href=\"#_安装_gem\"></a>安装 gem</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">gem install mysql2</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_生成测试数据\"><a class=\"anchor\" href=\"#_生成测试数据\"></a>生成测试数据</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">#!/usr/bin/env ruby\n# frozen_string_literal: true\n\nrequire 'mysql2'\nrequire 'digest'\n\n<i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nclient = Mysql2::Client.new(\n  host: '172.17.0.2',\n  port: 3306,\n  username: 'test',\n  database: 'test'\n)\n<i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\ninsert = &lt;&lt;-SQL\n  INSERT INTO\n    test(storage, hash, remark)\n  VALUES\n    #{100.times.map { '(?, ?, ?)' }.join(',')}\nSQL\n\ns0 = client.prepare(insert)\n\n(1..1_000_000).each_slice(100) do |is|\n  puts is.last\n  array = is.flat_map do |i|\n    [\"host-#{i % 10}\", Digest::SHA256.hexdigest(i.to_s), i.to_s]\n  end\n\n  s0.execute(*array)\nend\n\n<i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\nputs client.query('SELECT count(*) as count_test FROM test').first</code></pre>\n</div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>设置连接参数</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>数据批量插入，每次插入 100 条数据</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>查询数据量</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n</div>","document":{"title":"MySQL Ruby 客户端"},"pageAttributes":{"slug":"mysql-ruby-client","category":"database"},"revision":{"date":"2022-06-03","number":"1.0"}}},"pageContext":{"id":"147ecb80-f498-539d-9419-a3082aebe18d","pageAttributes__slug":"mysql-ruby-client","__params":{"pageAttributes__slug":"mysql-ruby-client"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}