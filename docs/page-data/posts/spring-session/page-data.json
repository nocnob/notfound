{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/spring-session/","result":{"data":{"asciidoc":{"id":"4a8939b2-07d3-58ca-9bbd-19052dc2e00e","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>spring boot 2.6.1</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_依赖\"><a class=\"anchor\" href=\"#_依赖\"></a>依赖</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-gradle\" data-lang=\"gradle\">implementation 'org.springframework.boot:spring-boot-starter-data-redis'\nimplementation 'org.springframework.boot:spring-boot-starter-security'\nimplementation 'org.springframework.boot:spring-boot-starter-web'\nimplementation 'org.springframework.session:spring-session-data-redis'</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>spring-boot-starter-data-redis</code> 包含 redis 驱动</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_配置\"><a class=\"anchor\" href=\"#_配置\"></a>配置</h2>\n<div class=\"sectionbody\">\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-properties\" data-lang=\"properties\">spring.security.user.name=admin\nspring.security.user.password=123456</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>redis 会使用默认配置</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_代码\"><a class=\"anchor\" href=\"#_代码\"></a>代码</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>配置 Spring Session：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">@EnableRedisHttpSession\npublic class HttpSessionConfig {\n    @Bean\n    public HttpSessionIdResolver httpSessionIdResolver() {\n        return HeaderHttpSessionIdResolver.xAuthToken();\n    }\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>使用 HTTP 头部 <code>X-Auth-Token</code> 保存会话信息，适用于 RESTful APIs:</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>配置 Spring Security：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">@EnableWebSecurity\npublic class SecurityConfig extends WebSecurityConfigurerAdapter {\n    @Override\n    protected void configure(HttpSecurity http) throws Exception {\n        http.authorizeRequests((requests) -&gt; requests\n                .antMatchers(\"/guest/*\").permitAll()\n                .anyRequest().authenticated()\n        );\n        http.httpBasic();\n    }\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>/guest/*</code> 无需认证，其他都需要认证</p>\n</li>\n<li>\n<p>开启 basic 认证</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>添加控制器：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">@RestController\npublic class HomeController {\n    @Autowired\n    private HttpSession httpSession;\n\n    @GetMapping(\"/\")\n    public String index(Authentication authentication) {\n        return \"Hello, \" + authentication.getName();\n    }\n\n    @GetMapping(\"/guest/ping\")\n    public String ping() {\n        return \"Pong\";\n    }\n\n    @GetMapping(\"/guest/session\")\n    public String guest() {\n        return \"Hello, \" + httpSession.getId();\n    }\n}</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>/</code> 需要认证</p>\n</li>\n<li>\n<p><code>/guest/ping</code> 无需认证</p>\n</li>\n<li>\n<p><code>/guest/session</code> 无需认证，但会读取 session</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_过程\"><a class=\"anchor\" href=\"#_过程\"></a>过程</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_无认证信息且路由无需认证\"><a class=\"anchor\" href=\"#_无认证信息且路由无需认证\"></a>无认证信息且路由无需认证</h3>\n<div class=\"paragraph\">\n<p>不会生成 Session</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">curl -v http://localhost:8080/guest/ping\n&gt; GET /guest/ping HTTP/1.1\n&gt; Host: localhost:8080\n&gt;\n&lt; HTTP/1.1 200\n&lt;\nPong</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_认证错误且路由无需认证\"><a class=\"anchor\" href=\"#_认证错误且路由无需认证\"></a>认证错误且路由无需认证</h3>\n<div class=\"paragraph\">\n<p>此时会创建 session</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">curl -v -u admin:12345 http://localhost:8080/guest/ping\n*   Trying 127.0.0.1:8080...\n&gt; GET /guest/ping HTTP/1.1\n&gt; Host: localhost:8080\n&gt; Authorization: Basic YWRtaW46MTIzNDU=\n&gt;\n&lt; HTTP/1.1 401\n&lt; WWW-Authenticate: Basic realm=\"Realm\"\n&lt; X-Auth-Token: 720424bb-cd6f-44c2-8e65-9fb71fb8a434\n&lt;</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>返回 session id：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>ExceptionTranslationFilter#doFilter</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>ExceptionTranslationFilter#handleSpringSecurityException</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>ExceptionTranslationFilter#sendStartAuthentication</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>BasicAuthenticationEntryPoint#commence</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>HttpSessionSecurityContextRepository$SaveToSessionResponseWrapper#sendError</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionRepositoryFilter$SessionRepositoryRequestWrapper#commitSession</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>HeaderHttpSessionIdResolver#setSessionId</code> 创建 <code>X-Auth-Token</code> 头部</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_无认证信息且路由无需认证获取_session\"><a class=\"anchor\" href=\"#_无认证信息且路由无需认证获取_session\"></a>无认证信息且路由无需认证，获取 session</h3>\n<div class=\"paragraph\">\n<p>此时会创建 session</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ curl -v http://localhost:8080/guest/session\n&gt; GET /guest/session HTTP/1.1\n&gt; Host: localhost:8080\n&gt;\n&lt; HTTP/1.1 200\n&lt; X-Auth-Token: 6ae5475f-3a17-4703-8c68-bdfc5c67bc24\n&lt;\nHello, 6ae5475f-3a17-4703-8c68-bdfc5c67bc24</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>返回 session id：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionRepositoryFilter$SessionRepositoryResponseWrapper#checkContentLength</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionRepositoryFilter$SessionRepositoryRequestWrapper#commitSession</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>HeaderHttpSessionIdResolver#setSessionId</code> 创建 <code>X-Auth-Token</code> 头部</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_携带认证信息访问受保护的路由\"><a class=\"anchor\" href=\"#_携带认证信息访问受保护的路由\"></a>携带认证信息访问受保护的路由</h3>\n<div class=\"paragraph\">\n<p>此时会创建 session</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">curl -v -u admin:123456 http://localhost:8080\n&gt; GET / HTTP/1.1\n&gt; Host: localhost:8080\n&gt; Authorization: Basic YWRtaW46MTIzNDU2\n&gt;\n&lt; HTTP/1.1 200\n&lt; X-Auth-Token: 92d42f7a-0ac9-4044-bb66-9645dd42ba0e\n&lt;\nHello, admin</code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionRepositoryFilter$SessionRepositoryResponseWrapper#checkContentLength</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionRepositoryFilter$SessionRepositoryRequestWrapper#commitSession</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>HeaderHttpSessionIdResolver#setSessionId</code> 创建 <code>X-Auth-Token</code> 头部</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_携带_x_auth_token_访问受保护的路由\"><a class=\"anchor\" href=\"#_携带_x_auth_token_访问受保护的路由\"></a>携带 <code>X-Auth-Token</code> 访问受保护的路由</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ curl -v -H \"X-Auth-Token: 84deb00a-8b71-4dd9-af1a-2cef9cb029a4\" http://localhost:8080\n&gt; GET / HTTP/1.1\n&gt; Host: localhost:8080\n&gt; User-Agent: curl/7.79.1\n&gt; Accept: */*\n&gt; X-Auth-Token: 84deb00a-8b71-4dd9-af1a-2cef9cb029a4\n&gt;\n&lt; HTTP/1.1 200\n&lt;\nHello, admin</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>通过 Token 认证：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SecurityContextPersistenceFilter#doFilter</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>HttpSessionSecurityContextRepository#loadContext</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionRepositoryFilter$SessionRepositoryRequestWrapper#getSession</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionRepositoryFilter$SessionRepositoryRequestWrapper#getRequestedSession</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>RedisIndexedSessionRepository#findById</code> 通过 session id 查询 session</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>更新过期时间：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionRepositoryFilter#doFilterInternal</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionRepositoryFilter$SessionRepositoryRequestWrapper#commitSession</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>RedisIndexedSessionRepository#save</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>RedisIndexedSessionRepository$RedisSession#save</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>RedisIndexedSessionRepository$RedisSession#saveDelta</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>RedisSessionExpirationPolicy#onExpirationUpdated</code> 更新过期时间</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_携带认证信息和_x_auth_token_访问受保护的路由\"><a class=\"anchor\" href=\"#_携带认证信息和_x_auth_token_访问受保护的路由\"></a>携带认证信息和 <code>X-Auth-Token</code> 访问受保护的路由</h3>\n<div class=\"paragraph\">\n<p><code>X-Auth-Token</code> 是认证未通过时返回的 Token</p>\n</div>\n<div class=\"paragraph\">\n<p>认证未通过 session id 保持不变：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ curl -v -u admin:12345 -H \"X-Auth-Token: ea7a8601-420a-4e37-95d6-c716cacd7f9c\" http://localhost:8080\n&gt; GET / HTTP/1.1\n&gt; Host: localhost:8080\n&gt; Authorization: Basic YWRtaW46MTIzNDU=\n&gt; X-Auth-Token: ea7a8601-420a-4e37-95d6-c716cacd7f9c\n&gt;\n&lt; HTTP/1.1 401\n&lt; WWW-Authenticate: Basic realm=\"Realm\"\n&lt;</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>认证通过 session id 变更：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ curl -v -u admin:123456 -H \"X-Auth-Token: ea7a8601-420a-4e37-95d6-c716cacd7f9c\" http://localhost:8080\n&gt; GET / HTTP/1.1\n&gt; Host: localhost:8080\n&gt; Authorization: Basic YWRtaW46MTIzNDU2\n&gt; X-Auth-Token: ea7a8601-420a-4e37-95d6-c716cacd7f9c\n&gt;\n&lt; HTTP/1.1 200\n&lt; X-Auth-Token: ce43a60a-98db-4eae-a48d-e54bdecde9d4\n&lt;\nHello, admin</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>变更 session id：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionManagementFilter#doFilter</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>CompositeSessionAuthenticationStrategy#onAuthentication</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>ChangeSessionIdAuthenticationStrategy#onAuthentication</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>ChangeSessionIdAuthenticationStrategy#applySessionFixation</code> 变更 session id</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>返回新的 session id：</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionRepositoryFilter$SessionRepositoryResponseWrapper#checkContentLength</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>SessionRepositoryFilter$SessionRepositoryRequestWrapper#commitSession</code></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>HeaderHttpSessionIdResolver#setSessionId</code> 创建 <code>X-Auth-Token</code> 头部</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://docs.spring.io/spring-session/reference/http-session.html\" class=\"bare\">https://docs.spring.io/spring-session/reference/http-session.html</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Spring Session"},"pageAttributes":{"slug":"spring-session","category":"spring"},"revision":{"date":"2021-12-11","number":"1.0"}}},"pageContext":{"id":"4a8939b2-07d3-58ca-9bbd-19052dc2e00e","pageAttributes__slug":"spring-session","__params":{"pageAttributes__slug":"spring-session"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}