{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/linux-ruby-install/","result":{"data":{"asciidoc":{"id":"688ab59b-81a5-5476-b64d-1c5557d2ff02","html":"<div class=\"sect1\">\n<h2 id=\"_linux_编译安装_ruby\"><a class=\"anchor\" href=\"#_linux_编译安装_ruby\"></a>Linux 编译安装 Ruby</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Ubuntu 20.04</p>\n</li>\n<li>\n<p>Ruby 3.0.0</p>\n</li>\n</ul>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_直接编译安装\"><a class=\"anchor\" href=\"#_直接编译安装\"></a>直接编译安装</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">wget http://cache.ruby-china.com/pub/ruby/3.0/ruby-3.0.0.tar.gz\ntar -zxvf ruby-3.0.0.tar.gz\ncd ruby-3.0.0\n./configure --prefix=/opt/ruby-3.0.0\nmake -j8\nmake install</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_集成_jemalloc\"><a class=\"anchor\" href=\"#_集成_jemalloc\"></a>集成 jemalloc</h3>\n<div class=\"paragraph\">\n<p>jemalloc 可以大幅度减少 sidekiq 内存碎片。</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">sudo apt install libjemalloc-dev</code></pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_编译方式\"><a class=\"anchor\" href=\"#_编译方式\"></a>编译方式</h4>\n<div class=\"paragraph\">\n<p>编译时添加 <code>--with-jemalloc</code> 参数即可：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">./configure --prefix=/opt/ruby-3.0.0 --with-jemalloc</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>检查 jemalloc:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">/opt/ruby-3.0.0/bin/ruby -r rbconfig -e \"puts RbConfig::CONFIG['MAINLIBS']\"\n# 低版本\n# ruby -r rbconfig -e \"puts RbConfig::CONFIG['LIBS']\"</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>输出：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">-lz -lpthread - lrt -lrt -ljemalloc -lgmp -ldl -lcrypt -lm</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_环境变量方式\"><a class=\"anchor\" href=\"#_环境变量方式\"></a>环境变量方式</h4>\n<div class=\"paragraph\">\n<p>设置环境变量 <code>LD_PRELOAD</code> 即可</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_指定_openssl_版本\"><a class=\"anchor\" href=\"#_指定_openssl_版本\"></a>指定 openssl 版本</h3>\n<div class=\"paragraph\">\n<p>编译 openssl：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">wget https://www.openssl.org/source/openssl-1.1.1j.tar.gz\ntar -zxvf openssl-1.1.1j.tar.gz\ncd openssl-1.1.1j\n./config shared --prefix=/opt/openssl-1.1.1j\nmake -j8</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>通过 <code>--with-openssl-dir</code> 参数指定 openssl 路径：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">./configure --prefix=/opt/ruby-3.0.0 --with-openssl-dir=/opt/openssl-1.1.1j</code></pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"_可能遇到问题\"><a class=\"anchor\" href=\"#_可能遇到问题\"></a>可能遇到问题</h4>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">$ gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/\nError fetching https://gems.ruby-china.com/:\nSSL_connect returned=1 errno=0 state=error: certificate verify failed (https://gems.ruby-china.com/specs.4.8.gz)</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>导入环境变量即可：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt\nexport SSL_CERT_DIR=/etc/ssl/certs</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_环境变量\"><a class=\"anchor\" href=\"#_环境变量\"></a>环境变量</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>输出 gem 信息：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">gem env\ngem env path\ngem env home</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>通过设置 <code>GEM_PATH</code> 修改 gem 查找路径：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">export GEM_PATH=/home/notfound/app/vendor/bundle/ruby/2.7.0</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_gem_配置\"><a class=\"anchor\" href=\"#_gem_配置\"></a>gem 配置</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_修改源\"><a class=\"anchor\" href=\"#_修改源\"></a>修改源</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-bash\" data-lang=\"bash\">gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_不安装文档\"><a class=\"anchor\" href=\"#_不安装文档\"></a>不安装文档</h3>\n<div class=\"paragraph\">\n<p>编辑 <code>~/.gemrc</code> 或者 <code>/etc/gemrc</code> 或者 <code>~/.config/gem/gemrc</code>(fedora\n35)，添加：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-gemrc\" data-lang=\"gemrc\">gem: --no-document</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://github.com/rbenv/ruby-build/issues/1215\" class=\"bare\">https://github.com/rbenv/ruby-build/issues/1215</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.openssl.org/index.php/Compilation%5Fand%5FInstallation\" class=\"bare\">https://wiki.openssl.org/index.php/Compilation%5Fand%5FInstallation</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/jemalloc/jemalloc/wiki/Getting-Started\" class=\"bare\">https://github.com/jemalloc/jemalloc/wiki/Getting-Started</a></p>\n</li>\n<li>\n<p><a href=\"https://www.cyningsun.com/07-07-2018/memory-allocator-contrasts.html\" class=\"bare\">https://www.cyningsun.com/07-07-2018/memory-allocator-contrasts.html</a></p>\n</li>\n<li>\n<p><a href=\"https://stackoverflow.com/questions/11277227/whats-the-difference-between-gem-home-and-gem-path\" class=\"bare\">https://stackoverflow.com/questions/11277227/whats-the-difference-between-gem-home-and-gem-path</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Linux 编译安装 Ruby"},"pageAttributes":{"slug":"linux-ruby-install","category":"ruby"},"revision":{"date":"2021-03-18","number":"1.0"}}},"pageContext":{"id":"688ab59b-81a5-5476-b64d-1c5557d2ff02","pageAttributes__slug":"linux-ruby-install","__params":{"pageAttributes__slug":"linux-ruby-install"}}},"staticQueryHashes":["3143286284"],"slicesMap":{}}