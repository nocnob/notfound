= Git 协议 v2：fetch
notfound <notfound@notfound.cn>
1.0, 2023-01-28: init

:page-slug: git-protocol-v2-fetch
:page-category: git

== 准备

启动 Git Daemon 服务，允许通过 git 协议推、拉代码：

[source,bash]
----
# 创建空仓库
git init --bare project.git

# 启动 git 服务
git daemon \
    --verbose \
    --export-all \
    --base-path=$PWD \
    --reuseaddr \
    --enable=receive-pack  \
    --listen=127.0.0.1
----
* `--verbose` 输出详细信息
* `--export-all` 目录下的所有仓库都可以拉取
* `--base-path` 仓库根目录
* `--reuseaddr` 允许服务重启时不等待旧的连接超时
* `--enable` 允许的服务，这里允许仓库推送
* `--listen` 监听的地址和端口号

== Git 协议，启动

[source,bash]
----
# git 日志保存到文件
export GIT_TRACE=$PWD/git-trace.log
export GIT_TRACE_PACKET=$PWD/git-trace-pack.log
# 将协议版本设置为 2
git config --global protocol.version 2

git clone git://127.0.0.1/project.git --quiet
----

== 拉取数据

服务端调用 `upload-pack`，客户端调用 `fetch-pack`。

=== Initial Client Request

客户端发送请求，其中协议版本号为 2：

[source,text]
----
C: git-upload-pack /project.git\0host=127.0.0.1\0\0version=2\0
----

=== Capability Advertisement

服务端响应，发送自己所具备的能力：

[source,text]
----
S: version 2
S: agent=git/2.39.1
S: ls-refs=unborn
S: fetch=shallow wait-for-done
S: server-option
S: object-format=sha1
S: object-info
S: 0000
----

=== Command Request

客户端发送命令 ls-refs，之后服务端将结果返回：

[source,text]
----
C: command=ls-refs
C: agent=git/2.39.1
C: object-format=sha1
C: 0001
C: peel
C: symrefs
C: unborn
C: ref-prefix HEAD
C: ref-prefix refs/heads/
C: ref-prefix refs/tags/
C: 0000
S: 943076d70374ea9c509ddf011ed14a8a4da20f81 HEAD symref-target:refs/heads/main
S: 943076d70374ea9c509ddf011ed14a8a4da20f81 refs/heads/main
S: bffb3ae2b8b14e933ddb8072a3bec96f26fcc197 refs/tags/v1.0 peeled:16965649f858da970dac5cd29c0e3f93150ea475
S: e8cc49b26ee185ee175e778bba488691a4e2bed0 refs/tags/v2.0
S: 0000
----

=== Command Request

客户端发送命令 fetch，服务端返回 packfile：

[source,text]
----
C: command=fetch
C: agent=git/2.39.1
C: object-format=sha1
C: 0001
C: thin-pack
C: no-progress
C: ofs-delta
C: want 943076d70374ea9c509ddf011ed14a8a4da20f81
C: want 943076d70374ea9c509ddf011ed14a8a4da20f81
C: want bffb3ae2b8b14e933ddb8072a3bec96f26fcc197
C: want e8cc49b26ee185ee175e778bba488691a4e2bed0
C: done
C: 0000
S: packfile
S: PACK ...
S: 0000
----
== 参考

* `git help protocol-v2`
