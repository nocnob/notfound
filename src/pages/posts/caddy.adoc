= caddy
notfound <notfound@notfound.cn>
1.0, 2023-03-17: init

:page-slug: caddy
:page-category: caddy
:page-draft: true

== 场景

=== 单个域名，使用已有证书

link:/posts/linux-ssl-nginx/[生成自签名证书]，然后执行：

[source,bash]
----
mkdir -p /srv/caddy/certs/demo.com
# 私钥
cp demo.com/demo.com.key /srv/caddy/certs/demo.com/
# 域名证书和二级根证书放到同一个文件
cat demo.com/demo.com.crt ca2.demo.com/cacert.pem  > /srv/caddy/certs/demo.com/demo.com.crt
----

caddy 配置：

./srv/caddy/Caddyfile
[source,Caddyfile]
----
{
	admin off # <1>
	ocsp_stapling off # <2>
}

demo.com {
	tls /srv/caddy/certs/demo.com/demo.com.crt /srv/caddy/certs/demo.com/demo.com.key # <3>

	root * /srv/caddy/html/demo.com # <4>
	file_server # <4>
}
----
<1> 禁用 管理页面
<2> 禁用 OCSP stapling。OCSP 在线证书状态协议，用来验证证书是否有效。OCSP stapling 由 caddy 服务验证证书是否有效
<3> 设置证书和私有文件路径
<4> 静态文件以及文件根路径

只有一个域名且设置了证书相关文件，不会启用自动化证书管理功能。

=== 多个子域名，使用泛域名证书

[source,bash]
----
cp demo.io/demo.io.key /srv/caddy/certs/demo.io
cat demo.io/demo.io.crt ca2.demo.com/cacert.pem > /srv/caddy/certs/demo.io/demo.io.crt
----

caddy 配置：

[source,Caddyfile]
----
{
	admin off
	ocsp_stapling off
}

*.demo.io {
	tls /srv/caddy/certs/demo.io/demo.io.crt /srv/caddy/certs/demo.io/demo.io.key # <1>

	root * /srv/caddy/html/{host} # <2>
	file_server
}
----
<1> Wildcard certificates
<2> 根据变量 `host` 设置对应域名根目录

=== 自动申请自签名证书

[source,Caddyfile]
----
{
	storage file_system /srv/caddy/storage # <1>
	admin off
	on_demand_tls { # <2>
		interval 1s
		burst 1
	}
	ocsp_stapling off
}

*.demo.dev {
	tls internal { # <3>
		on_demand  # <4>
	}

	root * /srv/caddy/html/{host}
	file_server
}
----
<1> 证书信息存储路径

[source,bash]
----
openssl s_client -connect app1.demo.dev:443
----

Edge 问题：你现在无法访问 app1.demo.dev，因为网站使用的是 HSTS。网络错误和攻击通常是暂时的，因此该页面以后可能会恢复正常。
Firefox 问题：app1.demo.dev has a security policy called HTTP Strict Transport Security (HSTS), which means that Firefox can only connect to it securely. You can’t add an exception to visit this site.

== 参考

* https://caddy.community/t/serving-tens-of-thousands-of-domains-over-https-with-caddy/11179
* https://caddyserver.com/docs/caddyfile/concepts
