= Multi Paxos (草稿)
notfound <notfound@notfound.cn>
1.0, 2023-02-02: init

:page-slug: distribution-paxos-multi
:page-category: distribution

== 复制日志

对每条日志单独运行一次 Paxos 算法决议其中的值，添加日志索引 index 参数表示某一轮 Paxos 正在决策哪一个日志条目。

=== 顺序发送

[source,plantuml]
----
@startuml
participant Client as c
participant "Leader" as l
participant "Acceptor 1" as a1
participant "Acceptor 2" as a2
participant "Acceptor 3" as a3

activate c
c -> l : send(a)
note right l: <font color=red>maxRound=1\n<font color=red>nextIndex=2\nprepared=false
activate l
    l -> a1 : Prepare(n=1, index=1) : a
    activate a1
    l -> a2 : Prepare(n=1, index=1) : a
    activate a2
    l <-- a1 : Promise(acceptedProposal=0,acceptedValue=0,noMoreAccepted=true) : a
    deactivate a1
    l <-- a2 : Promise(acceptedProposal=0,acceptedValue=0,noMoreAccepted=true) : a
    deactivate a2
    note right a2: id=2\n<font color=red>minProposal=1\nfirstUnchonsenIndex=0
    note right l: maxRound=1\nnextIndex=2\n<font color=red>prepared=true

    l -> a1 : Accept(n=1,index=1,v=a,firstUnchosenIndex=1) : a
    activate a1
    l -> a2 : Accept(n=1,index=1,v=a,firstUnchosenIndex=1) : a
    activate a2
    l <-- a1 : Accepted(n=1,firstUnchosenIndex=1) : a
    deactivate a1
    l <-- a2 : Accepted(n=1,firstUnchosenIndex=1) : a
    deactivate a2
    note right a2
        id=2
        minProposal=1
        <font color=red>firstUnchonsenIndex=1
        <font color=red>acceptedProposal[1]=1
        <font color=red>acceptedValue[1]=a
    end note
c <-- l : a
deactivate l

c -> l : send(b)
note right l: <font color=red>maxRound=2\n<font color=red>nextIndex=2\nprepared=true
activate l
    l -> a1 : Accept(n=2,index=2,v=b,firstUnchosenIndex=2) : b
    activate a1
    l -> a2 : Accept(n=2,index=2,v=b,firstUnchosenIndex=2) : b
    activate a2
    l <-- a1 : Accepted(n=2,firstUnchosenIndex=2) : b
    deactivate a1
    l <-- a2 : Accepted(n=2,firstUnchosenIndex=2) : b
    deactivate a2
    note right a2
        id=2
        <font color=red>minProposal=2
        <font color=red>firstUnchonsenIndex=2
        <font color=red>acceptedProposal[2]=2
        <font color=red>acceptedValue[2]=b
    end note

c <-- l : b
deactivate l


c -> l : send(c)
note right l: <font color=red>maxRound=3\n<font color=red>nextIndex=3\nprepared=true
activate l
    l -> a1 : Accept(n=3,index=3,v=c,firstUnchosenIndex=3) : c
    activate a1
    l -> a2 : Accept(...) : c
    activate a2
    l <-- a1 : Accepted(n=3,firstUnchosenIndex=3) : c
    deactivate a1
    l <-- a2 : Accepted(...) : c
    deactivate a2
    note right a2
        id=2
        <font color=red>minProposal=3
        <font color=red>firstUnchonsenIndex=3
        <font color=red>acceptedProposal[3]=3
        <font color=red>acceptedValue[3]=c
    end note
c <-- l : c
deactivate l
@enduml
----
* send(a) 存在第一阶段和阶段
* send(b) 和 send(c) 直接进入第二阶段

=== 并发

==== Leader 并发，所有 Acceptor 顺序相同

从 Leader 角度看请求并发，但从所有 Acceptor 角度看都和 Leader 收到的请求的顺序相同。

[source,plantuml]
----
@startuml
participant Client as c
participant "Leader\n(Proposer x)" as l
participant "Acceptor 1" as a1
participant "Acceptor 2" as a2
participant "Acceptor 3" as a3

activate c
c -> l : send(d)
activate l
    l -> a1 : Accept(n=4,index=4,v=d,firstUnchosenIndex=4) : d
    activate a1
    l <-- a1 : Accepted(n=4,firstUnchosenIndex=4) : d
    deactivate a1

c -> l : send(e)
activate l
    l -> a1 : Accept(n=5,index=5,v=e,firstUnchosenIndex=4) : e
    activate a1
    l <-- a1 : Accepted(n=5,firstUnchosenIndex=4) : e
    deactivate a1

    l -> a2 : Accept(n=4,index=4,v=c,firstUnchosenIndex=4) : d
    activate a2
    l <-- a2 : Accepted(n=4,firstUnchosenIndex=4) : d
    deactivate a2
c <-- l : d

    l -> a2 : Accept(n=5,index=5,v=e,firstUnchosenIndex=5) : e
    activate a2
    l <-- a2 : Accepted(n=5,firstUnchosenIndex=5) : e
    deactivate a2
c <-- l : e
deactivate l
deactivate l

c -> l : send(f)
activate l
    l -> a1 : Accept(n=6,index=6,v=f,firstUnchosenIndex=6) : f
    activate a1
    l -> a2 : Accept(n=6,index=6,v=f,firstUnchosenIndex=6) : f
    activate a2
    l <-- a1 : Accepted(n=6,firstUnchosenIndex=6) : f
    deactivate a1
    l <-- a2 : Accepted(n=6,firstUnchosenIndex=6) : f
    deactivate a2
c <-- l : f
deactivate l
@enduml
----
* 从 Leader 角度看，请求处理过程有重叠，但每个 Acceptor 都是先处理 d，后处理 e。

==== Leader 并发，所有 Acceptor 顺序不同

从 Leader 角度看请求并发，且不同的 Acceptor 处理顺序不同。

[source,plantuml]
----
@startuml
participant Client as c
participant "Leader\n(Proposer x)" as l
participant "Acceptor 1" as a1
participant "Acceptor 2" as a2
participant "Acceptor 3" as a3

activate c
c -> l : send(d)
note right: maxRound=3\nnextIndex=4\nprepared=true
activate l
    l -> a1 : Accept(n=4,index=4,v=c,firstUnchosenIndex=4) : d
    activate a1
    l <-- a1 : Accepted(n=4,firstUnchosenIndex=4) : d
    note right: minProposal=4
    deactivate a1

c -> l : send(e)
activate l
    l -> a1 : Accept(n=5,index=5,v=e,firstUnchosenIndex=4) : e
    activate a1
    l <-- a1 : Accepted(n=5,firstUnchosenIndex=4) : e
    note right: minProposal=5
    deactivate a1
    l -> a2 : Accept(n=5,index=5,v=e,firstUnchosenIndex=4) : e
    activate a2
    l <-- a2 : Accepted(n=5,firstUnchosenIndex=4) : e
    note right: minProposal=5
    deactivate a2
c <-- l : e
deactivate l

    l -> a2 : Accept(n=4,index=4,v=c,firstUnchosenIndex=4) : d
    activate a2
    l <-- a2 : Accepted(n=5,firstUnchosenIndex=4) : d
    note right: minProposal=5
    deactivate a2
c <-- l : d
deactivate l

note right: maxRound=5\nnextIndex=6\nprepared=false
c -> l : send(f)
activate l
    l -> a1 : Prepare(n=6, index=6) : f
    activate a1
    l -> a2 : Prepare(...) : f
    activate a2
    l <-- a1 : Promise(acceptedProposal=0,acceptedValue=0,noMoreAccepted=true) : f
    deactivate a1
    l <-- a2 : Promise(...) : f
    deactivate a2

    l -> a1 : Accept(n=1,index=1,v=a,firstUnchosenIndex=1) : f
    activate a1
    l -> a2 : Accept(...) : f
    activate a2
    l <-- a1 : Accepted(n=1,firstUnchosenIndex=1) : f
    deactivate a1
    l <-- a2 : Accepted(...) : f
    deactivate a2
c <-- l : f
deactivate l
@enduml
----
* Acceptor 2 先处理 n=5 的请求，再处理 n=4 的请求，导致 send(f) 重新进入第一阶段


== 参考

* https://book.douban.com/subject/35794814/[《深入理解分布式系统》]
