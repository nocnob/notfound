= Raft 基本流程
notfound <notfound@notfound.cn>
1.0, 2023-02-07: init

:page-slug: distribution-raft
:page-category: distribution
:page-draft: true

== 领导者选举

=== 状态图

服务器在三种状态间转换：

[source,plantuml]
----
@startuml
[*] -> Follower
Follower -> Candidate: 心跳超时\n开始选举
Candidate -> Leader: 投票过半\n赢得选举
Leader -> Follower: 更大任期
Leader -> [*]
@enduml
----

系统正常运行时，只有一个领导者，其余都是追随者。

=== 时序图

[source,plantuml]
----
@startuml
participant C as c
participant S1 as s1
participant S2 as s2
participant S3 as s3

note right s1
    state=Follower
    currentTerm=0
end note

note right s2
    state=Follower
    currentTerm=0
end note

note right s3
    state=Follower
    currentTerm=0
end note

s1 -> s1 : wait timeout(1)
activate s1
note right s1
    <font color=red>state=Candidate
    <font color=red>ccurrentTerm=1
end note

s1 -> s2 : RequestVote(2)
activate s2
s1 -> s3 : RequestVote
activate s3
s1 <-- s2: ok
s1 <-- s3: ok
note right s1
    <font color=red>state=Leader
end note
deactivate s3
deactivate s2
deactivate s1
@enduml
----
1. 跟随状态节点未收到任期更大的 RPC 请求，认为集群中没有领导者，进入候选状态；
2. 节点开始竞选；
3. 获得超过半数投票，成为领导者。

== 日志复制

[source,plantuml]
----
@startuml
participant C as c
participant S1 as s1
participant S2 as s2
participant S3 as s3

activate c
c -> s1 : send(a)
activate s1
note right s1
    state=Leader
    currentTerm=1
    LeaderCommit=0
end note
s1 -> s1 : AppendEntries()

s1 -> s2 : AppendEntries(Term=1, LeaderId=1, PrevLogIndex=0, PrevLogTerm=0, LeaderCommit=0)
note right s2
    state=Follower
    currentTerm=1
    LeaderCommit=0
end note
activate s2

s1 -> s3 : AppendEntries(Term=1, LeaderId=1, PrevLogIndex=0, PrevLogTerm=0, LeaderCommit=0)
activate s3
note right s3
    state=Follower
    currentTerm=1
    LeaderCommit=0
end note
s1 <-- s2 : (Term=1, Success=true)
deactivate s2

note right s1
    state=Leader
    currentTerm=1
    <font color=red>LeaderCommit=1
end note
c <-- s1
s1 <-- s3 : (Term=1, Success=true)
deactivate s3
deactivate s1


c -> s1 : send(b)
activate s1
s1 -> s1 : AppendEntries()
s1 -> s2 : AppendEntries(Term=1, LeaderId=1, PrevLogIndex=1, PrevLogTerm=1, LeaderCommit=1)
activate s2
note right s2
    state=Follower
    currentTerm=1
    <font color=red>LeaderCommit=1
end note

s1 -> s3 : AppendEntries(Term=1, LeaderId=1, PrevLogIndex=1, PrevLogTerm=1, LeaderCommit=1)
activate s3
note right s3
    state=Follower
    currentTerm=1
    <font color=red>LeaderCommit=1
end note
s1 <-- s2 : (Term=1, Success=true)
deactivate s2
note right s1
    state=Leader
    currentTerm=1
    <font color=red>LeaderCommit=2
end note
s1 <-- s3 : (Term=1, Success=true)
deactivate s3
c <-- s1
deactivate s1

c -> s1 : send(c)
activate s1
s1 -> s1 : AppendEntries()
s1 -> s2 : AppendEntries(Term=1, LeaderId=1, PrevLogIndex=2, PrevLogTerm=1, LeaderCommit=2)
activate s2
note right s2
    state=Follower
    currentTerm=1
    <font color=red>LeaderCommit=2
end note

s1 -> s3 : AppendEntries(Term=1, LeaderId=1, PrevLogIndex=2, PrevLogTerm=1, LeaderCommit=2)
activate s3
note right s3
    state=Follower
    currentTerm=1
    <font color=red>LeaderCommit=2
end note
s1 <-- s2 : (Term=1, Success=true)
deactivate s2
note right s1
    state=Leader
    currentTerm=1
    <font color=red>LeaderCommit=3
end note
s1 <-- s3 : (Term=1, Success=true)
deactivate s3
c <-- s1
deactivate s1
deactivate c
@enduml
----

=== 节点落后恢复

[source,plantuml]
----
@startuml
participant C as c
participant S1 as s1
participant S2 as s2
participant S3 as s3

c -> s1 : send(d)
activate s1
s1 -> s1 : AppendEntries()
s1 -> s2 : AppendEntries(Term=1, LeaderId=1, PrevLogIndex=3, PrevLogTerm=1, LeaderCommit=3)
activate s2
note right s2
    state=Follower
    currentTerm=1
    <font color=red>LeaderCommit=3
end note
s1 <-- s2 : (Term=1, Success=true)
deactivate s2
c <-- s1
deactivate s1
note right s1
    state=Leader
    currentTerm=1
    <font color=red>LeaderCommit=4
end note

c -> s1 : send(e)
activate s1
s1 -> s1 : AppendEntries()
s1 -> s2 : AppendEntries(Term=1, LeaderId=1, PrevLogIndex=4, PrevLogTerm=1, LeaderCommit=4)
activate s2
note right s2
    state=Follower
    currentTerm=1
    <font color=red>LeaderCommit=4
end note
s1 <-- s2 : (Term=1, Success=true)
deactivate s2
c <-- s1
deactivate s1
note right s1
    state=Leader
    currentTerm=1
    <font color=red>LeaderCommit=5
end note

c -> s1 : send(f)
activate s1
s1 -> s1 : AppendEntries()
s1 -> s2 : AppendEntries(Term=1, LeaderId=1, PrevLogIndex=4, PrevLogTerm=1, LeaderCommit=5)
activate s2
note right s2
    state=Follower
    currentTerm=1
    <font color=red>LeaderCommit=5
end note
s1 <-- s2 : (Term=1, Success=true)
deactivate s2
c <-- s1
deactivate s1
note right s1
    state=Leader
    currentTerm=1
    <font color=red>LeaderCommit=6
end note

c -> s1 : send(g)
activate s1
s1 -> s1 : AppendEntries()
s1 -> s2 : AppendEntries(Term=1, LeaderId=1, PrevLogIndex=4, PrevLogTerm=1, LeaderCommit=6)
activate s2
note right s2
    state=Follower
    currentTerm=1
    <font color=red>LeaderCommit=6
end note
s1 <-- s2 : (Term=1, Success=true)
deactivate s2
note right s1
    state=Leader
    currentTerm=1
    <font color=red>LeaderCommit=7
end note

s1 -> s3 : AppendEntries(Term=1, LeaderId=1, PrevLogIndex=4, PrevLogTerm=1, LeaderCommit=6)
activate s3
c <-- s1
deactivate s1
@enduml
----

== 参考

* https://book.douban.com/subject/35794814/[《深入理解分布式系统》]
* https://raft.github.io/
* https://zhuanlan.zhihu.com/p/32052223
