= Jenkins 构建 deb 包
notfound <notfound@notfound.cn>
1.0, 2024-07-08: init

:page-slug: deb-jenkins
:page-category: deb
:page-tags: deb,jenkins,linux
:page-draft: false

Jenkins 构建 deb 包。

系统环境：Debian 12。

WARNING: Ubuntu 22.04 的组件 `dput` 和 `sbuild` 版本过低，存在缺陷。

== 概览

Jenkins 构建 deb 大致流程，只涉及需要配置的服务或者程序：

.Jenkins 构建 deb 概览
[source,plantuml]
----
@startuml
box "jenkins.notfound.cn\n(构建 deb 包)" #LightBlue
    participant jenkins
    participant sbuild
    participant apt
    participant dput
    participant curl
end box

box "packages.notfound.cn\n(apt 管理 deb 包)" #LightGreen
    participant "WebDAV\n(nginx)" as dav
    participant "CGI\n(nginx)" as cgi
    participant reprepro
end box

box "proxy.notfound.cn\n(apt 缓存 deb)"
    participant "squid-deb-proxy" as proxy
end box

activate jenkins

jenkins  -> sbuild : 打包 deb
activate sbuild
sbuild   -> apt    : 下载依赖
activate apt
apt      -> proxy  : 使用缓存加速依赖下载
activate proxy
apt     <-- proxy
deactivate proxy
sbuild  <-- apt
deactivate apt
jenkins <-- sbuild
deactivate sbuild

jenkins  -> dput   : 上传 deb
activate dput
dput     -> dav    : http(s) 协议上传
activate dav
dput    <-- dav
deactivate dav
jenkins <-- dput
deactivate dput

jenkins  -> curl        : 添加 deb 到 apt 源
activate curl
curl     -> cgi         : CGI 执行 shell
activate cgi
cgi      -> reprepro    : 添加 apt 数据
activate reprepro
cgi     <-- reprepro
deactivate reprepro
curl    <-- cgi
deactivate cgi
jenkins <-- curl
deactivate curl

deactivate jenkins
@enduml
----

== APT 缓存

参考 link:/posts/deb-squid-deb-proxy/[squid-deb-proxy 缓存 apt 数据]。

== APT 包管理

参考 link:/posts/deb-reprepro/[使用 reprepro 制作 apt 源]。

== Jenkins

参考 link:/posts/jenkins-install/[搭建 Jenkins]。

=== Jenkis 节点

* 如果需要虚拟机，参考 link:/posts/qemu-install/[Linux 安装 QEMU-KVM]；
* 参考 link:/posts/jenkins-node/[添加 Jenkins 节点]。

==== 配置节点

1. 安装基础工具：
+
[source,bash]
----
sudo apt install curl expect gnupg
----
+
2. 配置 sbuild 环境，参考：link:/posts/deb-sbuild/[sbuild 构建 deb 包]
+
3. 配置 dput，参考：link:/posts/deb-reprepro/#_dput[dput 章节]

=== Jenkins 相关脚本

==== dput

处理密码输入：

..jenkins/dput.exp
[source,bash]
----
#!/usr/bin/expect -f
# vim: set tabstop=4 shiftwidth=4 expandtab

# dput.exp [password] [host] <package(s).changes>
set password    [lindex $argv 0]
set host        [lindex $argv 1]
set changes     [lrange $argv 2 end]

foreach change $changes {
    spawn dput -f $host $change
    expect "Password for *:"
    send "$password\r"
    expect eof
}
----

===== sbuild

处理构建：

..jenkins/sbuild.sh
[source,bash]
----
#!/bin/sh

architecture=$1
distribution=$2

case "$architecture" in
    arm64|amd64)
        ;;
    *)
        echo "invalid architecture: $architecture"
        ;;
esac

case "$distribution" in
    bookworm|bullseye)
        ;;
    jammy|focal)
        ;;
    *)
        echo "invalid distribution: $distribution"
        ;;
esac

sbuild --arch="$architecture" --dist="$distribution" --append-to-version="+$distribution"
----
